/*1297896773,176832695*/

if (window.CavalryLogger) { CavalryLogger.start_js(["8M9A4"]); }

function ChatTabActions(a){this._container=a;this._actions={};this._actionOrder=[];this._visibilityChanged=false;this._anyVisible=false;this.actionClass='action';}copy_properties(ChatTabActions.prototype,{anyVisible:function(){return this._anyVisible;},appendAction:function(c,b,a){this._addAction(c,b,a);this._actionOrder.push(c);return this;},prependAction:function(c,b,a){this._addAction(c,b,a);this._actionOrder.unshift(c);return this;},removeAction:function(a){delete this._actions[a];return this;},setVisible:function(b,c){var a=this._actions[b];if(a&&a.visible!=c){a.visible=c;this._visibilityChanged=true;}return this;},refresh:function(){if(this._visibilityChanged){this._render();this._visibilityChanged=false;return true;}return false;},_render:function(){DOM.empty(this._container);var c=this._actions;var b=this._actionOrder;this._anyVisible=false;var d=[];for(var e=0;e<b.length;++e){var a=c[b[e]];if(a.visible){if(this._anyVisible)d.push($N('span',{className:'divider'},HTML(' &middot; ')));d.push(a.create_element());this._anyVisible=true;}}DOM.appendContent(this._container,d);this._container.style.display=this._anyVisible?'block':'none';},_addAction:function(c,b,a){if(typeof b=='string'){var d=b;b=function(){return $N('a',{className:this.actionClass,href:'#'},d);}.bind(this);}this._actions[c]={create_element:function(){var e=b();Event.listen(e,'click',a);return e;},visible:false};this._visibilityChanged=true;}});
var ChatUserInfoManager={get:function(b,a){if(ChatUserInfos[b]){a(ChatUserInfos[b]);}else{if(!this._callbacks[b]){this._callbacks[b]=[];this._toFetch.push(b);this._checkFetch();}this._callbacks[b].push(a);}},_callbacks:{},_toFetch:[],_fetchInProgress:false,_checkFetch:function(){if(!this._toFetch.length||this._fetchInProgress)return;this._fetchInProgress=true;this._doFetch.bind(this).defer();},_doFetch:function(){var a=this._toFetch;this._toFetch=[];new AsyncRequest().setHandler(this._onUserInfoResponse.bind(this)).setErrorHandler(this._onUserInfoError.bind(this)).setData({ids:a}).setURI(this.userInfoUrl).setAllowCrossPageTransition(true).setMethod("GET").setReadOnly(true).send();},_onUserInfoResponse:function(e){for(var d in e.payload){var f=e.payload[d];f.type='friend';ChatUserInfos[d]=f;var a=this._callbacks[d];delete this._callbacks[d];for(var c=0;c<a.length;c++)try{a[c](f);}catch(b){}}this._finishedFetch();},_onUserInfoError:function(){this._finishedFetch();},_finishedFetch:function(){this._fetchInProgress=false;this._checkFetch();},userInfoUrl:'/ajax/chat/user_info.php'};
var Dock=copy_properties(new Arbiter(),{MIN_HEIGHT:140,INITIAL_FLYOUT_HEIGHT_OFFSET:10,stateItems:[],init:function(a){this.init=bagofholding;this.rootEl=a;this.calculateViewportDimensions();this.calculateFlyoutHeightOffset();Event.listen(a,'click',this._onClick.bind(this));Event.listen(window,'resize',this._onWindowResize.bind(this));Arbiter.subscribe('page_transition',this._onPageTransition.bind(this));Toggler.subscribe(['show','hide'],function(d,c){var b=c.getActive();if(DOM.contains(a,b)&&CSS.hasClass(b,'fbNub')){if(d==='show')this._resizeNubFlyout(b);this.notifyNub(b,d);}}.bind(this));this._adjustTooltips();this.registerStateItems();this.inform('init',{},Arbiter.BEHAVIOR_PERSISTENT);},calculateViewportDimensions:function(){return (this.viewportDimensions=Vector2.getViewportDimensions());},calculateFlyoutHeightOffset:function(){this.flyoutHeightOffset=this.INITIAL_FLYOUT_HEIGHT_OFFSET+Vector2.getElementDimensions(this.rootEl).y;var a=ge('pageHead');if(a)this.flyoutHeightOffset+=Vector2.getElementPosition(a).y+Vector2.getElementDimensions(a).y;},toggle:function(b){var a=this._findFlyout(b);if(!a)return;this.subscribe('init',function(){Toggler.getInstance(b).toggle(b);});},show:function(a){this.subscribe('init',function(){Toggler.getInstance(a).show(a);});},showNub:function(b){CSS.show(b);var a=DOM.find(b,'a.fbNubButton');this._adjustTooltip(a);},hide:function(a){this.subscribe('init',function(){var b=Toggler.getInstance(a);DOM.contains(a,b.getActive())&&b.hide();});},hideNub:function(a){CSS.hide(a);this.hide(a);},_resizeNubFlyout:function(l,j){var g=this._findFlyout(l);if(!g||!CSS.hasClass(l,'openToggler'))return;var c=DOM.find(g,'div.fbNubFlyoutBody'),e=DOM.find(c,'div.fbNubFlyoutBodyContent'),d=Vector2.getElementDimensions(e),h=DataStore.get(g,'dock:nub:flyout:padding'),f=Vector2.getElementDimensions(g);var k=DataStore.get(g,'dock:nub:flyout:height');if(j||!h){var b=Vector2.getElementDimensions(c);h=f.y-b.y;DataStore.set(g,'dock:nub:flyout:padding',h);}var a=Math.max(this.MIN_HEIGHT-h,this.viewportDimensions.y-h-this.flyoutHeightOffset);if(k)a=Math.min(a,k-h);if(k||d.y>a){c.style.height=a+'px';}else c.style.height='auto';CSS.removeClass(g,'swapDirection');var i=Vector2.getElementPosition(g).x;CSS.conditionClass(g,'swapDirection',function(){if(i<0)return true;return (i+f.x>this.viewportDimensions.x);}.bind(this)());this.notifyNub(l,'resize');},resizeAllFlyouts:function(){var b=DOM.scry(this.rootEl,'div.fbNub.openToggler'),a=b.length;while(a--)this._resizeNubFlyout(b[a]);},_onClick:function(event){var c=event.getTarget(),b=Parent.byClass(c,'fbNub');if(b){if(Parent.byClass(c,'fbNubFlyoutTitlebar')){var a=Parent.byTag(c,'a');if(!a||!a.rel){this.hide(b);return false;}}this.notifyNub(b,'click');}},_onPageTransition:function(){this._flushDockState();},_onWindowResize:function(event){this.calculateViewportDimensions();this.resizeAllFlyouts();this._adjustTooltips();},_adjustTooltip:function(a){var b=DOM.scry(a,'span.uiTooltipWrap')[0];if(b){var c=Vector2.getElementPosition(a).x;if(c){if(this._isRTL())c=this.viewportDimensions.x-c;CSS.conditionClass(b,'right',c>this.viewportDimensions.x/2);}}},_adjustTooltips:function(){var a=DOM.scry(this.rootEl,'a.fbNubButton.uiTooltip');a.each(this._adjustTooltip.bind(this));},_findFlyout:function(a){return (flyoutEl=CSS.hasClass(a,'fbNubFlyout')?a:DOM.scry(a,'div.fbNubFlyout')[0]||null);},setFlyoutContentHeight:function(a,b){a=this._findFlyout(a);if(!a)return;DataStore.set(a,'dock:nub:flyout:height',b);},registerNubController:function(b,a){DataStore.set(b,'dock:nub:controller',a);a.subscribe(a.FLYOUT_CONTENT_CHANGED,this._resizeNubFlyout.bind(this,b,true));},unregisterNubController:function(a){DataStore.remove(a,'dock:nub:controller');},notifyNub:function(c,d,b){var a=DataStore.get(c,'dock:nub:controller');return a&&a.inform(d,b)!==false;},_getNubContainer:function(a,b){var c=DOM.scry(this.rootEl,'div.fbDock .'+a)[0];if(!c&&b)c=DOM[a==='lNubContainer'?'prependContent':'appendContent'](this.rootEl.firstChild,HTML('<div class="'+a+'"></div>'))[0];return c||null;},_getLeftNubContainer:function(a){return (this.leftNubContainer=this.leftNubContainer||this._getNubContainer('lNubContainer',a));},_getRightNubContainer:function(a){return (this.rightNubContainer=this.rightNubContainer||this._getNubContainer('rNubContainer',a));},registerStateItem:function(d,e,f){var c=e==='left'?this._getLeftNubContainer(true):this._getRightNubContainer(true);if(!c.firstChild){var a=e==='left'?'fbDockWrapperRight':'fbDockWrapperLeft';CSS.removeClass(this.rootEl,a);}var b=f?'lastChild':'firstChild';while(d[b]){this.stateItems.push(d[b]);DOM[f?'prependContent':'appendContent'](c,d[b]);}DOM.remove(d);this._adjustTooltips();},registerStateItems:function(){this.subscribe('init',function(){var a=window.DockStateItems;while(a&&a.length)this.registerStateItem.apply(this,a.shift());}.bind(this));},_flushDockState:function(){this.stateItems.each(DOM.remove);this.stateItems=[];var a=this._getLeftNubContainer();if(a&&!a.firstChild)CSS.addClass(this.rootEl,'fbDockWrapperRight');var b=this._getRightNubContainer();if(b&&!b.firstChild)CSS.addClass(this.rootEl,'fbDockWrapperLeft');},_isRTL:function(){if(typeof this._rtl==='undefined')this._rtl=intl_locale_is_rtl();return this._rtl;}});
function NubController(){}NubController.mixin('Arbiter',{FLYOUT_CONTENT_CHANGED:'nub/flyout/content-changed',init:function(a){this.el=a;Dock.registerNubController(a,this);},flyoutContentChanged:function(){this.inform(this.FLYOUT_CONTENT_CHANGED);},hide:function(){Dock.hide(this.el);},show:function(){Dock.show(this.el);}});
var Emote={_initialized:false,_imageBase:null,_emoteMap:null,_emoteOrderMap:null,_imageURLs:null,_regex:null,_mapOverlay:null,initExtraEmoticons:function(a){Emote._mapOverlay=a;},_init:function(){var f=env_get('static_base');Emote._imageBase=f+'images/emote/';Emote._blankImgSrc=f+'images/blank.gif';var a=['smile','frown','tongue','grin','gasp','wink','glasses','sunglasses','grumpy','unsure','cry','devil','angel','kiss','heart','kiki','squint','confused','upset','pacman','colonthree'];Emote._emoteMap={':-)':['\\:\\-\\)','smile'],':)':['\\:\\)','smile'],':]':['\\:\\]','smile'],'=)':['=\\)','smile'],':-(':['\\:\\-\\(','frown'],':(':['\\:\\(','frown'],':[':['\\:\\[','frown'],'=(':['=\\(','frown'],':-P':['\\:\\-P','tongue'],':P':['\\:P','tongue'],':-p':['\\:\\-p','tongue'],':p':['\\:p','tongue'],'=P':['=P','tongue'],':-D':['\\:\\-D','grin'],':D':['\\:D','grin'],'=D':['=D','grin'],':-O':['\\:\\-O','gasp'],':O':['\\:O','gasp'],':-o':['\\:\\-o','gasp'],':o':['\\:o','gasp'],';-)':['\\;\\-\\)','wink'],';)':['\\;\\)','wink'],'8-)':['8\\-\\)','glasses'],'8)':['8\\)','glasses'],'B-)':['B\\-\\)','glasses'],'B)':['B\\)','glasses'],'8-|':['8\\-\\|','sunglasses'],'8|':['8\\|','sunglasses'],'B-|':['B\\-\\|','sunglasses'],'B|':['B\\|','sunglasses'],'>:(':['>\\:\\(','grumpy'],'>:-(':['>\\:\\-\\(','grumpy'],':/':['\\:/','unsure'],':-/':['\\:\\-/','unsure'],':\\':['\\:\\\\','unsure'],':-\\':['\\:\\-\\\\','unsure'],":'(":["\\:'\\(",'cry'],'3:)':['3\\:\\)','devil'],'3:-)':['3\\:\\-\\)','devil'],'O:)':['O\\:\\)','angel'],'O:-)':['O\\:\\-\\)','angel'],':-*':['\\:\\-\\*','kiss'],':*':['\\:\\*','kiss'],'<3':['<3','heart'],'&lt;3':['&lt\\;3','heart'],'\u2665':['\u2665','heart'],'^_^':['\\^_\\^','kiki'],'-_-':['\\-_\\-','squint'],'o.O':['o\\.O','confused'],'O.o':['O\\.o','confused'],'>:O':['>\\:O','upset'],'>:-O':['>\\:\\-O','upset'],'>:o':['>\\:o','upset'],'>:-o':['>\\:\\-o','upset'],':v':['\\:v','pacman'],':|]':['\\:\\|\\]','robot'],':3':['\\:3','colonthree'],'<(")':['<\\(\\"\\)','penguin'],':putnam:':['\\:putnam\\:','putnam'],'(^^^)':['\\(\\^\\^\\^\\)','shark'],':42:':['\\:42\\:','42']};if(Emote._mapOverlay)copy_properties(Emote._emoteMap,Emote._mapOverlay);var d=[];for(var c in Emote._emoteMap)d.push(Emote._emoteMap[c][0]);var e='(?:^|\\s|\'|"|\\.)('+d.join('|')+')(?:\\s|\'|"|\\.|,|!|\\?|<br>|$)';Emote._regex=new RegExp(e);Emote._emoteOrderMap={};for(var b=0;b<a.length;b++)Emote._emoteOrderMap[a[b]]=b;Emote._initialized=true;},htmlEmote:function(j,l){if(typeof l!='function')l=htmlize;if(!Emote._initialized)Emote._init();var i=0;var k=j;var h=[];while(true){var e=Emote._regex.exec(k);if(!e||!e.length)break;var b=e[1];var d=Emote._emoteMap[b][1];var c=k.indexOf(b);var a=k.substring(0,c);if(a)h.push(l(a));h.push('<span class="emote_text">');h.push(b);h.push('</span><img ');var f;if(typeof(f=Emote._emoteOrderMap[d])=='undefined'){h.push('class="emote_custom" src="');h.push(Emote._imageBase);h.push(d);h.push('.gif" ');}else{var g=f*-16;h.push('class="emote_img" src="');h.push(Emote._blankImgSrc);h.push('" style="background-position: ');h.push(g);h.push('px 0px" ');}h.push('alt="');h.push(b);h.push('" />');k=k.substring(c+b.length);}if(k)h.push(l(k));return h.join('');}};
var Sound=(function(){var a=false;var b='so_sound_player';return {init:function(){if(a)return;a=true;var c=document.createElement('div');c.id='sound_player_holder';document.body.appendChild(c);try{var player=new SWFObject('/swf/SoundPlayerHater.swf',b,'1px','1px',['9.0.159.0','10.0.22.87'],'#ffffff');player.addParam('allowscriptaccess','always');player.addParam('wmode','transparent');player.addVariable('swf_id',b);player.fallback_html=' ';player.write(c.id);window[b]=player;}catch(d){}},play:function(d,f){Sound.init();var g=URI(d);if(!g.getDomain())d=URI(env_get('static_base')).setPath(g.getPath()).toString();var e=document[b]||window[b];var c;if(/\.mp3$/.test(d))if(e){if(!e.playSound&&e.length)e=e[0];if(e.playSound){e.playSound(d,!!f);return;}}c=ge('sound');if(!c){c=document.createElement('span');c.setAttribute('id','sound');DOM.getRootElement().appendChild(c);}c.innerHTML='<embed src="'+d+'" autostart="true" loop="false" '+'hidden="true" />';}};})();
UserActivity=window.UserActivity||{SIGNAL:'useractivity/activity',_lastActive:0,_listeners:null,DEFAULT_IDLE_MS:5000,EVENT_INTERVAL_MS:500,onActivity:function(event){UserActivity._listeners.forEach(function(a){a.remove();});UserActivity._listeners=null;UserActivity._lastActive=+new Date();setTimeout(UserActivity.listen,UserActivity.EVENT_INTERVAL_MS);Arbiter.inform(UserActivity.SIGNAL,event);},listen:function(){if(UserActivity._listeners)return;UserActivity._listeners=[Event.listen(document.body,'mouseover',UserActivity.onActivity),Event.listen(document.body,'keydown',UserActivity.onActivity),Event.listen(document.body,'click',UserActivity.onActivity)];},subscribe:function(a){UserActivity.listen();return Arbiter.subscribe(UserActivity.SIGNAL,a,Arbiter.SUBSCRIBE_NEW);},unsubscribe:function(a){Arbiter.unsubscribe(a);},isActive:function(a){return UserActivity._lastActive&&(new Date()-UserActivity._lastActive<(a||UserActivity.DEFAULT_IDLE_MS));}};onloadRegister(UserActivity.listen);
function ChatBuddyListTypeahead(e,d,c,b,a){this.inDock=!presence.inPopoutWindow;this.curStr='';this.clearDiv=null;this.focused=false;this.selected=null;this.selectedIndex=0;this.selectableCount=0;this.buddyList=a;this.minBuddyCount=this.buddyList.flMode?20:10;this.flid=c;this.excludedIds=b;this.id=ChatBuddyListTypeahead.numTypeaheads++;if(this.inDock){this.obj=DOM.find(e,'input');d=e;}else{this.obj=e;this.obj.typeahead=this;}this.placeholderText=this.obj.value;this.inputDiv=d;Event.listen(this.obj,'keyup',this._onkeyup.bind(this));this.buildIndex();Arbiter.subscribe(ChatBuddyList.AVAILABILITY_CHANGED,this.buildIndex.bind(this));}ChatBuddyListTypeahead.numTypeaheads=0;ChatBuddyListTypeahead.mixin('Arbiter',{buildIndex:function(){this.availableListIDs=this.buddyList.getSortedListUI(this.flid);this.firstLetterIndex={};for(var a=0;a<this.availableListIDs.length;a++){var b=this.availableListIDs[a];var c=typeahead_source.tokenize(ChatUserInfos[b].name);for(var d=0;d<c.length;d++){if(!this.firstLetterIndex[c[d][0]])this.firstLetterIndex[c[d][0]]={};this.firstLetterIndex[c[d][0]][b]=true;}}this._refreshAvailableList();if(this.buddyList.getAvailableCount()<this.minBuddyCount){CSS.hide(this.inputDiv);this.resetSearch(true);}else{CSS.show(this.inputDiv);this.search.bind(this,true).defer();}},_getAvailableListIDs:function(){if(!this.availableIDs)this._refreshAvailableList();return this.availableIDs;},_refreshAvailableList:function(){var a=this.availableListIDs;if(this.excludedIds)a=a.filter((function(b){return this.excludedIds[b]!=1;}).bind(this));this.availableIDs=a;},_onkeyup:function(event){switch(Event.getKeyCode(event)){case KEYS.ESC:if(this.curStr!==''){this.resetSearch(true);return false;}break;case undefined:case KEYS.LEFT:case KEYS.RIGHT:return false;break;case KEYS.UP:this.upArrowPress();break;case KEYS.DOWN:this.downArrowPress();break;case KEYS.RETURN:this.select();break;case KEYS.BACKSPACE:case 0:default:if(this.search())this.resetSearch(true);break;}},focusInput:function(){if(this.buddyList.getAvailableCount()&&this.buddyList.getAvailableCount()>this.minBuddyCount)this.obj.focus();this.resetSearch();},resetSearch:function(a){if(!this.obj)return false;if(!this.obj.value||a){this.curStr='';this.obj.value='';}this.selected=null;this.selectedIndex=-1;this.showAll();this.hideClear();this.inform('reset');},search:function(a){var e=this.obj.value;if(e==this.placeholderText)return true;var c=typeahead_source.flatten_string(e);if(!a&&c==this.curStr)return false;this.curStr=c;var d=typeahead_source.tokenize(c).sort(typeahead_source._sort);if(!d[0])return true;var b=this.firstLetterIndex[d[0][0]];this.showClear();this.buddyList.suppressNonFriendInfoInBuddyList(this.flid);this.getMatchingFriends(b,d);this.selected=null;this.selectMatchingFriends();this.inform('search',c);return false;},getMatchingFriends:function(h,i){var f=0;var b;var a=this._getAvailableListIDs();for(var d=0;d<a.length;d++){var e=a[d];var c=ChatUserInfos[e].name;if(h!=undefined&&h[e]&&typeahead_source.check_match(i,c)){var g=typeahead_source.highlight_found(c,this.curStr);DOM.setContent(this.buddyList.getBuddyItemName(e,this.flid),HTML(g));this.buddyList.showBuddyItem(e,false,this.flid);f++;if(!b)b=e;}else{CSS.removeClass(this.buddyList.getBuddyItem(e,this.flid),'selected');this.buddyList.hideBuddy(e,this.flid);}}if(f>0){this.buddyList.hideEmptySearch(this.flid);if(f==1||(i.length==1&&i[0].length==1)){this.selected=b;this.selectedIndex=0;CSS.addClass(this.buddyList.getBuddyItem(b,this.flid),'selected');}}else this.buddyList.showEmptySearch(this.flid);},selectMatchingFriends:function(){this.selectableCount=0;var a=this._getAvailableListIDs();for(var c=0;c<a.length;c++){var d=a[c];var b=this.buddyList.getBuddyItem(d,this.flid);if(b&&CSS.getStyle(b,'display')!='none'){if(this.selectedIndex==this.selectableCount){this.selected=d;CSS.addClass(b,'selected');Vector2.scrollIntoView(b);}else CSS.removeClass(b,'selected');this.selectableCount++;}}},downArrowPress:function(){this.selectedIndex++;var a=this.selectableCount-1;if(this.selectedIndex>a)this.resetSearch();this.selectMatchingFriends();},upArrowPress:function(){this.selectedIndex--;if(this.selectedIndex<0)this.selectedIndex=0;this.selectMatchingFriends();},showAll:function(){this.obj.value='';this.buddyList.hideEmptySearch(this.flid);var a=this._getAvailableListIDs();for(var c=0;c<a.length;c++){var d=a[c];var b=this.buddyList.getBuddyItem(d,this.flid);if(b){this.buddyList.updateBuddyItemName(d,this.flid);CSS.removeClass(this.buddyList.getBuddyItem(d,this.flid),'selected');this.buddyList.showBuddyItem(d,true,this.flid);}}this.buddyList.unsuppressNonFriendInfoInBuddyList(this.flid);},showClear:function(){if(!this.clearDiv){this.clearDiv=DOM.find(this.inputDiv,'.clear_input');Event.listen(this.clearDiv,'click',this.resetSearch.bind(this,true));}CSS.show(this.clearDiv);},hideClear:function(){if(this.clearDiv)CSS.hide(this.clearDiv);},select:function(){if(this.selected!=null){CSS.removeClass(this.buddyList.getBuddyItemName(this.selected,this.flid),'selected');this.buddyList.itemOnClick(this.buddyList.getBuddyItem(this.selected));this.resetSearch(true);}}});
function Collection(e,d){if(!e.__collection__){var a=new Function();for(var c in e.prototype)a.prototype[c]=Collection._call.bind(null,c);e.__collection__=a;}var b=new e.__collection__();b._elements=d;return b;}Collection._call=function(b){var a=Array.prototype.slice.call(arguments,1);this._elements.each(function(c){c[b].apply(c,a);});return this;};
function Rect(e,d,a,c,b){if(this===window){if(e instanceof Rect)return e;if(e instanceof Vector2)return new Rect(e.y,e.x,e.y,e.x,e.domain);return Rect.getElementBounds($(e));}copy_properties(this,{t:e,r:d,b:a,l:c,domain:b||'pure'});}copy_properties(Rect.prototype,{w:function(){return this.r-this.l;},h:function(){return this.b-this.t;},toString:function(){return '(('+this.l+', '+this.t+'), ('+this.r+', '+this.b+'))';},contains:function(b){b=Rect(b).convertTo(this.domain);var a=this;return (a.l<=b.l&&a.r>=b.r&&a.t<=b.t&&a.b>=b.b);},add:function(c,d){if(arguments.length==1){if(c.domain!='pure')c=c.convertTo(this.domain);return this.add(c.x,c.y);}var a=parseFloat(c);var b=parseFloat(d);return new Rect(this.t+b,this.r+a,this.b+b,this.l+a,this.domain);},sub:function(a,b){if(arguments.length==1){return this.add(a.mul(-1));}else return this.add(-a,-b);},boundWithin:function(a){var b=0,c=0;if(this.l<a.l){b=a.l-this.l;}else if(this.r>a.r)b=a.r-this.r;if(this.t<a.t){c=a.t-this.t;}else if(this.b>a.b)c=a.b-this.b;return this.add(b,c);},getPositionVector:function(){return new Vector2(this.l,this.t,this.domain);},getDimensionVector:function(){return new Vector2(this.w(),this.h(),'pure');},convertTo:function(a){if(this.domain==a)return this;if(a=='pure')return new Rect(this.t,this.r,this.b,this.l,'pure');if(this.domain=='pure')return new Rect(0,0,0,0);var b=new Vector2(this.l,this.t,this.domain).convertTo(a);return new Rect(b.y,b.x+this.w(),b.y+this.h(),b.x,a);}});copy_properties(Rect,{newFromVectors:function(b,a){return new Rect(b.y,b.x+a.x,b.y+a.y,b.x,b.domain);},getElementBounds:function(a){return Rect.newFromVectors(Vector2.getElementPosition(a),Vector2.getElementDimensions(a));},getViewportBounds:function(){return Rect.newFromVectors(Vector2.getScrollPosition(),Vector2.getViewportDimensions());}});
function Scroller(a){this.canvas=a;this.scrollZone=50;this.velocity=100;this.coefficient=1;}Scroller.findScrollParent=function(a){var b;a=a.parentNode;while(a){if(a.scrollHeight!=a.offsetTop){b=CSS.getStyle(a,'overflowY');if(b=='scroll'||b=='auto')return a;}a=a.parentNode;}return document.body;};Scroller.prototype.activate=function(){this.activate=bagofholding;this.event=Event.listen(document,'mousemove',this._onmousemove.bind(this));this.interval=this._intervalHandler.bind(this).recur(50);this.cursor=null;};Scroller.prototype.deactivate=function(){delete this.activate;this.event&&this.event.remove();this.event=null;clearInterval(this.interval);};Scroller.prototype._onmousemove=function(event){this.cursor=new Vector2.getEventPosition(event);};Scroller.prototype._intervalHandler=function(){if(!this.cursor)return;var c=this.canvas==document.body?Rect.getViewportBounds():Rect(this.canvas);var a=new Rect(this.cursor.y-c.t,c.r-this.cursor.x,c.b-this.cursor.y,this.cursor.x-c.l);var b=new Vector2(0,0);if(a.t<a.b&&a.t<this.scrollZone){b.y=-this.scrollZone+a.t;}else if(a.b<this.scrollZone)b.y=this.scrollZone-a.b;b.y=this._doMath(b.y);if(a.l<a.r&&a.l<this.scrollZone){b.x=-this.scrollZone+a.l;}else if(a.r<this.scrollZone)b.x=this.scrollZone-a.r;b.x=this._doMath(b.x);if(b.x||b.y){b.scrollElementBy(this.canvas);if(document.body==this.canvas)this.cursor=this.cursor.add(b);Arbiter.inform('scroller/scroll',this.cursor);}};Scroller.prototype._doMath=function(a){return Math.floor(Math.pow((a>=0?Math.min(a,this.scrollZone):Math.max(a,-this.scrollZone))/this.scrollZone*this.velocity,this.coefficient));};
var Drag={};Drag.currentDraggable=null;Drag.grab=function(a){if(Drag.currentDraggable)Drag._onmouseup();a.lastDragOver=null;Drag.attachDragEvents();Drag.currentDraggable=a;};Drag.attachDragEvents=function(){document.onselectstart=function(){document.onselectstart=null;return false;};if(Drag.dragEventsAttached)return;Drag.dragEventsAttached=true;Arbiter.subscribe('scroller/scroll',Drag._onmousemove);Event.listen(document,{mousemove:Drag._onmousemove,mouseup:Drag._onmouseup});};Drag.droppables={};Drag.addDroppable=function(b,a){(Drag.droppables[b]=Drag.droppables[b]||[]).push(a);};Drag.removeDroppable=function(b,a){Drag.droppables[b]=Drag.droppables[b].filter(function(c){return c!=a;});};Drag._onmousemove=function(event,c){if(!Drag.currentDraggable)return;var d=c||Vector2.getEventPosition(event),b=Drag.currentDraggable,e=Drag.droppables[b.namespace];if(b.namespace&&b.active&&e){var j={};e.each(function(k){j[k.zIndex]=k.zIndex;});var i=[];for(var f in j)i.push(j[f]);i.sort();var g=b.lastDragOver,a=null;for(var h=i.length-1;h>=0;h--)if(g&&g.dom!=null&&g.zIndex==i[h]&&g.pointInside(d)){a=g;break;}else for(var f=0;f<e.length;f++){if(i[h]!=e[f].zIndex)continue;if(g!=e[f]&&b.dom!=e[f].dom&&e[f].pointInside(d)){a=e[f];h=-1;break;}}if(a&&a!=g){a.ondragover(b);Drag.currentDraggable.adjustCursorPosition();}if(a)a.ondragmove(b,d.sub(Vector2.getElementPosition(a.dom)));b.lastDragOver=a;}Drag.currentDraggable._onmousemove(d);};Drag._onmouseup=function(a){document.onselectstart=null;if(Drag.currentDraggable){Drag.currentDraggable._ondrop();Drag.currentDraggable=null;}};function Draggable(b){if(!b)throw new Error('Element should be a DOM node');if(this==window){if(b instanceof Array){var a=[];b.each(function(c){a.push(new Draggable(c));});return new Collection(Draggable,a);}else return new Draggable(b);}else{this.data={};this.handles=[];this.dom=b;this.boundingBox=null;this.useScroller=true;this.grabPctX=this.grabPctY=0;this.addHandle(this.dom);}}Draggable.prototype.destroy=function(){this.handles.each(function(a){this.removeHandle(a.obj);}.bind(this));this.data=this.dom=null;};Draggable.prototype.adjustCursorPosition=function(){var a=Vector2.getElementDimensions(this.dom);this.cursorPositionVector=new Vector2(parseInt(this.grabPctX*a.x,10),parseInt(this.grabPctY*a.y,10));};Draggable.prototype._onclick=function(event){if(this.active)return Event.kill(event);};Draggable.prototype._ongrab=function(a){this.ongrab();if(this.useScroller){if(!this.scroller)this.scroller=new Scroller(Scroller.findScrollParent(this.dom));this.scroller.activate();}if(this.active){if(!this.oldPosition)this.oldPosition=this.dom.style.position;this.dom.style.position=this.absolute?'absolute':'relative';a.sub(this.cursorPositionVector).setElementPosition(this.dom);}};Draggable.prototype._onmousedown=function(event){var b=$E(event).getTarget();if(DOM.isNode(b,['input','select','textarea','object','embed']))return true;var c=Vector2.getEventPosition(event),a=Vector2.getElementDimensions(this.dom);this.draggableInitialVector=Vector2.getElementPosition(this.dom);this.cursorPositionVector=c.sub(this.draggableInitialVector);this.grabPctX=a.x===0?0:this.cursorPositionVector.x/a.x;this.grabPctY=a.y===0?0:this.cursorPositionVector.y/a.y;Drag.grab(this,event);if(this.gutter){this.cursorInitialVector=c;}else{this._setActive(true);this._ongrab(c);}return Event.kill(event);};Draggable.prototype._onmousemove=function(d){if(!this.active)if(d.distanceTo(this.cursorInitialVector)>=this.gutter){this._setActive(true);this._ongrab(d);}if(this.active){var c=Vector2.getElementPosition(this.dom).sub(new Vector2(parseInt(this.dom.style.left?this.dom.style.left:CSS.getStyle(this.dom,'left'),10)||0,parseInt(this.dom.style.top?this.dom.style.top:CSS.getStyle(this.dom,'top'),10)||0));var e=d.sub(c).sub(this.cursorPositionVector);if(this.boundingBox){var a=Rect.newFromVectors(e,Vector2.getElementDimensions(this.dom));a=a.boundWithin(this.boundingBox);e=a.getPositionVector(a);if(this.boundingBox.w()==0){var b=new Vector2(this.draggableInitialVector.x,e.y,'document');}else if(this.boundingBox.h()==0){var b=new Vector2(e.x,this.draggableInitialVector.y,'document');}else var b=e;}else var b=e;b.setElementPosition(this.dom);this.ondrag(d);}};Draggable.prototype._ondrop=function(){this.scroller&&this.scroller.deactivate();if(this.active){(function(){this._setActive(false);}).bind(this).defer();this.ondrop();if(this.lastDragOver)this.lastDragOver.ondrop(this);}};Draggable.prototype.killDrag=function(){this._setActive(false);Drag._onmouseup();};Draggable.prototype.setBoundingBox=function(a){this.boundingBox=a;return this;};Draggable.prototype.resetPosition=function(){this.dom.style.position=this.oldPosition;this.oldPosition=null;this.dom.style.left='';this.dom.style.top='';return this;};Draggable.prototype.setUseAbsolute=function(a){this.absolute=a;return this;};Draggable.prototype.ondrag=bagofholding;Draggable.prototype.setDragHandler=function(a){this.ondrag=a;return this;};Draggable.prototype.ongrab=bagofholding;Draggable.prototype.setGrabHandler=function(a){this.ongrab=a;return this;};Draggable.prototype.ondrop=bagofholding;Draggable.prototype.setDropHandler=function(a){this.ondrop=a;return this;};Draggable.prototype.gutter=0;Draggable.prototype.setGutter=function(a){this.gutter=a;return this;};Draggable.prototype.setNamespace=function(a){this.namespace=a;return this;};Draggable.prototype.setUseScroller=function(a){this.useScroller=a;return this;};Draggable.prototype.handles=null;Draggable.prototype.addHandle=function(a){if(this.handles.length==1&&this.handles[0].obj==this.dom)this.removeHandle(this.dom);this.handles.push({obj:a,evt:[Event.listen(a,'mousedown',this._onmousedown.bind(this)),Event.listen(a,'click',this._onclick.bind(this)),Event.listen(a,'drag',Event.kill),Event.listen(a,'selectstart',Event.kill)]});return this;};Draggable.prototype.removeHandle=function(a){this.handles=this.handles.filter(function(b){if(b.obj!=a){return true;}else{b.evt.each(function(c){c.remove();});return false;}});};Draggable.prototype.getDOM=function(){return this.dom;};Draggable.prototype.setKey=function(a,b){this.data[a]=b;return this;};Draggable.prototype.getKey=function(a){return this.data[a];};Draggable.prototype._setActive=function(b){this.dom.activeDrag=this.active=b;for(var a=0;a<this.handles.length;a++)this.handles[a].obj.activeDrag=b;};function Droppable(b){if(!b)throw new Error('Element should be a DOM node');if(this==window){if(b instanceof Array){var a=[];b.each(function(c){a.push(new Droppable(c));});return new Collection(Droppable,a);}else return new Droppable(b);}else{this.data={};this.dom=b;this.namespace=null;}}Droppable.prototype.destroy=function(){if(this.namespace)Drag.removeDroppable(this.namespace,this);this.data=this.dom=null;};Droppable.prototype.setNamespace=function(a){if(this.namespace)Drag.removeDroppable(a,this);this.namespace=a;Drag.addDroppable(a,this);return this;};Droppable.prototype.zIndex=0;Droppable.prototype.setZIndex=function(a){this.zIndex=a;return this;};Droppable.prototype.pointInside=function(b){var a=Vector2.getElementPosition(this.dom);return a.x<=b.x&&this.dom.offsetWidth+a.x>b.x&&a.y<=b.y&&this.dom.offsetHeight+a.y>b.y;};Droppable.prototype.ondragover=bagofholding;Droppable.prototype.setDragOverHandler=function(a){this.ondragover=a;return this;};Droppable.prototype.ondragmove=bagofholding;Droppable.prototype.setDragMoveHandler=function(a){this.ondragmove=a;return this;};Droppable.prototype.ondrop=bagofholding;Droppable.prototype.setDropHandler=function(a){this.ondrop=a;return this;};Droppable.prototype.getDOM=Draggable.prototype.getDOM;Droppable.prototype.setKey=Draggable.prototype.setKey;Droppable.prototype.getKey=Draggable.prototype.getKey;
function SortableGroup(){this.namespace='sortable'+(++SortableGroup.instanceCount);this.draggables={};this.droppables={};this.sortables={};this.linkedGroups=[];this.linkedGroups.onbeforelinkjump=bagofholding;this.linkedGroups.onlinkjump=bagofholding;this.rootNode=null;this.boundingBox=null;this.neverEmpty=false;this.hasEmptyMessage=false;this.isDroppable=true;this.requireSameParent=true;this.anchor=null;this.disabled=false;}SortableGroup.instanceCount=0;SortableGroup.prototype={gutter:15,onbeforegrabcallback:bagofholding,onbeforedragover:bagofholding,ondragover:bagofholding,ondropcallback:bagofholding,ongrabcallback:bagofholding,onorderchange:bagofholding,addEmptyMessage:function(b,c){var a='placeholder';if(b.parentNode!=c)DOM.appendContent(c,b);this._initializeAdded(a,b);this.hasEmptyMessage=true;this.sortables[a]=b;this.droppables[a]=(new Droppable(b)).setNamespace(this.namespace).setDragOverHandler(this._dragOverHandlerShim.bind(this,a));return this;},addSortable:function(b,c,a){this._initializeAdded(b,c);this.sortables[b]=c;this.draggables[b]=(new Draggable(c)).setNamespace(this.namespace).setGutter(this.gutter).setUseAbsolute(true).setGrabHandler(this.grabHandler.bind(this,b)).setDropHandler(this.dropHandler.bind(this,b)).setKey('key',b).setBoundingBox(this.boundingBox);if(a)this.draggables[b].addHandle(a);this.droppables[b]=(new Droppable(c)).setNamespace(this.namespace).setDragOverHandler(this._dragOverHandlerShim.bind(this,b));return this;},destroy:function(){for(var c in this.droppables)this.droppables[c].destroy();for(var b in this.draggables)this.draggables[b].destroy();this.droppables=this.draggables=this.rootNode=null;this.linkedGroups.remove(this);for(var a=0;a<this.linkedGroups.length;a++)this.linkedGroups[a].linkedGroups=this.linkedGroups;},dragOverHandler:function(f,d){if(!this.isDroppable&&!this.anchor)return;var h=false;if(!(d in this.draggables)){this.linkedGroups.onbeforelinkjump.call(this,d);if(!this.migrateLinkedSortable(d))throw new Error('Draggable dropped onto a foreign droppable!');h=true;}var a=true,b=this.getSortables(),c=this.sortables[d],e=this.sortables[f];if(!this.anchor){var i=b.length;for(var g=0;g<i;g++)if(b[g]==e){break;}else if(b[g]==c){a=false;break;}}else e=this.anchor;this.onbeforedragover(c,e);var j=this.linkedGroups.placeholder;this.insertPlaceholder(j,e,a||this.anchor);j.parentNode.insertBefore(c,j);this.ondragover(c,e);if(h)this.linkedGroups.onlinkjump.call(this,d);},dropHandler:function(a){if(this._checkLastRemaining()){this.draggables[a].resetPosition();return;}var c=this.linkedGroups.placeholder;CSS.removeClass(this.sortables[a],'drag');this.draggables[a].resetPosition();c.parentNode.insertBefore(this.sortables[a],c);c.parentNode.removeChild(c);for(var b=0;b<this.linkedGroups.length;b++)if(this.linkedGroups[b].anchor)delete this.linkedGroups[b].anchor;this.ondropcallback(a,this.sortables[a]);this.onorderchange();},getOrder:function(){var d=[],a=this.getSortables();for(var b=0;b<a.length;b++)for(var c in this.sortables)if(this.sortables[c]==a[b]){d.push(c);break;}return d;},getSortables:function(){return this.rootNode?this.rootNode.childNodes:[];},grabHandler:function(a){if(this.disabled||this._checkLastRemaining()){this.draggables[a].killDrag();return;}this.onbeforegrabcallback(this.sortables[a],a);var b=this.linkedGroups.placeholder;var c=this.sortables[a];CSS.setClass(b,c.className);CSS.addClass(b,'droppable_placeholder');CSS.addClass(c,'drag');Vector2.getElementDimensions(c).setElementDimensions(b);c.parentNode.insertBefore(b,c);this.ongrabcallback(this.sortables[a],a);if(!this.isDroppable){this.anchor=c.nextSibling;if(!this.anchor){this.anchor=$N('div');c.parentNode.appendChild(this.anchor);}}},insertPlaceholder:function(b,c,a){if(a){DOM.insertBefore(b,c);}else DOM.insertAfter(c,b);},keyExists:function(a){return this.sortables[a];},link:function(d){d.linkedGroups=this.linkedGroups;if(!this.linkedGroups.length)this.linkedGroups.push(this);this.linkedGroups.push(d);for(var b=0;b<this.linkedGroups.length;b++)if(this.linkedGroups[b].namespace!=this.namespace){this.linkedGroups[b].namespace=this.namespace;for(var c in this.linkedGroups[b].droppables){this.linkedGroups[b].droppables[c].setNamespace(this.namespace);var a=this.linkedGroups[b].draggables[c];a&&a.setNamespace(this.namespace);}}return this;},migrateLinkedSortable:function(b){for(var a=0;a<this.linkedGroups.length;a++)if(b in this.linkedGroups[a].draggables){this.sortables[b]=this.linkedGroups[a].sortables[b];this.draggables[b]=this.linkedGroups[a].draggables[b];this.draggables[b].setGrabHandler(this.grabHandler.bind(this,b)).setDropHandler(this.dropHandler.bind(this,b));this.droppables[b]=this.linkedGroups[a].droppables[b];this.droppables[b].setDragOverHandler(this._dragOverHandlerShim.bind(this,b));delete this.linkedGroups[a].sortables[b];delete this.linkedGroups[a].draggables[b];delete this.linkedGroups[a].droppables[b];return true;}return false;},removeSortable:function(a){if(a in this.sortables){this.draggables[a].destroy();this.droppables[a].destroy();delete this.draggables[a];delete this.droppables[a];delete this.sortables[a];}},setDisabled:function(a){this.disabled=a;return this;},setBeforeGrabCallback:function(a){this.onbeforegrabcallback=a;return this;},setBoundingBox:function(a){this.boundingBox=a;for(var b in this.draggables)this.draggables[b].setBoundingBox(this.boundingBox);return this;},setBeforeDragOverCallback:function(a){this.onbeforedragover=a;return this;},setDragOverCallback:function(a){this.ondragover=a;return this;},setDropCallback:function(a){this.ondropcallback=a;return this;},setDroppable:function(a){this.isDroppable=a;return this;},setGrabCallback:function(a){this.ongrabcallback=a;return this;},setBeforeLinkJumpHandler:function(a){this.linkedGroups.onbeforelinkjump=a;return this;},setInsertPlaceholderHandler:function(a){this.insertPlaceholder=a;},setLinkJumpHandler:function(a){this.linkedGroups.onlinkjump=a;return this;},setNeverEmpty:function(a){this.neverEmpty=a;},setOrderChangeHandler:function(a){this.onorderchange=a;return this;},setRequireSameParent:function(a,b){this.requireSameParent=b;},setSortablesGetter:function(a){this.getSortables=a;},_checkLastRemaining:function(a){var b=this.hasEmptyMessage?2:1;return this.neverEmpty&&this.getSortables().length==b;},_dragOverHandlerShim:function(b,a){this.dragOverHandler(b,a.getKey('key'));},_initializeAdded:function(a,b){if(this.rootNode===null){this.rootNode=b.parentNode;if(!this.linkedGroups.placeholder)this.linkedGroups.placeholder=$N(b.tagName,{className:'dragPlaceholder',style:{padding:'0px'}});}else if(this.requireSameParent&&this.rootNode!=b.parentNode)throw new Error('All sortables of a collection must share the same parentNode');if(a in this.draggables)throw new Error('All sortables must have a unique key');}};
function TypingIndicator(a,b,d,c){this.id=a;this.input=b;this.source=d;this.callback=null;Arbiter.subscribe(PresenceMessage.getArbiterMessageType('typ'),this.onTyping.bind(this));this.currentState=TypingIndicator.INACTIVE;this.remoteState=TypingIndicator.INACTIVE;this.lastKeystrokeAt=null;this.notifyTimer=null;this.checkTimer=null;c=c||{};this.notifyDelay=c.notifyDelay||TypingIndicator.DEFAULT_NOTIFY_DELAY;this.keystrokeExpiry=c.keystrokeExpiry||TypingIndicator.DEFAULT_KEYSTROKE_EXPIRY;Event.listen(b,'keyup',this._update.bind(this));}copy_properties(TypingIndicator,{INACTIVE:0,TYPING:1,DEFAULT_NOTIFY_DELAY:1000,DEFAULT_KEYSTROKE_EXPIRY:7000});copy_properties(TypingIndicator.prototype,{resetState:function(){presence.debug('typing: ** RESET **');this.currentState=TypingIndicator.INACTIVE;this.remoteState=TypingIndicator.INACTIVE;this.lastKeystrokeAt=null;clearTimeout(this.notifyTimer);this.notifyTimer=null;clearTimeout(this.checkTimer);this.checkTimer=null;},_notifyState:function(b){var d=this.id;var c=Chat.getAvailability(d);if(c&&b!=this.remoteState){this.remoteState=b;presence.debug('typing: notifyState('+b+')');if(!channelManager.iframeEverLoaded)return;var a={typ:b,to:d,source:this.source};new AsyncRequest().setHandler(this._onTypResponse.bind(this,d)).setErrorHandler(bagofholding).setData(a).setURI('/ajax/chat/typ.php').setAllowCrossPageTransition(true).send();}},_onTypResponse:function(c,b){var a=b.getPayload()||{};if(a.offline)Chat.setUnavailable(c);},_update:function(){var a=this.currentState;if(this.input.value.length==0){if(!(a==TypingIndicator.INACTIVE))this._transition(TypingIndicator.INACTIVE);}else if(a==TypingIndicator.TYPING){this._recordKeystroke();}else if(a==TypingIndicator.INACTIVE){this._transition(TypingIndicator.TYPING);this._recordKeystroke();}},_recordKeystroke:function(){this.lastKeystrokeAt=new Date();if(!this.checkTimer)this.checkTimer=this._checkTyping.bind(this).defer(this.keystrokeExpiry);},_checkTyping:function(){var a=this.lastKeystrokeAt.valueOf()+this.keystrokeExpiry;var b=new Date().valueOf();if(b>a){this._transition(TypingIndicator.INACTIVE);}else{clearTimeout(this.checkTimer);this.checkTimer=this._checkTyping.bind(this).defer(a-b+10);}},_transition:function(a){clearTimeout(this.checkTimer);this.checkTimer=null;this.lastKeystrokeAt=null;presence.debug('typing:'+this.currentState+' -> '+a);this.currentState=a;clearTimeout(this.notifyTimer);this.notifyTimer=this._notifyState.bind(this,a).defer(this.notifyDelay);},setCallback:function(a){this.callback=a;},onTyping:function(b,a){this.callback&&this.callback(a.obj);}});
function ChatGroupTab(a,b,d,e,c){this._facepileHandlers=[];this.parent.construct(this,a,b,d,d,e,c);}ChatGroupTab.extend('ChatTab');ChatGroupTab.prototype={_FACEPILE_UPDATE_INTERVAL:60000,rendererName:'chat-group-tab',msgGroupRendererName:'chat-msg-group-with-tooltip',focus:function(c,a,b){this.parent.focus(c,a,b);this._setUpdateFacepiles(true);},unfocus:function(){this.parent.unfocus();this._setUpdateFacepiles(false);},close:function(){this.parent.close();this._setUpdateFacepiles(false);this._removeFacepileHandlers();},_facepilesToken:null,_setUpdateFacepiles:function(a){if(a){if(!this._facepilesToken){this._facepilesToken=setInterval(this._sendFacepileRequest.bind(this),this._FACEPILE_UPDATE_INTERVAL);this._sendFacepileRequest();}}else if(this._facepilesToken){clearInterval(this._facepilesToken);this._facepilesToken=null;}},_sendFacepileRequest:function(){new AsyncRequest().setData({gid:this.id}).setURI('/ajax/groups/chat/update_facepiles.php').setHandler(this._renderFacepile.bind(this)).send();},_renderFacepile:function(b){this._removeFacepileHandlers();var a=b.getPayload();if(a.response_html)DOM.setContent(this.chatInfo,HTML(a.response_html));if(a.facepile_click_info)a.facepile_click_info.each(function(d){var c=DOM.scry($(d.id),'a');if(c.length)this._facepileHandlers.push(Event.listen(c[0],"click",function(){chatDisplay.focusTab(d.uid,true,d.name,d.firstName);return false;}));}.bind(this));this.handleResize();},_removeFacepileHandlers:function(){while(this._facepileHandlers.length)this._facepileHandlers.pop().remove();},handleBuddyAvailability:bagofholding,showSendAsMessageLinks:bagofholding,playSound:bagofholding,getMessageTypeInfo:function(b){var a=b=='group_msg'?'msg':b;return this.parent.getMessageTypeInfo(a);},_buildUI:function(){var b=this.parent._buildUI();var a=XHPTemplate.getNode(b,'reportLink');if(a)CSS.addClass(a,'hidden_elem');this.chatInfo=XHPTemplate.getNode(b,'facepileHolder');},isOffline:function(){return false;},mentionsUser:function(a){if(a.from==presence.user)return false;var b=a.msg.text;if(presence.alias!==""&&b.indexOf(presence.alias)!=-1)return true;if(presence.firstName!==""&&b.toLowerCase().indexOf(presence.firstName.toLowerCase())!=-1)return true;return false;},newMsg:function(a){if(this.mentionsUser(a))this.parent.playSound();this.parent.newMsg(a);},getConversationURI:bagof(''),getProfileURI:function(){return URI(env_get('www_base')).setPath('/home.php').setQueryData({sk:'group_'+this.id});}};
function ChatTab(a,c,e,b,g,d){this.inDock=!presence.inPopoutWindow;this.chatDisplay=a;this.id=c;this.name=e;this.tabRef='chatDisplay.tabs['+this.id+']';this.firstName=b;this.tabDisabled=false;this.numMissed=g||0;this.missedTime=d;this.focused=false;this.lastLogItem=null;this.historyLoaded=false;this.pendingSentMsgs=[];this.failedSentMsgs=[];this.historyRequestID=0;this.bounceAnimation=null;this.convTextEmoteProcessor=Emote.htmlEmote;this.minTextHeight=presence.inPopoutWindow?this.minTextHeightPopout:this.minTextHeightPopin;this.lastMessageAt=null;this.lastMessageHadOfflineResponse=false;this._handlers=[];this._subscriptions=[];this._buildUI();this.loadData();this.handleVisibility(true);if(this.inDock){var f=new NubController();f.init(this.tabHandle);f.subscribe('show',function(){if(this.chatDisplay.focused!=this.id)this.chatDisplay.focusTab(this.id);}.bind(this));f.subscribe('hide',function(){if(this.focused)this.chatDisplay.unfocus();}.bind(this));}if(ua.firefox())this._subscriptions.push(Arbiter.subscribe('overflow-applied-to-body',this.scrollToBottom.bind(this)));this._messagingToken=MessagingEvents.subscribe('read',function(h,i){if(i.chat_ids&&i.chat_ids.contains(this.id)){this._clearMessagingMarkAsRead();if(i.mark_as_read)this._markRead();}}.bind(this));this.videoCallSubscriptions=[];Sound.init();}ChatTab.mixin('Arbiter',{currentMsgGroup:null,rendererName:'chat-tab',msgGroupRendererName:'chat-msg-group',pendingToLogCompareWindow:60000,resendDelay:5000,handleWidth:150,popinWidth:258,popinHeight:250,popoutWidthOffset:180,flPopoutWidthOffset:200,minTextHeightPopin:13,minTextHeightPopout:32,maxTextHeight:77,msgBunchTime:300000,maxHandleLen:16,maxTitleLen:20,bounceDuration:50,isTabVisible:function(){return this.focused&&(presence.inPopoutWindow||!presence.poppedOut);},start:function(){this._popSendQueue();},restart:function(){this.getHistory(true);this.handleResize.bind(this).defer();},loadData:function(){if(this.chatDisplay.histories[this.id])this._setHistory(this.chatDisplay.histories[this.id]);},_onHistoryInitialHandler:function(a,b){if(a!=this.historyRequestID){presence.debug("tabs: got old history async, ignoring");return false;}return null;},_onHistoryResponse:function(a,l){var b=l.getPayload();var n=b.userInfo;var h=b.history;Chat.setUserInfo(this.id,n,b.fls);if(!h)return;var k=false;if(this.pendingSentMsgs.length>0&&h.length>0){var j=this.pendingSentMsgs[0];var c;for(c=h.length-1;c>=0;c--){var g=h[c];if(g.to!=this.chatDisplay.user){var m=Math.abs(j.time-g.time);if(m<this.pendingToLogCompareWindow&&j.text==g.msg.text){this._setMsgInfoMarkup(j.msgID,'');this.pendingSentMsgs.shift();this._popSendQueue();this.poppedSendQueue=true;break;}}}var e=h[h.length-1].time;for(c=0;c<this.pendingSentMsgs.length;c++){j=this.pendingSentMsgs[c];if(j.time<e)j.time=(++e);}}var i=this.chatDisplay.histories[this.id];if(i)if(h.length>0){var d=h[h.length-1];var f=d.time;for(var c=0;c<i.length;c++){var g=i[c];if(g.time>f)h.push(g);}}else h=i;this._setHistory(h);this.chatDisplay.histories[this.id]=h;if(a)if(!k)this._popSendQueue();},getHistory:function(a){var b=++(this.historyRequestID);new AsyncRequest().setInitialHandler(this._onHistoryInitialHandler.bind(this,b)).setHandler(this._onHistoryResponse.bind(this,a)).setErrorHandler(bagofholding).setMethod('GET').setReadOnly(true).setOption('suppressErrorAlerts',true).setData({id:this.id}).setURI('/ajax/chat/history.php').setAllowCrossPageTransition(true).send();},_setHistory:function(e){this.lastLogItem=null;DOM.empty(this.chatConvContent);var g=0;var j=[];Array.prototype.push.apply(j,this.failedSentMsgs);Array.prototype.push.apply(j,this.pendingSentMsgs);var f=0;var a=false;for(var b=0;b<e.length;b++){var c=e[b];var d=this.getMessageTypeInfo(c.type);if(d.unknown)continue;if(!d.preserveHistory)a=true;for(;g<j.length;g++){var h=j[g];var i=this.getMessageTypeInfo(h.type);if(!i.preserveHistory)a=true;if(h.time>f&&h.time<=c.time){if(i.visible)this.renderMsg(presence.user,this.id,h.time,h,h.msgID,h.isError,h.infoMarkup);}else break;}if(d.msg){this.renderMsg(c.from,c.to,c.time,c.msg);}else if(d.visibilityChange){this._renderVisibilityChange(c.time,c.text);}else if(d.videoMsg)this._renderVideoMsg(c.videoMsg,c.params);this.lastLogItem=c;f=c.time;}for(;g<j.length;g++){var h=j[g];if(this.getMessageTypeInfo(h.type).visible){this.renderMsg(presence.user,this.id,h.time,h,h.msgID,h.isError,h.infoMarkup);this.lastLogItem={type:h.type,from:presence.user,to:this.id,time:h.time,msg:h};}}this._toggleClearChatHistory(a);this.scrollToBottom();this.historyLoaded=true;},clearHistory:function(){new AsyncRequest().setHandler(bagofholding).setErrorHandler(bagofholding).setData({clear_history_id:this.id}).setURI(this.chatDisplay.settingsURL).setAllowCrossPageTransition(true).send();this.failedSentMsgs=[];this.pendingSentMsgs=[];this._setHistory(this.chatDisplay.histories[this.id]=[]);},reportLinkAction:function(){Bootloader.loadComponents('dialog',(function(){var a=URI(this.chatDisplay.reportURL).addQueryData({id:this.id});Dialog.bootstrap(a.toString(),null,false);}).bind(this));},_isCurrentPendingSend:function(a){return (this.pendingSentMsgs.length>0&&a==this.pendingSentMsgs[0].msgID);},_onSendServerDialogCancel:function(){if(!this._isCurrentPendingSend(msgID))return;this.failedSentMsgs.push(this.pendingSentMsgs.shift());this._popSendQueue();},_onSendInitialHandler:function(a){this.lastMessageHadOfflineResponse=false;},_onSendResponse:function(a,d){var b=d.getPayload();if(this._isCurrentPendingSend(a)){var c=this.pendingSentMsgs[0];c.asyncSuccess=true;}if(b.warning){var e=this._renderMsgWarning(('title' in b.warning?b.warning.title+'<br />':'')+b.warning.body);this._setMsgInfoMarkup(a,e,'msg_warning');}},_onSendTransportError:function(a,b){if(!this._isCurrentPendingSend(a))return;if(!this.resendTimeout)this.resendTimeout=this._resendMessage.bind(this,a).defer(this.resendDelay);},_onSendError:function(c,e){if(!this._isCurrentPendingSend(c))return;var d=e.getPayload();var b=e.getError();var a=presence.getErrorDescription(e);if(b==1356003||b==1356022){this.showSendAsMessageLinks();}else if(b==1356002){this.lastMessageHadOfflineResponse=true;chatOptions.setVisibility(false);presence.doSync();}else if(b==1356008){a=d.error.title;ErrorDialog.show(d.error.title,d.error.body);}else if(b==1356026){a=d.errorText;(new Function(d.do_onload)).apply();}this._sendErrorAll(a);},showSendAsMessageLinks:function(){this.lastMessageHadOfflineResponse=true;Chat.setUnavailable(this.id);for(var b=0;b<this.pendingSentMsgs.length;b++){var e=this.pendingSentMsgs[b];var f=ge('msg_'+this.id+'_'+e.msgID);if(f){var a='rel="dialog"';var g=new URI(this.chatDisplay.messageURL).addQueryData({id:this.id,message:e.text}).toString();var c=presence.renderLink(g,_tx("enviar como un mensaje"),a);var d=_tx("{message} ({=send as a message})",{message:this._renderMsgHtmlize(e.text),'=send as a message':c});DOM.setContent(f,HTML(d));}}},_renderMsgWarning:function(b){var a=XHPTemplate.render('chat-msg-warning');DOM.setContent(XHPTemplate.getNode(a,'message'),b);return a;},_renderMsgError:function(a){var b=XHPTemplate.render('chat-msg-error');DOM.setContent(XHPTemplate.getNode(b,'message'),a);return b;},_sendErrorAll:function(a){var b=this._renderMsgError(a);var c=true;while(this.pendingSentMsgs.length){var d=this.pendingSentMsgs.shift();d.isError=true;if(c)d.infoMarkup=b;this._setMsgInfoMarkup(d.msgID,b,'msg_error');this.failedSentMsgs.push(d);c=false;b='';}},_createMessage:function(d,f){var b=rand32()+1;var e=presence.getTime();var a=new Date().getTime();if(this.lastLogItem&&e<this.lastLogItem.time)e=this.lastLogItem.time+1;var c={text:d,msgID:b,type:f,created:a,time:e,asyncSuccess:false,isError:false,errorMarkup:''};return c;},_flushSmallQueue:function(){if(this.pendingSentMsgs.length==1){var a=this.pendingSentMsgs[0];if(channelManager.iframeEverLoaded){this._sendMessage(a);}else if(!this.resendTimeout)this.resendTimeout=this._resendMessage.bind(this,a.msgID).defer(this.resendDelay);}},_updateChatActivity:function(b,a){this.lastLogItem={type:b.type,from:presence.user,to:this.id,time:b.time,msg:a};this.chatDisplay.chatActivityTime=(new Date()).getTime();presence.doSync();},sendInput:function(){var d=this.chatInput.value;if(!d||!d.match(/[^\s]/))return;this.chatInput.value='';var c=this._createMessage(d,'msg');this.pendingSentMsgs.push(c);this._flushSmallQueue();var b={text:d};var a=this.isUserScrolled();this.renderMsg(presence.user,this.id,c.time,b,c.msgID);this._toggleClearChatHistory(true);!a&&this.scrollToBottom();this._updateChatActivity(c,b);this.typingIndicator&&this.typingIndicator.resetState();},_sendMessage:function(f){f.time=presence.getTime();if(this.lastLogItem&&f.time<this.lastLogItem.time)f.time=this.lastLogItem.time+1;clearTimeout(this.resendTimeout);this.resendTimeout=null;var e=f.msgID;var b=this.chatDisplay.histories[this.id];var d=null;if(b)for(var c=b.length-1;c>=0;c--)if(b[c].type=='msg'){d=b[c].time;break;}var g={msg_id:e,client_time:f.time,to:this.id,num_tabs:this.chatDisplay.numTabs,pvs_time:d,msg_text:f.text,to_offline:this.isOffline()};var a='/ajax/chat/send.php';channelManager.expectResponse();Arbiter.inform('chat/message-sent',g);new AsyncRequest().setServerDialogCancelHandler(this._onSendServerDialogCancel.bind(this)).setInitialHandler(this._onSendInitialHandler.bind(this)).setHandler(this._onSendResponse.bind(this,e)).setErrorHandler(this._onSendError.bind(this,e)).setTransportErrorHandler(this._onSendTransportError.bind(this,e)).setData(g).setURI(a).setAllowCrossPageTransition(true).send();},_popSendQueue:function(){if(this.pendingSentMsgs.length==0)return;var a=this.pendingSentMsgs[0];if(channelManager.iframeEverLoaded){this._sendMessage(a);}else if(!this.resendTimeout)this.resendTimeout=this._resendMessage.bind(this,a.msgID).defer(this.resendDelay);},_resendMessage:function(a){clearTimeout(this.resendTimeout);this.resendTimeout=null;if(this._isCurrentPendingSend(a))if(channelManager.iframeEverLoaded){this._sendMessage(this.pendingSentMsgs[0]);}else this.resendTimeout=this._resendMessage.bind(this,a).defer(this.resendDelay);},_setMsgInfoMarkup:function(d,c,a){var b=DOM.scry(this.chatConvContent,'#msg_'+this.id+'_'+d)[0];if(!b)return;DOM.insertAfter(b,c);a&&CSS.addClass(b,a);this.scrollToBottom();},tabHitAreaOnClick:function(){if(this.suppressHeaderCollapse)return;if(presence.inPopoutWindow){this.chatDisplay.focusTab(this.id,true,this.name,this.firstName);}else this.chatDisplay.toggleTab(this.id,true,this.name,this.firstName);this.chatDisplay.doStopBlinking();},tabXOnClick:function(a){this.chatDisplay.closeTab(this.id);this.chatDisplay.doStopBlinking();$E(a).kill();return false;},headerLinkMouseOver:function(){CSS.addClass(this.chatHeader,'suppress_hover');this.suppressHeaderCollapse=true;},headerLinkMouseOut:function(){CSS.removeClass(this.chatHeader,'suppress_hover');this.suppressHeaderCollapse=false;},chatConvOnMouseDown:function(event){event=$E(event);if(event.button!=0)return;this.chatDisplay.doStopBlinking();},chatConvOnMouseUp:function(){if(DOM.getSelection()=='')this.focusChatInput(true);},focusChatInput:function(a){if(this.isTabVisible())if(a||this.canStealFocus())this.chatInput.focus();},canStealFocus:function(){if(undefined!=document.activeElement){var a=document.activeElement;if(a){var b='INPUT'==a.nodeName||'TEXTAREA'==a.nodeName||('DIV'==a.nodeName&&a.contentEditable=="true");return !b;}}return false;},_buildUI:function(){var g=XHPTemplate.render(this.rendererName);DOM.setContent(XHPTemplate.getNode(g,'name'),this.name);var h=XHPTemplate.getNode(g,'titlebarLink');h.href=this.getProfileURI();DOM.setContent(h,this.name);var b=XHPTemplate.getNode(g,'chatConv');var e=XHPTemplate.getNode(g,'closeButton');var c=XHPTemplate.getNode(g,'input');this._handlers.push(Event.listen(b,'mousedown',this.chatConvOnMouseDown.bind(this)),Event.listen(b,'mouseup',this.chatConvOnMouseUp.bind(this)),Event.listen(e,'click',this.tabXOnClick.bind(this)),Event.listen(c,'keydown',this.inputKeyDown.bind(this)),Event.listen(c,'keypress',this.inputKeyPress.bind(this)),Event.listen(c,'click',this.chatDisplay.doStopBlinking.bind(this.chatDisplay)));var f=XHPTemplate.getNode(g,'maximizeButton');if(f)this._handlers.push(Event.listen(f,'click',this.maximizeOnClick.bind(this)));this.tabHandle=g;this.tabCount=XHPTemplate.getNode(g,'numMessages');this.chatWrapper=XHPTemplate.getNode(g,'chatWrapper');Dock.setFlyoutContentHeight(this.chatWrapper,285);this.chatConv=b;this.chatConvContent=XHPTemplate.getNode(g,'conversation');this.chatInput=c;this.chatShadowInput=this.chatInput.cloneNode(true);CSS.addClass(this.chatShadowInput,'shadow');this.chatInput.parentNode.appendChild(this.chatShadowInput);var d=ge('fbDockChatTabs');DOM.prependContent(d,this.tabHandle);if(Chat.isFeatureAvailable('typ'))this.typingIndicator=new TypingIndicator(this.id,c,'chat');this._updateNumMissedDisplay();var i=XHPTemplate.getNode(g,'videoCallLink');if(i)Event.listen(i,'click',(function(){VideoEvents.inform(VideoEvents.START_CALL,{idTarget:this.id});return false;}).bind(this));var a=XHPTemplate.getNode(g,'actions');this.actions=new ChatTabActions(a);this.actions.appendAction('clearHistory',_tx("Limpiar ventana",{Chat:_tx("Chat")}),this.clearHistory.bind(this));if(Chat.isFeatureAvailable('report'))this.actions.appendAction('reportLink',_tx("Report"),this.reportLinkAction.bind(this));this.actions.refresh();return g;},maximizeOnClick:function(){var a=this.getConversationURI();if(a){goURI(a);this.focused&&this.chatDisplay.unfocus();}return false;},getConversationURI:function(){return Messaging.getUserThreadURI(this.id);},getProfileURI:function(){return URI(env_get('www_base')).setPath('/profile.php').setQueryData({id:this.id});},show:function(){CSS.show(this.tabHandle);},hide:function(){CSS.hide(this.tabHandle);},inputKeyDown:function(event){event=$E(event);this.chatDisplay.doStopBlinking();switch(event.keyCode){case KEYS.ESC:this.chatDisplay.closeTab(this.id);event.prevent();return false;case KEYS.TAB:if(presence.inPopoutWindow){var b=event.shiftKey;var a=this.chatDisplay.getNextTabId(this.id,b);if(a>0){this.chatDisplay.focusTab(a,true);event.prevent();return false;}}}if(event.keyCode==KEYS.RETURN&&!event.shiftKey)if(this.chatInput.value)this.sendInput();if(event.keyCode==KEYS.DELETE||event.keyCode==KEYS.BACKSPACE)this.handleResize.bind(this).defer();},inputKeyPress:function(event){event=$E(event);this.handleResize.bind(this).defer();if(event.keyCode==KEYS.RETURN&&!event.shiftKey){event.returnValue=false;return false;}return null;},trimName:function(a){var b=this.name;if(b.length>a)b=b.substring(0,a-2)+'...';return b;},handleVisibility:function(b){var a=Chat.isOnline();if(a){this._enableTab(true,false,a,b);}else this._disableTab(true,a,b);this.handleBuddyAvailability(!b&&a,b);},handleBuddyAvailability:function(b,c){if(!Chat.isOnline())return;var a=Chat.getAvailability(this.id);if(a){this._enableTab(false,a.i,b,c);}else this._disableTab(false,b,c);},_enableTab:function(b,a,c,d){d=d||false;var e=this.tabDisabled;this.tabDisabled=false;if(presence.inPopoutWindow){CSS.removeClass(this.popoutTab,'disabled');CSS.conditionClass(this.popoutTab,'idle',a);}CSS.removeClass(this.tabHandle,'disabled');CSS.conditionClass(this.tabHandle,'idle',a);if((b&&!d)||(!b&&e&&!c))this._newVisibilityChange(b,d,true);},_disableTab:function(a,b,c){c=c||false;var d=this.tabDisabled;this.tabDisabled=true;if(presence.inPopoutWindow){CSS.addClass(this.popoutTab,'disabled');CSS.removeClass(this.popoutTab,'idle');}CSS.addClass(this.tabHandle,'disabled');CSS.removeClass(this.tabHandle,'idle');if((a||c||!d)&&!this.lastMessageHadOfflineResponse&&!b)this._newVisibilityChange(a,c,false);},handleResize:function(){var e;var d;var b=this.isUserScrolled();if(presence.inPopoutWindow){var f=(presence.popoutWidth>330)?presence.popoutWidth:330;e=f-this.flPopoutWidthOffset-28;var a=Vector2.getElementDimensions(this.popoutChatTabs.parentNode).y;d=presence.popoutHeight-a-33;if(this.chatInputContainer)d-=this.chatInputContainer.offsetHeight-this.chatInput.offsetHeight;this.chatShadowInput.style.width=Vector2.getElementDimensions(this.chatInput).x+'px';}else{e=this.popinWidth-28;d=this.popinHeight;this.chatInput.style.width=e+'px';this.chatShadowInput.style.width=e+'px';}this.chatShadowInput.value=this.chatInput.value;var h=this.chatShadowInput.scrollHeight;if(!h||presence.isOpera){h=this.minTextHeight;if(this.chatInput.value){var g=new RegExp('([\n]|[^\n]{'+parseInt(e/8)+'})','g');var c=this.chatInput.value.match(g);if(c)h=(c.length+1)*this.minTextHeight;}}else if(!ua.firefox())h-=8;if(h>this.maxTextHeight){h=this.maxTextHeight;}else if(h<this.minTextHeight)h=this.minTextHeight;this.chatInput.style.height=h+'px';if(this.inDock){Dock._resizeNubFlyout(this.tabHandle,true);}else this.chatConv.style.height=Math.max(0,d-h)+'px';!b&&this.scrollToBottom();},isUserScrolled:function(){return (this.chatConv.scrollHeight>this.chatConv.scrollTop+this.chatConv.clientHeight);},scrollToBottom:function(){if(!this.focused)return;this.chatConv.scrollTop=this.chatConv.scrollHeight;},unfocus:function(){if(!this.focused)return;this.focused=false;if(this.inDock){Dock.hide(this.tabHandle);}else CSS.removeClass(this.tabHandle,'focused');this.inform('unfocus');},focus:function(c,a,b){if(this.focused)return;this.focused=true;this._isFragileMode=false;this._markRead();if(this.inDock){Dock.show(this.tabHandle);}else CSS.addClass(this.tabHandle,'focused');if(!c){this._onFocusUIActions(b);this._onFocusUIActions.bind(this,b).defer(100);}if(!this.historyLoaded)this.getHistory(false);this.inform('focus');},_onFocusUIActions:function(a){this.handleResize();this.scrollToBottom();this.focusChatInput(a);},_startBounce:function(){var a=-8;this.bounceAnimation=animation(this.tabCount).to('top',-16).duration(this.bounceDuration+40).checkpoint().to('top',a).duration(this.bounceDuration).checkpoint().to('top',-16).duration(this.bounceDuration+40).checkpoint().to('top',a).duration(this.bounceDuration).checkpoint().to('top',-12).duration(this.bounceDuration).checkpoint().to('top',-10).duration(this.bounceDuration).checkpoint().to('top',a).duration(this.bounceDuration).checkpoint().go();},_stopBounce:function(){if(this.bounceAnimation){this.bounceAnimation.stop();this.bounceAnimation=null;}},close:function(){if(this.inDock)Dock.unregisterNubController(this.tabHandle);while(this._handlers.length)this._handlers.pop().remove();this._subscriptions.each(Arbiter.unsubscribe);MessagingEvents.unsubscribe(this._messagingToken);this.tabHandle.parentNode.removeChild(this.tabHandle);},_newVisibilityChange:function(b,e,d){var g=presence.getTime();var f;if(b){if(d){f=_tx("Est\u00e1s conectado\/a.",{name:this.firstName});}else f=_tx("No est\u00e1s conectado.",{name:this.firstName});}else if(d){f=_tx("{name} est\u00e1 conectado\/a.",{name:this.firstName});}else if(Chat.isFeatureAvailable('titan')){f=_tx("{name} is offline. Your messages will be sent to their inbox.",{name:this.firstName});}else f=_tx("{name} est\u00e1 desconectado\/a.",{name:this.firstName});var c={type:'online',time:g,text:f};var a=this.chatDisplay.getHistory(this.id,true);a.push(c);this._renderVisibilityChange(g,f);this.scrollToBottom();this.lastLogItem=c;},newTyping:function(c){var b=c.from;var e=c.to;var f=c.st;var a=c.fl;if(!Chat.isFeatureAvailable('typ')){return;}else if((new Date()-this.lastMessageAt)<this.typingIndicator.notifyDelay)return;presence.debug('typing from '+b+': '+f);var d=(f==TypingIndicator.TYPING)&&(this.numMissed==0);if(e!=this.id){if(presence.inPopoutWindow)CSS.conditionClass(this.popoutTab,'typing',d);CSS.conditionClass(this.tabHandle,'typing',d);Chat.setAvailable(this.id,a);}},_isChatMessage:function(a){return this.getMessageTypeInfo(a.type).user;},newMsg:function(k){var c=k.from;var o=k.to;var p=k.type;var i=k.msg;var n=i.time;var a=i.clientTime;var j=i.msgID;var l=true;this.lastMessageAt=new Date();var d=this.chatDisplay.getHistory(this.id,true);var h=null;for(var f=d.length-1;f>=0;f--)if(this._isChatMessage(d[f])){h=d[f];break;}if(h&&n<=h.time){var b=false;for(var f=0;f<d.length;f++)if(this._isChatMessage(d[f])&&n==d[f].time){b=true;break;}if(b){presence.warn('tabs: already had this msg');return;}for(var f=d.length-1;f>=0;f--){var e=d[f];if(this._isChatMessage(e)&&(e.to!=o||(!e.msg.clientTime||e.msg.clientTime<a)))break;}presence.warn('tabs: merging new msg due to out-of-order server timestamp');if(f==d.length-1){d.push(k);}else{d.splice(f+1,0,k);this._setHistory(d);l=false;}}else this.chatDisplay.histories[this.id].push(k);if(c!=this.chatDisplay.user){var m=this.chatDisplay.isSquelched()||this.chatDisplay.isSquelchedTab(this.id);this._isFragileMode=false;if(m){this._markRead(n);}else{this.playSound();if(this.focused){this._markRead(n);}else this._markUnread(n);this._messagingMarkAsRead();}if(presence.inPopoutWindow)CSS.removeClass(this.popoutTab,'typing');CSS.removeClass(this.tabHandle,'typing');if(this instanceof ChatTab)Chat.setAvailable(this.id,k.fl);}else{this._markRead();if(this._removeDuplicatePendingMessage(j))l=false;}l=this.getMessageTypeInfo(p).visible&&l;if(l){var g=this.isUserScrolled();this.renderMsg(c,o,n,i);this._toggleClearChatHistory(true);!g&&this.scrollToBottom();this.lastLogItem=k;}},_removeDuplicatePendingMessage:function(b){for(var a=0;a<this.pendingSentMsgs.length;a++)if(b==this.pendingSentMsgs[a].msgID){var c=this.pendingSentMsgs.splice(a,1);this._popSendQueue();this.chatDisplay.reportLatency(new Date().getTime()-c[0].created);return true;}return false;},getInputElem:function(){return this.chatInput;},_messagingMarkAsRead:function(){if(!Chat.isFeatureAvailable('titan'))return;this._clearMessagingMarkAsRead();var a=chatOptions.getSetting('idle_cutoff');if(a&&UserActivity.isActive(a)){Messaging.markUserThreadAsRead(this.id);}else this._pendingMessagingMarkAsRead=UserActivity.subscribe(this._messagingMarkAsRead.bind(this));},_clearMessagingMarkAsRead:function(){if(this._pendingMessagingMarkAsRead){UserActivity.unsubscribe(this._pendingMessagingMarkAsRead);delete this._pendingMessagingMarkAsRead;}},_markRead:function(){this._updateNumMissed(0);this._stopBounce();},_markUnread:function(a){this._updateNumMissed(this.numMissed+1,a);this._startBounce();},squelch:function(){this._markRead();},_updateNumMissed:function(a,b){if(a==this.numMissed||(b&&b<=this.missedTime))return;if(a>99)a=99;this.numMissed=a;this.missedTime=b;this._updateNumMissedDisplay();},_updateNumMissedDisplay:function(){DOM.setContent(this.tabCount,this.numMissed);if(this.inDock)chatTabSlider.updateMissedCount();CSS.conditionClass(this.tabHandle,'highlight',this.numMissed>0);CSS.conditionShow(this.tabCount,this.numMissed>0);},_checkDateBreak:function(d){var c=new Date();c.setTime(d);var b=new Date();if(this.lastLogItem)b.setTime(this.lastLogItem.time);var a=null;if(!this.lastLogItem||c.getDate()!==b.getDate()||c.getMonth()!==b.getMonth()){a=XHPTemplate.render('chat-msg-date-break');DOM.setContent(a,renderDate(c,!presence.inPopoutWindow));DOM.appendContent(this.chatConvContent,a);this.currentMsgGroup=null;}},_renderVisibilityChange:function(b,d){this._checkDateBreak(b);var a=XHPTemplate.render('chat-msg-status-change');DOM.setContent(XHPTemplate.getNode(a,'message'),d);var c=this.chatDisplay.renderServerTime(b);DOM.setContent(XHPTemplate.getNode(a,'timestamp'),c);DOM.appendContent(this.chatConvContent,a);},_renderVideoMsg:function(g,h){var d=XHPTemplate.render('chat-video-msg');var e=XHPTemplate.getNode(d,'message');var k=XHPTemplate.getNode(d,'timestamp');var a=XHPTemplate.getNode(d,'actions');var j=h.time||presence.getTime();var i=this.chatDisplay.renderServerTime(j);this._checkDateBreak(j);switch(g){case 'missed-call':var f=_tx("Missed call from {firstname} at {time}",{firstname:this.firstName,time:i});DOM.setContent(e,f);if(this.chatDisplay.gatedFeatures.video){var b=$N('a',{href:"#"},_tx("Call {firstname}",{firstname:this.firstName}));Event.listen(b,'click',(function(){VideoEvents.inform(VideoEvents.START_CALL,{idTarget:this.id});return false;}).bind(this));DOM.setContent(a,b);}break;case 'unanswered-call':DOM.setContent(k,i);var l=_tx("{firstname} did not answer your call",{firstname:this.firstName});DOM.setContent(e,l);var n=URI('/ajax/messaging/composer.php?').setQueryData({id:this.id}).toString();var m=$N('a',{href:n,rel:'dialog'},_tx("Send {firstname} a message",{firstname:this.firstName}));DOM.setContent(a,m);break;case 'connected-call':var c=_tx("Call with {firstname} at {time}",{firstname:this.firstName,time:i});DOM.setContent(e,HTML(c));break;}DOM.appendContent(this.chatConvContent,d);},renderMsg:function(g,t,s,m,p,i,d){this._checkDateBreak(s);var k=XHPTemplate.render('chat-msg');k.id='msg_'+this.id+'_'+p;var h=m.text.substr(0,4)=='?OTR';CSS.conditionClass(k,'cyphertext',h);if(h){DOM.setContent(k,_tx("[encrypted message]"));}else{var n=[];var o=m.text;var r;var q;var j;if(m.spoof){q=new RegExp('^\\s*<([^<>]+?)>\\s+');j=o.match(q);if(j){o=o.substr(j[0].length);d=this._renderMsgWarning(j[1]);}}if(m.truncated||m.forward||m.attachment){q=new RegExp('(?:\\.{3}\\s+)?'+'(?:<([^<>]+?)>\\s+)?'+'(?:<([^<>]+?)>\\s+)?'+'(\\S+)\\s*$');j=o.match(q);if(j){o=o.substr(0,o.lastIndexOf(j[0]));var r=j[3];if(m.truncated){n.push(HTML('&hellip; '));var l=$N('a',{href:r,className:'more'},_tx("Ver todo"));n.push(l);}if(m.forward){var f=XHPTemplate.render('chat-msg-forward');f.href=r;var e=XHPTemplate.getNode(f,'label');DOM.setContent(e,j[1]);n.push($N('div',f));}if(m.attachment){var b=XHPTemplate.render('chat-msg-attachment');b.href=r;var a=XHPTemplate.getNode(b,'label');DOM.setContent(a,j[2]||j[1]);n.push($N('div',b));}}}n.unshift(HTML(this._renderMsgHtmlize(o)));DOM.setContent(k,n);}var c=this.getCurrentMsgGroup(g,t,s);this.addMessageToGroup(k,c);d&&this.addMessageToGroup(d,c);},_renderMsgHtmlize:function(a){return html_hyperlink(a||'',this._processStyledText.bind(this,this.convTextEmoteProcessor),null,true);},newVideoMsg:function(f,d){var e=d.time||presence.getTime();var a=this.chatDisplay.getHistory(this.id,true);var c={type:'videochat',videoMsg:f,time:e,params:d};a.push(c);if(f==='missed-call'||f==='unanswered-call')if(this.focused){this._markRead(e);}else this._markUnread(e);var b=this.isUserScrolled();this._renderVideoMsg(f,d);!b&&this.scrollToBottom();this.lastLogItem=c;},incomingVideoCall:function(h){if(this.incomingCallFlyout)return;this.incomingCallFlyout=XHPTemplate.render('chat-video-incoming-call');Dock.setFlyoutContentHeight(this.incomingCallFlyout,285);DOM.insertBefore(this.incomingCallFlyout,this.chatWrapper);CSS.hide(this.chatWrapper);DOM.setContent(XHPTemplate.getNode(this.incomingCallFlyout,'incomingCallTitlebar'),_tx("Incoming call: {firstname}",{firstname:this.firstName}));if(h.src&&h.dims){var g=XHPTemplate.getNode(this.incomingCallFlyout,'incomingCallPhoto');g.src=h.src;var d=this.incomingCallFlyout.offsetWidth;var b=240;var c=d/b;var f=h.dims.width/h.dims.height;if(f>c){CSS.setStyle(g,'height',b+'px');}else CSS.setStyle(g,'width',d+'px');}var a=XHPTemplate.getNode(this.incomingCallFlyout,'answerButton');var e=XHPTemplate.getNode(this.incomingCallFlyout,'ignoreButton');Event.listen(a,'click',function(){Button.setLabel(a,_tx("Connecting..."));Button.setEnabled(a,false);this.videoCallSubscriptions.push(VideoEvents.subscribe([VideoEvents.CALL_CONNECTED,VideoEvents.FATAL_ERROR,VideoEvents.PROMPT_PLUGIN_INSTALL],this.finishIncomingCall.bind(this)));this.videoCallSubscriptions.push(VideoEvents.subscribe([VideoEvents.ACTIVATING,VideoEvents.LOGGING_IN,VideoEvents.GETTING_TOKEN,VideoEvents.CONNECTING],this.setVideoStatus.bind(this)));VideoEvents.inform(VideoEvents.ANSWER_CALL,{idTarget:this.id});}.bind(this));Event.listen(e,'click',function(){VideoEvents.inform(VideoEvents.IGNORE_CALL,{idTarget:this.id});this.finishIncomingCall();}.bind(this));this.videoCallSubscriptions.push(VideoEvents.subscribe([VideoEvents.CALL_HANDLED,VideoEvents.FATAL_PLUGIN_ERROR],this.finishIncomingCall.bind(this)));Dock._resizeNubFlyout(this.tabHandle,true);},setVideoStatus:function(b){var a='';switch(b){case VideoEvents.ACTIVATING:a=_tx("Initializing video calling software...");break;case VideoEvents.LOGGING_IN:a=_tx("Contacting video calling server...");break;case VideoEvents.GETTING_TOKEN:a=_tx("Authenticating video call request...");break;case VideoEvents.CONNECTING:a=_tx("Connecting to {firstname}...",{firstname:this.firstName});break;}DOM.setContent(XHPTemplate.getNode(this.incomingCallFlyout,'status-message'),a);},finishIncomingCall:function(){if(this.incomingCallFlyout){DOM.remove(this.incomingCallFlyout);this.incomingCallFlyout=null;CSS.show(this.chatWrapper);}this.videoCallSubscriptions.forEach(function(a){VideoEvents.unsubscribe(a);});this.videoCallSubscriptions=[];},_processStyledText:function(b,a){return b(a).replace(/\b_([^_\*]+)_\b/g,'<u>$1</u>').replace(/(\s|^)\*([^_\*]+)\*(?=$|\s)/g,'$1<b>$2</b>');},playSound:function(){if(Chat.isFeatureAvailable('sound')&&chatOptions.getSetting('sound'))Sound.play('/sound/pling.mp3',true);},_messageTypes:{msg:{visible:true,user:true,preserveHistory:false,msg:true},online:{visible:true,user:false,preserveHistory:true,visibilityChange:true},videochat:{visible:true,user:false,preserveHistory:true,videoMsg:true}},getMessageTypeInfo:function(a){return this._messageTypes[a]||{unknown:true};},addMessageToGroup:function(b,a){DOM.appendContent(XHPTemplate.getNode(a,'messages'),b);},getCurrentMsgGroup:function(a,i,g){if(!this.currentMsgGroup||!this.lastLogItem||this.lastLogItem.from!=a||(g-this.lastLogItem.time)>this.msgBunchTime){var c=XHPTemplate.render(this.msgGroupRendererName);var d=XHPTemplate.getNode(c,'profileLink');var e=XHPTemplate.getNode(c,'profilePhoto');var f=function(j){if(CSS.hasClass(d,'profileTooltipLink')){TooltipLink.setTooltipText(d,j);}else if(j){e.setAttribute('title',j);}else e.removeAttribute('title');};var b=a==this.chatDisplay.user;!b&&f('');ChatUserInfoManager.get(a,function(j){e.src=j.thumbSrc;d.setAttribute('href',this.chatDisplay.profileURL+'?id='+a);!b&&f(j.name||this.name);}.bind(this));var h=this.chatDisplay.renderServerTime(g);DOM.setContent(XHPTemplate.getNode(c,'timestamp'),h);DOM.appendContent(this.chatConvContent,c);this.currentMsgGroup=c;}return this.currentMsgGroup;},isOffline:function(){return !(Chat.getAvailability(this.id));},_isFragileMode:false,setFragileMode:function(){this._isFragileMode=true;this._subscriptions.push(Arbiter.subscribe('page_transition',this._removeFragileTab.bind(this)));},_removeFragileTab:function(){if(!this._isFragileMode)return;this.chatDisplay.closeTab(this.id);},_toggleClearChatHistory:function(a){if(this.actions)this.actions.setVisible('clearHistory',a).setVisible('reportLink',a).refresh();}});function renderDate(a,e){if(e){var f=new Date();f.setHours(0);f.setMinutes(0);f.setSeconds(0);f.setMilliseconds(0);var b=24*60*60*1000;var c=f.getTime()-a.getTime();if(c<=0){return _tx("Hoy");}else if(c<b)return _tx("Ayer");}var d='';switch(a.getMonth()){case 0:d=_tx("enero");break;case 1:d=_tx("febrero");break;case 2:d=_tx("marzo");break;case 3:d=_tx("abril");break;case 4:d=_tx("mayo");break;case 5:d=_tx("junio");break;case 6:d=_tx("julio");break;case 7:d=_tx("agosto");break;case 8:d=_tx("septiembre");break;case 9:d=_tx("octubre");break;case 10:d=_tx("noviembre");break;case 11:d=_tx("diciembre");break;}return _tx("{date}{month}",{month:d,date:a.getDate()});}
function ChatDisplay(f,c,a,d,e,b){this.histories=f;this.everSentMessage=c;this.user=presence.user;var g=env_get('www_base');this.profileURL=g+'profile.php';this.messageURL=g+'ajax/messaging/composer.php';this.settingsURL='/ajax/chat/settings.php';this.reportURL='/ajax/chat/report.php';this.gatedFeatures=e;this.controllers=copy_properties({friend:'ChatTab',group:'ChatGroupTab'},b);this.useUICookieCache=e.ui_cookie_cache;this.renderServerTime=this.gatedFeatures['24h_times']?this._renderServerTime24hr:this._renderServerTime12hr;this.jabberSquelchInterval=300000;this._squelchUntil=null;this._squelchedIds={};this._reportedLatencies=0;this.tabs={};this.tabList=[];this.numTabs=0;this.lastFocused=null;this.newMsgNames=[];this.newMsgNamesIndex=0;this.blinkingTimer=null;Arbiter.subscribe('buddylist/initialized',function(){this._init.bind(this,a,d).defer();}.bind(this));}ChatDisplay.prototype={blinkTime:1500,initialBlinkDelay:3000,_init:function(a,b){this.loaded=false;this.chatActivityTime=0;if(this.useUICookieCache){this.uiChangeTime=0;this.uiCookieCacheTime=(Env.rep_lag+presence.sitevars.CHAT_UI_COOKIE_CACHE_WINDOW)*1000;}this.initialFocusedChat=b;this.initialActiveChats=a;presence.registerStateStorer(this._store.bind(this));presence.registerStateLoader(this._load.bind(this));if(window.VideoChat)VideoChat.init();var c=['unfocus_chat','focus_chat','close_chat','group_msg','msg','typ','video','chat_event','buddylist_overlay'].map(PresenceMessage.getArbiterMessageType);Arbiter.subscribe(c,this._handlePresenceMessage.bind(this));Arbiter.subscribe(PresenceMessage.STARTED,this.start.bind(this));Arbiter.subscribe(PresenceMessage.SHUTDOWN,this.shutdown.bind(this));Arbiter.subscribe(PresenceMessage.RESTARTED,this.restart.bind(this));Arbiter.subscribe(ChatOptions.VISIBILITY_CHANGED,this.handleVisibility.bind(this));Arbiter.subscribe(ChatBuddyList.AVAILABILITY_CHANGED,this._onBuddyAvailability.bind(this));Arbiter.subscribe(PresenceMessage.WINDOW_RESIZED,this.handleResize.bind(this));Arbiter.subscribe('channel/invalid_history',this.handleInvalidHistory.bind(this));Event.listen(window,'focus',this.onWindowFocus.bind(this));Event.listen(window,'blur',this.onWindowBlur.bind(this));if(this.gatedFeatures.video)this._initVideoListeners();},onWindowFocus:function(){this.isWindowFocused=true;this.doStopBlinking();},onWindowBlur:function(){this.isWindowFocused=false;},start:function(){for(var a in this.tabs)this.tabs[a].start();},shutdown:function(){this._stopBlinking();},restart:function(){for(var a in this.tabs)this.tabs[a].restart();},loadInitialUserInfo:function(b,c,a,d){if(ChatUserInfos[b])return;ChatUserInfos[b]={name:c,firstName:a,thumbSrc:'',type:d||'friend'};},_loadInitialTabs:function(a,d){if(!hasArrayNature(a)){var l=[];for(var b in a)l.push(copy_properties(a[b],{i:b}));a=l;}for(var e=0,g=a.length;e<g;e++){var k=a[e];var f=k.i;if(this.tabs[f])continue;var i,c,m;if(f in ChatUserInfos){i=ChatUserInfos[f].name;c=ChatUserInfos[f].firstName;m=ChatUserInfos[f].type;}else{i=k.n;if(!i)continue;c=k.fn||getFirstName(i);m=k.type||'friend';}var j=k.m||0;var h=k.t||0;this.createTab(m,f,i,c,j,h);}if(presence.inPopoutWindow&&!d&&a.length)d=a[0].i;if(d&&(d!=this.focused))this._focusTab(d);chatTabSlider.addTab();},load:function(){this._load(presence.state);(function(){Arbiter.inform('chat-display/loaded',this,Arbiter.BEHAVIOR_PERSISTENT);}).bind(this).defer();},loadTabFragile:function(b,c,a,d){if(presence.isOnline()&&!this.tabs[b]){this._loadInitialTabs([{i:b,n:c,fn:a,type:d}]);this.tabs[b].setFragileMode();}},_load:function(c){var a=false;if(c){if(this.blinkingTimer&&c.sb)this._stopBlinking();this._squelchUntil=c.sq;this.chatActivityTime=verifyNumber(c.ct)*1000;if(this.useUICookieCache){var b=presence.getTime();this.uiChangeTime=Math.max(this.uiChangeTime,verifyNumber(c.uct)*1000);if(!this.loaded)if(b-this.uiChangeTime<this.uiCookieCacheTime){if(b-c.ut>60*60*1000)c.t.each(function(d){d.m=0;});presence.debug('chatDisplay: loading tabs from cookie cache');this._loadInitialTabs.bind(this,c.t,c.f).defer();a=true;}}}if(!this.loaded&&!a){presence.debug('chatDisplay: loading tabs from server state');this._loadInitialTabs.bind(this,this.initialActiveChats,this.initialFocusedChat).defer();this.initialFocusedChat=this.initialActiveChats=false;}this.loaded=true;},_store:function(d){d.ct=Math.floor(this.chatActivityTime*.001);d.sb=(this.blinkingTimer==null)?1:0;var e=this.getSquelchUntil();if(e!==null)d.sq=e;if(this.useUICookieCache){d.t=[];d.f=null;d.uct=0;var c=presence.getTime();if(c-this.uiChangeTime<this.uiCookieCacheTime){for(var a=0,b=this.tabList.length;a<b;a++){var g=this.tabList[a];var f={i:g.id,n:g.name,m:g.numMissed};if(g.type=='group'||g.firstName!=getFirstName(g.name))f.fn=g.firstName;d.t.push(f);}d.f=this.focused;d.uct=Math.floor(this.uiChangeTime*.001);}}return d;},handleResize:function(){if(!this.focused)return;var a=this.tabs[this.focused];a.handleResize();},handleInvalidHistory:function(){var a=this.focused&&this.tabs[this.focused];if(a)a.getHistory(true);},_sendTabStateChange:function(a){a.window_id=presence.windowID;new AsyncRequest().setURI(this.settingsURL).setData(a).setHandler(this._onCheckTabStateChangeResponse.bind(this)).setErrorHandler(bagofholding).setAllowCrossPageTransition(true).send();},_onCheckTabStateChangeResponse:function(c){var b=c.getPayload();if(b.overlay){for(var a in b.overlay)if(a&&b.overlay[a]&&b.overlay[a].ol==ChatBuddyList.OVERLAY_OFFLINE&&Chat.getAvailability(a))presence.error("presence:ol_on_to_off:id="+a);Chat.addOverlayInfo(b.overlay);}},reloadTabs:function(){for(var a in this.tabs)this.tabs[a].loadData();},_closeTab:function(a){if(!this.tabs[a])return;var c=this.tabList.indexOf(this.tabs[a]);if(this.focused==a)if(presence.inPopoutWindow){var b=this.tabList.length;var d=this.tabList[((c+(c?-1:1))+b)%b].id;if(d!=a){this.focusTab(d);}else this.focused=null;}else this.focused=null;this.tabs[a].close();this.tabList.splice(c,1);delete this.tabs[a];this.numTabs--;Arbiter.inform('chat/conversation-closed',{id:a});chatTabSlider.close();},uiChanged:function(){if(this.useUICookieCache){this.uiChangeTime=presence.getTime();presence.doSync();}},closeTab:function(a){this._closeTab(a);this._sendTabStateChange({close_chat:a});this.uiChanged();},_unfocus:function(b){var a=this.focused;if(!a||(b&&a!=b))return false;this.focused=null;if(presence.inPopoutWindow)this.tabs[a].deselectPopoutChat();this.tabs[a].unfocus();return true;},unfocus:function(a,b){if(this._unfocus(a)&&b!==false){this._sendTabStateChange({unfocus_chat:1});this.uiChanged();}this.lastFocused=null;},unfocusNoSync:function(){this._unfocus();},refocus:function(){if(!this.lastFocused||!this.tabs[this.lastFocused])return null;this._focusTab(this.lastFocused);},_focusTab:function(d,b,e,a,f){if(d==this.focused)return this.tabs[d];if(!this.tabs[d]){if(typeof e=='undefined')if(ChatUserInfos[d]&&ChatUserInfos[d].name){e=ChatUserInfos[d].name;a=ChatUserInfos[d].firstName;}else{presence.warn("chat:tab creation aborted:couldn't create tab "+d+" since no name is specified");return null;}if(typeof a=='undefined')a=e;if(typeof f=='undefined')if(ChatUserInfos[d]&&ChatUserInfos[d].type){f=ChatUserInfos[d].type;}else f='friend';this.createTab(f,d,e,a);chatTabSlider.addTab(d);}chatTabSlider.gotoTab(d);if(this.focused){this.tabs[this.focused].unfocus();if(presence.inPopoutWindow)this.tabs[this.focused].deselectPopoutChat();}this.focused=d;this.lastFocused=d;if(this.focused){var c=!presence.inPopoutWindow&&presence.poppedOut;if(this.tabs[this.focused])this.tabs[this.focused].focus(c,this.loaded,b);if(presence.inPopoutWindow)this.tabs[d].selectPopoutChat();}return this.tabs[d];},focusTab:function(c,b,d,a,e){presence.pauseSync();this._focusTab(c,b,d,a,e);this._sendTabStateChange({focus_chat:c});this.uiChanged();this.chatActivityTime=(new Date()).getTime();this.doStopBlinking();presence.resumeSync();},toggleTab:function(c,b,d,a){if(this.focused==c){this.unfocus();}else this.focusTab(c,b,d,a);},getNextTabId:function(a,e){if(!(a in this.tabs))return -1;var c=this.tabList.indexOf(this.tabs[a]);if(!presence.inPopoutWindow)e=!e;var d=a;if(c>=0){if(e){c--;}else c++;var b=this.tabList.length;d=this.tabList[(c+b)%b].id;}return parseInt(d,10);},_handleBlinking:function(a,c){var b=(a==this.user);if(b){this.doStopBlinking(true);}else if(this.isWindowFocused){setTimeout(this.doStopBlinking.bind(this,true),500);}else if(!presence.isOpera){this.newMsgNames.push(c.firstName);if(!this.blinkingTimer)this.blinkingTimer=setTimeout(function(){this.blinkingTimer=setInterval(this._doBlink.bind(this),this.blinkTime);}.bind(this),this.initialBlinkDelay);}},_doBlink:function(){if(this._isBlinking){DocumentTitle.set(DocumentTitle.get());this._isBlinking=false;}else{if(this.newMsgNames&&this.newMsgNames.length>0){if(this.newMsgNamesIndex>=this.newMsgNames.length)this.newMsgNamesIndex=0;var a=this.newMsgNames[this.newMsgNamesIndex++];DocumentTitle.set(_tx("Nuevo mensaje de {name}",{name:a}),true);}else DocumentTitle.set(_tx("Nuevo mensaje"),true);this._isBlinking=true;}},doStopBlinking:function(a){if(this.blinkingTimer||a){this._stopBlinking();presence.doSync();}},_stopBlinking:function(){if(this.blinkingTimer){if(this._isBlinking)this._doBlink();clearInterval(this.blinkingTimer);this.blinkingTimer=null;this.newMsgNames=[];this.newMsgNamesIndex=0;}},_onBuddyAvailability:function(b,a){this.handleBuddyAvailability(a.justCameOnline);},handleBuddyAvailability:function(b){for(var a in this.tabs)this.tabs[a].handleBuddyAvailability(b);},_handlePresenceMessage:function(k,a){if(!Chat.isOnline())return;var f=a.obj;if(f.window_id==presence.windowID)return;var d=null;if(f.from==this.user){d=f.id||f.to;this.setSquelched(!!f.csid);}else d=f.id||f.from;var i=this.tabs[d];var j=(ChatUserInfos[d]&&ChatUserInfos[d].type)||f.tab_type||'friend';var g=this.isSquelched();var h=this.isSquelchedTab(d);switch(f.type){case 'unfocus_chat':this._unfocus();break;case 'focus_chat':this._focusTab(d,undefined,undefined,undefined,j);break;case 'close_chat':this._closeTab(d);break;case 'group_msg':case 'msg':var c=(f.from==this.user);var e,b;if(j=="group"){e=f.to_name;b=e;}else if(c){e=f.to_name;b=f.to_first_name?f.to_first_name:getFirstName(e);}else{e=f.from_name;b=f.from_first_name?f.from_first_name:getFirstName(e);}this.loadInitialUserInfo(d,e,b,j);if(!g&&!h&&!i){i=this.createTab(j,d,e,b);chatTabSlider.addTab(d);if(!this.focused){this._focusTab(d);}else i.getHistory();}if(!g&&!h&&(presence.inPopoutWindow||!presence.poppedOut))this._handleBlinking(f.from,i);if(i){f.time=f.msg.time;i.newMsg(f);}break;case 'typ':if(!g||this.focused==d)i&&i.newTyping(f);break;case 'video':this._newVideoMessage(f);break;case 'chat_event':this._newChatEventMessage(f);break;case 'buddylist_overlay':Chat.addOverlayInfo(f.overlay);break;default:break;}},_newVideoMessage:function(d){var b=d.from;var c=d.message_type;var e=d.parameters;var a=d.fl;window.VideoChat&&VideoChat.handleMessage(b,c,e);(b!=this.user)&&Chat.setAvailable(b,a);},_newChatEventMessage:function(a){if(this.gatedFeatures.video)this._handleVideoEvent(a.from,a.event_name,a.parameters||{});},_handleVideoEvent:function(b,a,c){var d=this.tabs[b];switch(a){case 'missed-call':case 'unanswered-call':ChatUserInfoManager.get(b,function(e){if(!d)d=this.createTab('friend',b,e.name,e.firstName);if(!this.focused)this._focusTab(b);d.newVideoMsg(a,c);}.bind(this));break;case 'connected-call':if(b==this.user)d=this.tabs[c.to];d&&d.newVideoMsg(a,c);break;case 'incoming-call':ChatUserInfoManager.get(b,function(e){if(!d)d=this.createTab('friend',b,e.name,e.firstName);this._focusTab(b);d.incomingVideoCall(c.profilePic);}.bind(this));break;}(b!=this.user)&&Chat.setAvailable(b);},_getBucketDescription:function(d){var a=[500,1000,2000,3000,5000];var b=["half_s","1s","2s","3s","5s"];for(var c=0;c<a.length;c++)if(d<a[c])return b[c];return "over_5s";},reportLatency:function(b){if(this._reportedLatencies<5){var a=this._getBucketDescription(b);presence.warn("presence:latency_"+a+":delay="+b+",sent="+this._reportedLatencies);this._reportedLatencies++;}},_getIDsToNotifyVisibility:function(a){return keys(this.tabs);},handleVisibility:function(){for(var a in this.tabs)this.tabs[a].handleVisibility();},getHistory:function(b,a){a=a||false;if(!this.histories[b]&&a)this.histories[b]=[];return this.histories[b];},_renderServerTime12hr:function(d){var e=new Date();e.setTime(d+presence.timeSkew);var b=e.getHours();var a='am';if(b>=12){a='pm';b-=12;}if(b==0)b=12;var c=e.getMinutes();if(c<10)c='0'+c;var f=b+':'+c+a;return f;},_renderServerTime24hr:function(c){var d=new Date();d.setTime(c+presence.timeSkew);var a=d.getHours();if(a<10)a='0'+a;var b=d.getMinutes();if(b<10)b='0'+b;var e=a+':'+b;return e;},setSquelched:function(c){if(c){var a=(new Date()).valueOf();var b=a+this.jabberSquelchInterval;this._squelchUntil=b;presence.doSync();}else if(this._squelchUntil){this._squelchUntil=null;presence.doSync();}},isSquelched:function(){return this.getSquelchUntil()!==null;},setSquelchedTab:function(a,b){if(b){this._squelchedIds[a]=true;this.tabs[a]&&this.tabs[a].squelch();}else delete this._squelchedIds[a];},isSquelchedTab:function(a){return a in this._squelchedIds;},getSquelchUntil:function(){if(this._squelchUntil===null)return null;var a=(new Date()).valueOf();var b=a+(this.jabberSquelchInterval+5000);if(b<this._squelchUntil){this.setSquelched(false);return null;}else if(a<this._squelchUntil){return this._squelchUntil;}else{this.setSquelched(false);return null;}},createTab:function(h,c,e,b,f,d){var g;var a=window[this.controllers[h]];if(h==='group'){g=new a(this,c,e,f,d);}else g=new a(this,c,e,b,f,d);this.tabs[c]=g;this.tabList.push(g);this.numTabs++;Arbiter.inform('chat/conversation-opened',{id:c,conversation:g});return g;},_initVideoListeners:function(){VideoEvents.subscribe(VideoEvents.CALL_UNANSWERED,function(b,a){this._handleVideoEvent(a.idTarget,'unanswered-call',{time:presence.getTime()});}.bind(this));VideoEvents.subscribe(VideoEvents.CALL_INCOMING,function(b,a){this._handleVideoEvent(a.idTarget,'incoming-call',{profilePic:a.profilePic});}.bind(this));}};function chat_simple_popout(){window.open(presence.popoutURL,"fbChatWindow","status=0,toolbar=0,location=0,menubar=0,"+"directories=0,resizable=1,scrollbars=0,"+"width="+Presence.prototype.defWidth+",height="+Presence.prototype.defHeight+",left="+Presence.prototype.defX+",top="+Presence.prototype.defY);}
function ChatBuddyList(){this.inDock=!presence.inPopoutWindow;this.user=presence.user;this.shouldRender=true;this.shouldRetrieveAll=false;this.haveFullList=false;this.errorMode=false;this.shouldShowLoading=false;this.availableCount=0;this.availableList={};this.sortedList=[];this.listChanged=false;this.updateTime=0;this.flMode=false;this.flData={};this.otherFriendsFlid='-1';this.botsFlid='-2';this.showingErrorMessage=false;this.flSortableGroup=null;this.reorderingLists=false;this.flOpts={};this.externalFlids=[];this.updateOverlay={};this.justCameOnline=false;this.backgroundColor='#fff';}copy_properties(ChatBuddyList,{OVERLAY_ONLINE:0,OVERLAY_IDLE:1,OVERLAY_OFFLINE:-1,DEFAULT_OPTS:{fullDisplay:true,excludeIds:{}},MAX_BUDDY_NAME_LENGTH:20,BUDDY_LIST_INITIALIZED:'buddylist/initialized',BUDDY_CLICKED:'buddylist/buddy_clicked',AVAILABILITY_CHANGED:'buddylist/availability-changed',MAX_UPDATE_FAILURES:4});ChatBuddyList.mixin('Arbiter',{init:function(f,a,b,h,e,d,c,g){if(f){this.initNoRender(a,b,h,e,d,c,g);}else this.initFullList(b,h,e,d,c,g);},maxItemsToAnimate:10,highlightColor:'#fffbe2',expandAnimDuration:400,initError:function(){this.errorMode=true;this._init();},initNoRender:function(a,b,g,e,d,c,f){this.shouldRender=false;this.shouldShowLoading=true;this.availableCount=a;this.availableList=b;this.updateTime=g;this.listChanged=e;this.updateOverlay=f;this.flMode=d;this.flData=c;this._init();if(presence.inPopoutWindow)this._forceUpdate.bind(this,false).defer();},initFullList:function(a,f,d,c,b,e){this.availableList=a;this.updateTime=f;this.listChanged=d;this.haveFullList=true;this.flMode=c;this.flData=b;this.updateOverlay=e;this.availableCount=count(this.availableList);this._init();},_init:function(){this.loaded=false;this.poppedOut=presence.poppedOut;this.buddyListOpen=false;this.updateDiff=0;this.rendered=false;this.showingError=false;this.numRequestFailures=0;for(var a in this.availableList)this.availableList[a].i=this.availableList[a].i?1:0;if(this.inDock){this.tabDiv=$('fbDockChatBuddylistNub');this.wrapperDiv=DOM.find(this.tabDiv,'.fbChatBuddylist');this.contentDiv=DOM.find(this.wrapperDiv,'.fbChatBuddylistContent');this.buddyListError=DOM.find(this.wrapperDiv,'.fbChatBuddylistError');this.buddyCountSpan=DOM.find(this.tabDiv,'.label');}else{this.wrapperID='buddy_list';this.contentID='buddy_list_content';this.wrapperDiv=ge(this.wrapperID);this.contentDiv=ge(this.contentID);this.buddyListError=ge('buddy_list_error');this.buddyCountSpan=ge('buddy_count');}presenceCookieManager.register('bl',this._getCookieData.bind(this));presence.registerStateStorer(this._storeState.bind(this));presence.registerStateLoader(this._loadState.bind(this));Arbiter.subscribe(PresenceMessage.getArbiterMessageType('fl_settings'),this._handleFLMessage.bind(this));Arbiter.subscribe(ChatOptions.VISIBILITY_CHANGED,this._handleVisibility.bind(this));this.setCompactDisplay(chatOptions.getSetting('compact_buddylist'));this._loadState(presence.state);this._postInit.bind(this).defer();Arbiter.subscribe(Arbiter.LIST_EDITOR_LISTS_CHANGED,this._flManagerHandler.bind(this));Arbiter.subscribe('chat/option-changed',this._updateSetting.bind(this));},_postInit:function(){if(presence.inPopoutWindow)this._firstRender();this.updateDiff=this._computeUpdateTimeDiff();this._poller=new Poller(this.updateDiff*1000,this._serverUpdate.bind(this));this._mergeOverlay();Arbiter.inform(ChatBuddyList.BUDDY_LIST_INITIALIZED,this,Arbiter.BEHAVIOR_PERSISTENT);Arbiter.subscribe('presence/restarted',this._forceUpdate.shield(this));},_serverUpdateURI:'/ajax/chat/buddy_list.php',_serverUpdate:function(a){if(presence.isShutdown){this._poller.stop();return;}this.updateDiff=this._computeUpdateTimeDiff();this._poller.setTimePeriod(this.updateDiff*1000);a.setHandler(this._onUpdaterResponse.bind(this)).setErrorHandler(this._onUpdaterError.bind(this)).setTransportErrorHandler(this._onUpdaterError.bind(this)).setOption('suppressErrorAlerts',true).setOption('retries',1).setData({user:presence.user,popped_out:presence.poppedOut,available_list:this.haveFullList?this.availableList:{},force_render:this.shouldRender||this.shouldRetrieveAll}).setURI(this._serverUpdateURI).setAllowCrossPageTransition(true);},_storeState:function(a){a.blo=this.buddyListOpen?1:0;a.bvt=parseInt(this.buddyViewTime*.001);return a;},_loadState:function(c){this.buddyViewTime=verifyNumber(c.bvt)*1000;var b=!!c.blo;if(!presence.poppedOut&&this.poppedOut){this._showLoading();this._forceUpdate(false);}this.poppedOut=presence.poppedOut;var a=null;if(!this.poppedOut)if(b){a=Chat.openBuddyList;}else a=Chat.closeBuddyList;if(a)if(this.loaded){a();}else a.defer();this.loaded=true;},setCompactDisplay:function(a){this.isCompactDisplay=a;if(this.isCompactDisplay){this.itemHeight=18;}else this.itemHeight=22;if(this.rendered)this._render();},_handleVisibility:function(){if(Chat.isOnline()){this._showLoading();this._forceUpdate(true);this.justCameOnline=true;}},_handleFLMessage:function(c,a){var b=a.obj;this._forceUpdate(true);if(b.fl_mode)this._updateNames(b.fl_data);},_updateNames:function(b){for(var a in this.flData)if(typeof b[a]!='undefined'&&b[a].n!=this.flData[a].n){flname=b[a].n;elem=ge(this._getFriendListNameId(a));if(elem)DOM.setContent(elem,flname);}},_flChanged:function(b,a){return (b!=this.flMode||!are_equal(a,this.flData));},_massageNowAvailableList:function(h,g,f){for(var e in h){var a=h[e];if(g!=this.flMode){if(g){delete a.fl;}else{presence.error("buddylist:massage_fl_other1:id="+e);a.fl=[this.otherFriendsFlid];}}else{var c=a.fl||[];for(var d=0;d<c.length;d++){var b=c[d];if(typeof this.flData[b]=='undefined')a.fl.remove(b);}if(a.fl&&a.fl.length==0){presence.error("buddylist:massage_fl_other2:id="+e);a.fl=[this.otherFriendsFlid];}}h[e]=a;}return h;},_onFlChange:function(d,c){if(!this.rendered){this.flMode=d;this.flData=c;return;}var g=[];var h=[];var f=[];var e=[];if(this.flMode&&this.flMode==d){var b=this._groupAvailableListByFl(true);for(var a in c)if(typeof this.flData[a]=='undefined'){if(c[a].h)continue;g.push(a);f.push(a);}else if(this.flData[a].h!=c[a].h){if(c[a].h){h.push(a);}else{g.push(a);if(c[a].o)f.push(a);}}else if(this.flData[a].o!=c[a].o)if(c[a].o){f.push(a);}else e.push(a);for(var a in this.flData)if(typeof c[a]=='undefined')h.push(a);this.flMode=d;if(h.length!=0)this._removeFlidsFromBuddyList(h,b);if(e.length!=0)this._goOfflineToLists(e,true);this.flData=c;if(g.length!=0)this._addFlidsToDOM(g,b);if(f.length!=0)this._goOnlineToLists(f,true);}else if(this.flMode&&this.flMode!=d){var b=this._groupAvailableListByFl(true);h=keys(this.flData);this.flMode=d;this.flData=c;this._addFlidsToDOM([null]);this._removeFlidsFromBuddyList(h,b);}else if(!this.flMode&&this.flMode!=d){for(var a in c){if(c[a].h)continue;g.push(a);if(c[a].o)f.push(a);}this.flMode=d;this.flData=c;this._removeFlidsFromDOM([null]);if(g.length>0)this._addFlidsToDOM(g);if(f.length>0)this._goOnlineToLists.bind(this,f,true).defer();}},_addFlidsToDOM:function(e,f){f=f||this._groupAvailableListByFl(true);var a=this._getRenderedFriendLists();var c=a[0];var h=$('fbChatBuddyListParent');for(var g=0;g<e.length;g++){var d=e[g];if(this.flMode&&d){var b=DOM.create('div',{id:this._getFriendListId(d),className:this._getFriendListItemClasses(d,f)});DOM.setContent(b,HTML(this._renderFriendListHeader(d)));DOM.appendContent(b,HTML(this._renderFriendListContent(d,[])));if(c==d){DOM.prependContent(h,b);}else{var j=a.indexOf(d);var i=a[j-1];DOM.insertAfter(ge(this._getFriendListId(i)),b);}this._addFlSortable(d);}else DOM.prependContent(h,HTML(this._renderFriendListContent(null,[])));}this._addFriendListListeners(e);},_removeFlidsFromDOM:function(b){for(var c=0;c<b.length;c++){var a=b[c];if(a){if(ge(this._getFriendListId(a))){DOM.remove($(this._getFriendListId(a)));this._removeFlSortable(a);}}else{DOM.remove($(this._getAvailableMarkerId(a)));DOM.remove($(this._getIdleMarkerId(a)));}}},loadTypeahead:function(){if(this.inDock){this.typeahead=new ChatBuddyListTypeahead(DOM.find(this.tabDiv,'div.chat_buddylist_typeahead'),null,null,null,this);this.typeahead.subscribe(['search','reset'],this.contentChanged.bind(this));}else this.typeahead=new ChatBuddyListTypeahead($("buddy_list_typeahead_input"),$("buddy_list_typeahead"),null,null,this);},getContentWrapper:function(){return this.contentDiv.parentNode;},contentChanged:function(){this.inform('content-changed');},openTab:function(){if(this.buddyListOpen)return;if(!this.rendered){var a=this.availableList;this.availableList={};this.shouldShowLoading=true;this._firstRender();this.availableList=a;if(this._haveFullAvailabilityList()){this._render.bind(this).defer();setTimeout(this._availableListChanged.bind(this,true),10);}}this.buddyListOpen=true;setTimeout(this._openTabPostProcess.bind(this),50);},_haveFullAvailabilityList:function(){return this.haveFullList;},_openTabPostProcess:function(){this.buddyViewTime=(new Date()).getTime();var a=(presence.getTime()-this.updateTime)*.001;if(this.showingError||a>presence.sitevars.BUDDY_VIEW_FETCH_WINDOW)this._forceUpdate(false);presence.doSync();},closeTab:function(){if(!this.buddyListOpen)return;this.buddyListOpen=false;this._closeTabPostProcess.bind(this).defer(50);},_closeTabPostProcess:function(){if(!Chat.isOnline())return;this.typeahead&&this.typeahead.resetSearch(true);this.buddyViewTime=+new Date();presence.doSync();},_mergeOverlay:function(){var g=presence.getTime();var f={};var h=[];for(var e in this.updateOverlay)if(g<this.updateOverlay[e].exp){if(!ChatUserInfos[e]){presence.error("buddylist:overlay_no_user_info:id="+e);continue;}if(this.updateOverlay[e].ol!=ChatBuddyList.OVERLAY_OFFLINE){var a={};if(!this.availableList[e]){a.i=this.updateOverlay[e].ol;f[e]=a;presence.error("presence:ol_off_to_on:id="+e);}else{a.i=this.availableList[e].i;if(this.availableList[e].fl)if(this.availableList[e].fl.concat){a.fl=this.availableList[e].fl.concat();}else{var b=this.availableList[e].fl;presence.error('buddylist:avail_fl_concat:id='+e+',fl='+b);}}if(a.i!=this.updateOverlay[e].ol){a.i=this.updateOverlay[e].ol;f[e]=a;}if(this.flMode)if(this.updateOverlay[e].fl){var c=false;if(!a.fl||a.fl.length!=this.updateOverlay[e].fl.length){c=true;}else for(var d=0;!c&&d<a.fl.length;d++)c=a.fl[d]!=this.updateOverlay[e].fl[d];if(c){a.fl=this.updateOverlay[e].fl;f[e]=a;}}else if(!a.fl||a.fl.length===0){presence.error("buddylist:overlay_no_fl_info:id="+e);a.fl=[this.otherFriendsFlid];f[e]=a;}}else h.push(e);}else delete this.updateOverlay[e];if(!is_empty(f)||!is_empty(h))this._updateAvailableListWithDiff(f,h);},getAvailability:function(a){if(a==this.user)return Chat.isOnline();if(typeof this.availableList[a]!='undefined'){return this.availableList[a];}else return null;},getAvailableIds:function(){return keys(this.availableList);},setAvailable:function(c,b,d){var e=ChatBuddyList.OVERLAY_ONLINE;if(d){var a=this.getAvailability(c);if(a)e=a.i;}this._manageOverlay(c,{ol:e,fl:b});this._mergeOverlay();},setFlids:function(b,a){if(!a)return;if(!this.getAvailability(b))return;if(this.availableList[b].fl[0]==this.otherFriendsFlid){var c={};c[b]=this.availableList[b];c[b].fl=a;this._updateAvailableListWithDiff(c,[],this.otherFriendsFlid);}},setUnavailable:function(a){this._manageOverlay(a,{ol:ChatBuddyList.OVERLAY_OFFLINE,fl:null});this._removeFromBuddyList([a]);},_removeFromBuddyList:function(d,a){var e=[];for(var b=0;b<d.length;b++){var c=d[b];if(!this.getAvailability(c))continue;e.push(c);}if(e.length>0)this._updateAvailableListWithDiff({},e,a);},addOverlayInfo:function(b){for(var a in b)this._manageOverlay(a,b[a]);this._mergeOverlay();},_manageOverlay:function(b,c){var a=presence.getTime()+60000;this.updateOverlay[b]={ol:c.ol,fl:c.fl,exp:a};if(this.rendered)presenceCookieManager.store();},hideBuddy:function(c,a){var b;if(a){b=[a];}else b=this._getUserFlids(c,null,true);this._toggleBuddy(c,false,b);},_toggleBuddy:function(c,e,b){var d,a;var f=function(g){d=ge(this._getBuddyListItemId(c,g));d&&CSS.conditionShow(d,e);if(e&&(a=ge(this._getFriendListId(g))))CSS.removeClass(a,'suppress');}.bind(this);b.length?b.forEach(f):f(null);},showBuddyItem:function(d,e,a){e=e||false;var b;if(a){b=[a];}else{var b=this._getUserFlids(d,null,true);if(b.length>1&&!e){var c=b.slice(1);this._toggleBuddy(d,false,c);b=[b[0]];}}this._toggleBuddy(d,true,b);},getBuddyItem:function(b,a){a=this._getUserFlid(b,a);return ge(this._getBuddyListItemId(b,a));},getBuddyItemName:function(b,a){a=this._getUserFlid(b,a);return ge(this._getBuddyListItemNameId(b,a));},updateBuddyItemName:function(b,a){var c=ChatUserInfos[b];this.getBuddyItemName(b,a).innerHTML=this.shortenedBuddyName(c.name);},_getUserFlid:function(c,a){if(a===null||a===undefined){var b=this._getUserFlids(c);a=b[0];}return a;},showEmptySearch:function(a){show(this._getEmptySearchId(a));},hideEmptySearch:function(a){hide(this._getEmptySearchId(a));},_getSortedList:function(){if(this.sortedList.length==0&&count(this.availableList)==this.availableCount)this.sortedList=this._sort(keys(this.availableList));return this.sortedList;},_pruneUsersWithoutDisplayInfo:function(a){for(var b in a)if(!ChatUserInfos[b])delete a[b];},getSortedListUI:function(a){if(!a&&this.flMode){var b=this._groupAvailableListByFl(true);var c=[];for(var a in b)c=c.concat(b[a]);var d={};return c.filter(function(e){return !d[e]&&(d[e]=true);});}return this._getSortedList();},getFriendLists:function(){var a={};copy_properties(a,this.flData);delete a[this.otherFriendsFlid];delete a[this.botsFlid];return a;},getAvailableCount:function(){return this.availableCount;},_getRenderedFriendLists:function(){var b=[];for(var a in this.flData)if(!this.flData[a].h)b.push(a);return b;},_getFriendListsInChat:function(){var a=this._getRenderedFriendLists();a.remove(this.otherFriendsFlid);a.remove(this.botsFlid);return a;},suppressNonFriendInfoInBuddyList:function(a){this._updateNonFriendInfoInBuddyList(a,true);},unsuppressNonFriendInfoInBuddyList:function(a){this._updateNonFriendInfoInBuddyList(a,false);},_updateNonFriendInfoInBuddyList:function(b,f){var c=b?[b]:this._getGlobalFlids(true);var e,a;for(var d=0;d<c.length;d++){var b=c[d];if(e=ge(this._getIdleMarkerId(b)))CSS.conditionClass(e,'suppress',f);if(b&&(a=ge(this._getFriendListId(b))))CSS.conditionClass(a,'suppress',f);}},_updateCount:function(){Arbiter.inform('buddylist/count-changed',this.availableCount);},_getCookieData:function(){var a={};for(var c in chatDisplay.tabs)if(this.availableList[c]){a[c]=copy_properties({},this.availableList[c]);delete a[c].fl;}var b={ac:this.availableCount,ut:parseInt(this.updateTime*.001),ud:parseInt(this.updateDiff),lc:this.listChanged?1:0};if(!is_empty(this.updateOverlay))b.uo=this.updateOverlay;if(!is_empty(a))b.al=a;return b;},_computeUpdateTimeDiff:function(){if(!Chat.isOnline()||(presence.poppedOut&&!presence.inPopoutWindow))return Math.round(presence.sitevars.BUDDY_MAX_TIME);var d=presence.sitevars.BUDDY_BASE_TIME;var e=presence.getTime();if(!chatDisplay.everSentMessage)d+=presence.sitevars.BUDDY_COST_NEVER_SENT_MESSAGE;if(!this.listChanged)d+=presence.sitevars.BUDDY_COST_NO_LIST_CHANGE;if(chatTabSlider.numTabs==0)d+=presence.sitevars.BUDDY_COST_NO_CHAT_TABS;var b=(e-chatDisplay.chatActivityTime)/60000;if(b>presence.sitevars.BUDDY_MAX_ACTIVITY_MINS)b=presence.sitevars.BUDDY_MAX_ACTIVITY_MINS;d+=(presence.sitevars.BUDDY_COST_CHAT_ACTIVITY/presence.sitevars.BUDDY_MAX_ACTIVITY_MINS)*b;if(!presence.poppedOut){var f=(e-presence.pageLoadTime)/60000;if(f<b){if(f>presence.BUDDY_MAX_ACTIVITY_MINS)f=presence.BUDDY_MAX_ACTIVITY_MINS;d+=(presence.sitevars.BUDDY_COST_PAGE_ACTIVITY/presence.sitevars.BUDDY_MAX_ACTIVITY_MINS)*f;}if(!this.buddyListOpen){var a=(e-this.buddyViewTime)/60000;if(a>presence.sitevars.BUDDY_MAX_ACTIVITY_MINS)a=presence.sitevars.BUDDY_MAX_ACTIVITY_MINS;d+=(presence.sitevars.BUDDY_COST_VIEW_ACTIVITY/presence.sitevars.BUDDY_MAX_ACTIVITY_MINS)*a;}}if(!d||d>presence.sitevars.BUDDY_MAX_TIME)d=presence.sitevars.BUDDY_MAX_TIME;var c=presence.sitevars.BUDDY_MIN_TIME||20;d=Math.max(c,d);return Math.round(d);},_forceUpdate:function(a){this.shouldRender=true;this._poller.requestNow();},forceRetrieveAll:function(a){this.shouldRetrieveAll=a;},updateUserInfos:function(a){copy_properties(ChatUserInfos,a);},_collapseItem:function(f,a,g,c){if(this.flMode&&c){var d=[c];}else var d=this._getUserFlids(f,a);for(var e=0;e<d.length;e++){var c=d[e];var b=ge(this._getBuddyListItemId(f,c));if(b){b.id=this._getBuddyListWasItemId(f,c);if(g)animation(b).to('height','0px').duration(this.expandAnimDuration).go();}}},_expandItem:function(d,c,h,e,i,j,k){var b=ge(this._getBuddyListItemId(d,c));if(!b){var b=HTML(this._renderItem(d,c,e)).getRootNode();}else if(e)CSS.addClass(b,'idle');var f=this.itemHeight;var g=this._getFlOpts(c);if(!g.fullDisplay)f=18;if(!i){b.style.height=f+'px';DOM.insertAfter(h,b);}else{b.style.height='0px';DOM.insertAfter(h,b);var a=animation(b);if(j)a.duration(this.expandAnimDuration+500).checkpoint();a.from('height','0').to('height',f+'px').duration(this.expandAnimDuration);if(k===undefined)k=!e;if(k){b.style.backgroundColor=this.highlightColor;a.checkpoint().duration(3000).checkpoint().to('backgroundColor',this.backgroundColor).duration(500);}a.go();}return b;},_clearWasAvailableItems:function(g,h,b){if(!this.rendered)return;for(var d=0;d<g.length;d++){var e=g[d];if(h[e]){if(this.flMode&&b){var c=[b];}else var c=this._getUserFlids(e,h[e]);for(var f=0;f<c.length;f++){var a=ge(this._getBuddyListWasItemId(e,c[f]));if(a){DOM.remove(a);delete a;}}}}this._showBuddyListEmptyItem();},_showBuddyListEmptyItem:function(){var a=ge(this._getBuddyListEmptyItemId());if(a)CSS.conditionClass(a,'hide_empty_item',this.availableCount!=0);},_hideBuddyListEmptyItem:function(){var a=ge(this._getBuddyListEmptyItemId());if(a)CSS.addClass(a,'hide_empty_item');},_updateAvailableListWithDiff:function(w,ze,j){if(this.stopUpdates)return;var r,t;var zb=false;var zf={};var zg={};var i=(j!=null);this._pruneUsersWithoutDisplayInfo(w);for(var q=0;q<ze.length;q++){var zd=ze[q];if(this.availableList[zd]){zb=true;zf[zd]=this.availableList[zd];if(j&&this.flMode&&this.availableList[zd].fl.length>1){this.availableList[zd].fl.remove(j);zg[zd]=1;continue;}delete this.availableList[zd];}}this._hideBuddyListEmptyItem();var v=keys(w);var za=!j&&!this.showingError&&!presence.isSafari2&&(ze.length+v.length<this.maxItemsToAnimate);if(this.rendered){for(var q=0;q<ze.length;q++)if(zf[ze[q]])this._collapseItem(ze[q],zf[ze[q]],za,j);var c=za?this.expandAnimDuration:0;setTimeout(this._clearWasAvailableItems.bind(this,ze,zf,j),c);}var b=this.sortedList;if(this.haveFullList)this.sortedList=[];this._sort(v,w);var u=v.shift();var a=b.shift();var d=this._compareFunction.bind(this,null);var e={},z={},x={},o={},p={};var n=[];if(this.shouldRender){n=this._getGlobalFlids();for(var q=0;q<n.length;q++){var j=n[q];e[j]=x[j]=this._getAvailableMarkerId(j);z[j]=this._getIdleMarkerId(j);o[j]=p[j]=false;}}var g=false;var k=function(zi,zh,zj){var zk=this._getBuddyListItemId(zi,zh);if(zj){z[zh]=zk;}else x[zh]=zk;o[zh]=o[zh]||zj;p[zh]=p[zh]||!zj;};var l=k.bind(this);while(true){if(a&&zf[a]&&!zg[a]){a=b.shift();continue;}if(a&&u){if(a==u){a=b.shift();continue;}if(d(a,u,this.availableList[a].i,w[u].i)<0){r=a;}else r=u;}else if(a){r=a;}else if(u){r=u;}else break;if(r==a){a=b.shift();t=this.availableList[r].i;if(this.shouldRender){var m=this._getUserFlids(r);for(var q=0;q<m.length;q++)l(r,m[q],t);}}else{u=v.shift();if(this.shouldRender&&this.availableList[r]){var zc=this._getUserFlids(r,this.availableList[r],i);for(var q=0;q<zc.length;q++){var j=zc[q];var h=ge(this._getBuddyListItemId(r,j));if(h)DOM.remove(h);}}this.availableList[r]=w[r];if(this.shouldRender){t=w[r].i;var m=this._getUserFlids(r,null,i);for(var q=0;q<m.length;q++){var j=m[q];var y=t?ge(z[j]):ge(x[j]);if(!y)y=ge(e[j]);if(y)this._expandItem(r,j,y,t,za,zb);g=true;l(r,j,t);}}}if(this.haveFullList)this.sortedList.push(r);}if(this.shouldRender){for(var q=0;q<n.length;q++){var j=n[q];var s=ge(this._getIdleMarkerId(j));if(s)if(o[j]&&p[j]){CSS.removeClass(s,'hide_idle_marker');}else CSS.addClass(s,'hide_idle_marker');}var f=0;if(za){if(g)f+=this.expandAnimDuration;if(zb){f+=this.expandAnimDuration;if(g)f+=500;}}setTimeout(this.contentChanged.bind(this),f);this._resetFlidClasses();}this._availableListChanged();},shortenedBuddyName:function(a){chat_name=(a.length>ChatBuddyList.MAX_BUDDY_NAME_LENGTH)?a.substring(0,ChatBuddyList.MAX_BUDDY_NAME_LENGTH-2)+'...':a;return (htmlize(chat_name));},_sort:function(c,a){a=a||this.availableList;this._pruneUsersWithoutDisplayInfo(this.availableList);var b=this._compareFunction.bind(this,a);c.sort(b);return c;},_compareFunction:function(a,b,e,c,f){if(typeof c=='undefined')c=a[b].i;if(typeof f=='undefined')f=a[e].i;if(c^f)return c?1:-1;var d=ChatUserInfos[b].name.toLowerCase();var g=ChatUserInfos[e].name.toLowerCase();return (d<g)?-1:1;},_availableListChanged:function(){if(this.haveFullList)this.availableCount=count(this.availableList);for(var a in this.availableList)this.availableList[a].i=this.availableList[a].i?1:0;if(this.rendered)presenceCookieManager.store();this.contentChanged();this._updateCount();Arbiter.inform(ChatBuddyList.AVAILABILITY_CHANGED,{sender:this,justCameOnline:this.justCameOnline,haveFullList:this.haveFullList});this.justCameOnline=false;},_onUpdaterResponse:function(h){var g=h.getPayload();var a=g.buddy_list;if(!a)this._onUpdaterError(h);presence.updateServerTime(g.time);var i=presence.getTime();this.numRequestFailures=0;if(this.shouldRender&&!a.forcedRender)return;this.updateTime=i;if(!Chat.isOnline()||this.stopUpdates)return;var c=this.haveFullList;var b=this._flChanged(a.flMode,a.flData);var f=is_empty(a.nowAvailableList);this.errorMode=false;this._hideError();this.listChanged=a.listChanged;this.updateUserInfos(a.userInfos);if(!((c&&b)||f)){this.flMode=a.flMode;this.flData=a.flData;}if(this.shouldRender){this.haveFullList=true;if(!this.rendered)this._firstRender();}else{this.availableCount=a.availableCount;this._updateCount();}if(!c||a.wasAvailableIDs.length||!f){for(var e in this.updateOverlay)if(i<this.updateOverlay[e].exp){if(c||!this.availableList[e]){delete a.nowAvailableList[e];}else a.nowAvailableList[e]=this.availableList[e];for(var d=0;d<a.wasAvailableIDs.length;d++)if(e==a.wasAvailableIDs[d]){a.wasAvailableIDs.splice(d,1);break;}}else delete this.updateOverlay[e];if(c){if(b&&!f)a.nowAvailableList=this._massageNowAvailableList(a.nowAvailableList,a.flMode,a.flData);this._updateAvailableListWithDiff(a.nowAvailableList,a.wasAvailableIDs);if(b)this._onFlChange(a.flMode,a.flData);}else{this.availableList=a.nowAvailableList;this._availableListChanged(true);if(this.shouldRender)this._render();}}else{this._availableListChanged.bind(this).defer();if(b&&f)this._onFlChange(a.flMode,a.flData);}presenceCookieManager.store();},_onUpdaterError:function(a){if(presence.checkMaintenanceError(a))return;this.numRequestFailures++;if(this.numRequestFailures>=ChatBuddyList.MAX_UPDATE_FAILURES){this.availableCount=0;this._updateCount();this._updateAvailableListWithDiff({},keys(this.availableList));this._showLoadError();}},itemOnClick:function(c){var b=DataStore.get(c,'id');var a=DataStore.get(c,'flid');presence.pauseSync();chatDisplay.focusTab(b,true);if(!this.isSticky())Chat.closeBuddyList();if(this.typeahead)this.typeahead.resetSearch(true);!function(){Arbiter.inform(ChatBuddyList.BUDDY_CLICKED,{flid:a,id:b});}.defer();presence.resumeSync();},_renderItem:function(d,b,e){var j=ChatUserInfos[d];var g=this.shortenedBuddyName(j.name);var i=j.thumbSrc;var a='';if(e)a=_tx("Inactivo");var f=['<a',' href="#"',' id="',this._getBuddyListItemId(d,b),'"',' class="clearfix friend',(e?' idle':''),'"',' title="',a,'"',' data-id="',parseInt(d,10),'"',' data-flid="',b,'"','>'];var c=!this.isCompactDisplay;var h=this._getFlOpts(b);c&=h.fullDisplay;if(c)f=f.concat('<img src="',i,'" width="22px" height="22px" />');f=f.concat('<span id="',this._getBuddyListItemNameId(d,b),'">',g,'</span>','</a>');return f.join('');},_groupAvailableListByFl:function(e,a){if(!this.flMode||!this.flData)return null;e=e||false;a=a||false;var h={};for(var b in this.flData)h[b]=[];if(a)return h;var c=function(l){var k=this.availableList[l]&&this.availableList[l].fl;if(k)for(var m=0;m<k.length;++m){var j=k[m];h[j].push(l);}};var d=c.bind(this);if(e){var i=this._getSortedList();for(var f=0;f<i.length;f++)d(i[f]);}else for(var g in this.availableList)d(g);return h;},_listNameInUse:function(b){for(var a in this.flData)if(this.flData[a].n==b)return true;return false;},keyPressNewListInput:function(b){if(Event.getKeyCode(b)==KEYS.RETURN){var b=$E(b);var c=b.getTarget().value;if(this._listNameInUse(c)){ErrorDialog.show(_tx("Un error ha ocurrido."),_tx("No puedes tener dos listas con el mismo nombre. Crea un nombre distinto para esta lista."));return;}var a={create:c};this._saveBuddyListSetting(a,function(){for(var d in this.flData)if(this.flData[d].n==c){Vector2.scrollIntoView($(this._getFriendListId(d)));break;}}.bind(this));return b.kill();}},handleFlInChat:function(b,a){if(b){this._unHideFriendListFromChat(a);}else this._hideFriendListFromChat(a);},_unHideFriendListFromChat:function(b){var d=this._getFriendListsInChat().length==0;var c=[b];var a={unhide_from_chat:1,flids:c};this.flData[b].h=0;this._saveBuddyListSetting(a,function(){this._showEmptyListMomentarily(b);Vector2.scrollIntoView($(this._getFriendListId(b)));}.bind(this));if(d){this._onFlChange(true,this.flData);}else this._addFlidsToDOM(c);},_hideFriendListFromChat:function(b){var d=this._getFriendListsInChat().length==1;var c=[b];var a={hide_from_chat:1,flids:c};this.flData[b].h=1;this._saveBuddyListSetting(a);if(d){this._onFlChange(false,this.flData);}else this._removeFlidsFromBuddyList(c);},_friendListHandleSwitchThrown:function(b){var a=this.flData[b].o;if(a){this._goOfflineToLists([b]);}else this._goOnlineToLists([b]);},_friendListHandleSwitchMouseDown:function(b){var a=Event.listen(document,'mouseup',function(){a.remove();this._friendListHandleSwitchThrown(b);}.bind(this));},_friendListHandleMouseOver:function(a){if(this.reorderingLists)return;CSS.addClass($(this._getFriendListId(a)),'hover');},_friendListHandleMouseOut:function(a){CSS.removeClass($(this._getFriendListId(a)),'hover');},_saveBuddyListSetting:function(b,a){b.user=this.user;a=a||bagofholding;new AsyncRequest().setData(b).setURI('/ajax/chat/buddy_list_settings.php').setHandler(this._onBuddyListSettingSave.bind(this,a)).setAllowCrossPageTransition(true).send();},_goOnlineToLists:function(b,d){d=d||false;var a={online_to_list:1,flids:b,read_only:d};var c=chatDisplay._getIDsToNotifyVisibility(true);if(c)a.notify_ids=c;this._handleFlVisibilityChange(b,1);this._saveBuddyListSetting(a);},_handleFlVisibilityChange:function(d,f,a){for(var e=0;e<d.length;e++){var c=d[e];var b=ge(this._getFriendListId(c));if(!b)continue;this.flData[c].o=f;if(f){CSS.addClass(b,'online');CSS.removeClass(b,'offline');if(c==this.otherFriendsFlid)this._showEmptyListMomentarily(c);}else{CSS.addClass(b,'offline');CSS.removeClass(b,'online');}var g=DOM.find(b,'div.titletip strong');DOM.setContent(g,this._getFriendListTooltipText(c));a&&a(c);}},_showEmptyListMomentarily:function(b){this.shownEmptyFlids=this.shownEmptyFlids||{};this.shownEmptyFlids[b]=1;var a=ge(this._getFriendListId(b));if(a)CSS.addClass(a,'show_empty_list');(function(){delete this.shownEmptyFlids[b];var c=ge(this._getFriendListId(b));if(c)CSS.removeClass(c,'show_empty_list');}).bind(this).defer(8000);},_goOfflineToLists:function(b,e){e=e||false;var c=this._groupAvailableListByFl();this._handleFlVisibilityChange(b,0,function(f){var g=c[f];this._removeFromBuddyList(g,f);}.bind(this));if(!e){var a={offline_to_list:1,flids:b};var d=chatDisplay._getIDsToNotifyVisibility(true);if(d)a.notify_ids=d;this._saveBuddyListSetting(a);}},_removeFlidsFromBuddyList:function(c,d){d=d||this._groupAvailableListByFl(true);if(!d)return;var i={};for(var e=0;e<c.length;e++){var b=c[e];var g=d[b];if(!g)continue;for(var h=0;h<g.length;h++){var f=g[h];var a={};a.i=this.availableList[f].i;a.fl=this.availableList[f].fl.clone();if(this.flMode){a.fl.remove(b);if(a.fl.length==0&&this.flData[this.otherFriendsFlid].o)a.fl.push(this.otherFriendsFlid);}else delete a.fl;i[f]=a;}}if(!is_empty(i))this._updateAvailableListWithDiff(i,[]);this._removeFlidsFromDOM(c);},_onBuddyListSettingSave:function(b,a){var e=a.getPayload();if(e){if(e.availableList){this.updateUserInfos(e.userInfos);var d;if(e.flids&&e.flids.length==1)d=e.flids[0];this._updateAvailableListWithDiff(e.availableList,[],d);}if(e.flData){var c;if(typeof e.flMode!='undefined'){c=e.flMode;}else c=true;this._onFlChange(c,e.flData);this._resetFlidClasses();}b&&b();}},_flManagerHandler:function(b,a){},_resetFlidClasses:function(){if(!this.flMode)return;var c=this._groupAvailableListByFl();for(var b in this.flData){var a=ge(this._getFriendListId(b));if(a)CSS.setClass(a,this._getFriendListItemClasses(b,c));}},_getFriendListItemClasses:function(b,e){var d=this.flData[b].o;var c=this.flData[b].h;var a=['friend_list'];if(d){a.push('online');}else a.push('offline');if(!c&&this.shownEmptyFlids&&this.shownEmptyFlids[b])a.push('show_empty_list');if(is_empty(e[b]))if(this.availableCount!=0&&(this.flData[b].c==0||b==this.otherFriendsFlid))a.push('empty_friend_list');if(b==this.otherFriendsFlid){a.push('compact_friend_list');a.push('other_friends_list');}if(this.reorderingLists&&(b==this.otherFriendsFlid||b==this.botsFlid))a.push('suppress');return a.join(' ');},_renderFriendListHeader:function(c){var b=this.flData[c].n;var e=this.flData[c].o;var a='';var f=typeof this.flData[c].s!='undefined';if(!f&&c!=this.otherFriendsFlid)var a='<a href="/friends/ajax/edit_list.php?list_id='+c+'" '+'rel="dialog-post">'+_tx("Editar")+'</a>';var d=['<div class="friendlist_name">','<span class="title"><a href="#" id="'+this._getFriendListNameId(c)+'">',htmlize(b),'</a></span>','<span class="edit_link">',a,'</span>','</div>'];if(!f)d.push('<div class="switch"><a class="online_status" ','>','<div class="titletip"><strong>',this._getFriendListTooltipText(c),'</strong></div>','</a>','</div>');return d.join('');},_getFriendListTooltipText:function(a){return this.flData[a].o?_tx("Desconectar"):_tx("Conectar");},registerExternalFriendList:function(b){if(!this.rendered)this._firstRender();var a='xfl_'+this.externalFlids.length;this.externalFlids.push(a);this.flOpts[a]=b;return a;},_renderFriendListContent:function(a,i){var l;var d=this.flMode&&a;if(d){l=['<div id="',this._getFriendListContainerId(a),'"','class="friend_list_container">'];}else l=[];l.push('<div id="',this._getAvailableMarkerId(a),'" class="suppress"></div>');var g=[];var b=false,c=false;for(var k=0;k<i.length;k++){var e=i[k];var f=this._isIdle(e);var j=[this._renderItem(e,a,f)];if(f){b=true;g=g.concat(j);}else{c=true;l=l.concat(j);}}var h=(b&&c)?'':' hide_idle_marker';l.push('<div id="',this._getIdleMarkerId(a),'" class="subheader',h,'"></div>');l=l.concat(g);if(d)l.push('</div>');return l.join('');},_isIdle:function(a){return !!this.availableList[a]&&!!this.availableList[a].i;},_addFriendListListeners:function(c){if(!this.flMode)return;c=c||this._getRenderedFriendLists();for(var d=0;d<c.length;d++){var b=c[d];if(typeof this.flData[b].s!='undefined')continue;var a=$(this._getFriendListId(b));Event.listen(a,'mouseover',this._friendListHandleMouseOver.bind(this,b));Event.listen(a,'mouseout',this._friendListHandleMouseOut.bind(this,b));var e=DOM.find(a,'a.online_status');Event.listen(e,'mousedown',this._friendListHandleSwitchMouseDown.bind(this,b));}},_renderBuddyContent:function(){var a=(this.availableCount?'hide_empty_item':'');var g=['<div class="subgroup">',this.renderEmptySearch(),'<div id="fbChatBuddyListParent" class="list_select">','<div id="',this._getBuddyListEmptyItemId(),'" class="info_text ',a,'">',_tx("No hay nadie disponible para chatear."),'</div>'];var c;var d={};if(this.flMode){c=keys(this.flData);d=this._groupAvailableListByFl(true);}else c=[null];for(var e=0;e<c.length;++e){var b=c[e];var f=[];if(this.flMode&&b){if(this.flData[b].h)continue;g.push('<div id="',this._getFriendListId(b),'"','class="',this._getFriendListItemClasses(b,d),'">',this._renderFriendListHeader(b));f=d[b];}else f=this._getSortedList();g.push(this._renderFriendListContent(b,f));if(this.flMode&&b)g.push('</div>');}g.concat(['</div>','</div>']);return g.join('');},renderEmptySearch:function(a){var b='<div id="'+this._getEmptySearchId(a)+'" class="info_text" style="display:none">'+_tx("Friend not found on chat.")+'</div>';return b;},_render:function(){this._getSortedList();CSS.conditionClass(this.contentDiv,'compact',this.isCompactDisplay);var a=this._renderBuddyContent();if(this.rendered)CSS.addClass(this.contentDiv,'hidden');this.contentDiv.innerHTML=a;if(this.rendered){CSS.addClass(this.wrapperDiv,'presence_menu_offscreen');this._hideError();CSS.removeClass(this.contentDiv,'hidden');this.contentChanged();CSS.removeClass(this.wrapperDiv,'presence_menu_offscreen');this._addFriendListListeners();}if(this.errorMode)this._showLoadError();if(this.shouldShowLoading){this._showLoading();this.shouldShowLoading=false;}},_firstRender:function(){this._render();this.rendered=true;Event.listen(this.contentDiv,'click',function(event){var a=Parent.byClass(event.getTarget(),'friend');a&&this.itemOnClick(a);}.bind(this));this.loadTypeahead();},updateItemDisplay:function(d){var a=this.availableList[d];if(!a)return;var f=this._getUserFlids(d);for(var c=0;c<f.length;c++){var b=f[c];var e=ge(this._getBuddyListItemId(d,b));if(!e)return;e=HTML(this._renderItem(d,b,a.i)).getRootNode();}},_showLoadError:function(){this._showError(_tx("No se pudieron cargar los amigos disponibles."));},_showLoading:function(){this._showError(_tx("Cargando..."));},_hideError:function(){this.showingError=false;CSS.removeClass(this.wrapperDiv,'error');},_showError:function(a){this.showingError=true;DOM.setContent(this.buddyListError,HTML(a));CSS.addClass(this.wrapperDiv,'error');},isSticky:function(){return chatOptions.getSetting('sticky_buddylist');},enterErrorMode:function(a){this.exitErrorMode();this.exitReorderingFlMode();this.showingErrorMessage=true;var b=$N('div',{id:'error_fl_alert'},[$N('span',{className:'helper_text'},a),$N('input',{type:'button',className:'inputbutton',value:_tx("Aceptar"),onclick:this.exitErrorMode.bind(this)})]);DOM.insertBefore(b,this.contentDiv);},exitErrorMode:function(){if(this.showingErrorMessage){DOM.remove($('error_fl_alert'));this.showingErrorMessage=false;}return false;},enterReorderingFlMode:function(){if(this.reorderingLists)return;this.exitErrorMode();this.reorderingLists=true;CSS.addClass(this.wrapperDiv,'reorder_fl');var a=this._getRenderedFriendLists();this.flSortableGroup=new SortableGroup();for(var c=0;c<a.length;c++){var b=a[c];if(b==this.otherFriendsFlid||b==this.botsFlid){CSS.addClass(this._getFriendListId(b),'suppress');}else this._addFlSortable(b);}var d=$N('div',{id:'reorder_fl_alert'},[$N('span',{className:'helper_text'},_tx("Arrastra las listas para ordenarlas")),$N('input',{type:'button',className:'inputbutton',value:_tx("Finalizar"),onclick:this.exitReorderingFlMode.bind(this)})]);DOM.insertBefore(d,this.contentDiv);this.contentChanged();},exitReorderingFlMode:function(){if(!this.reorderingLists)return;this._reorderFlids();DOM.remove($('reorder_fl_alert'));CSS.removeClass(this.wrapperDiv,'reorder_fl');var a=this._getRenderedFriendLists();for(var c=0;c<a.length;c++){var b=a[c];if(b==this.otherFriendsFlid||b==this.botsFlid){CSS.removeClass(this._getFriendListId(b),'suppress');}else this._removeFlSortable(b);}this.reorderingLists=false;this.flSortableGroup.destroy();this.flSortableGroup=null;this.contentChanged();},_addFlSortable:function(a){if(this.flSortableGroup!=null)this.flSortableGroup.addSortable(a,$(this._getFriendListId(a)));},_removeFlSortable:function(a){if(this.flSortableGroup!=null)this.flSortableGroup.removeSortable(a);},_reorderFlids:function(){var a={reorder:1,flids:this.flSortableGroup.getOrder()};this._saveBuddyListSetting(a);},_getGlobalFlids:function(a){var b=this.flMode&&this.flData?keys(this.flData):[null];return a?b:b.concat(this.externalFlids);},_getUserFlids:function(d,a,b){a=a||this.availableList[d];var c=a.fl?a.fl:[null];if(!b)c=this._addExternalFlids(d,c);return c;},_addExternalFlids:function(e,c){try{c=c.concat();}catch(a){presence.error("buddylist:flid_concat: flid = "+c+", error = "+a);}for(var d=0;d<this.externalFlids.length;d++){var b=this.externalFlids[d];var f=this._getFlOpts(b);if(!f.excludeIds[e])c.push(b);}return c;},_getFlOpts:function(a){return this.flOpts[a]||ChatBuddyList.DEFAULT_OPTS;},_getAvailableMarkerId:function(a){return this._encodeFlid('buddy_list_avail_marker',a);},_getIdleMarkerId:function(a){return this._encodeFlid('buddy_list_idle_marker',a);},_getEmptyListDropZoneId:function(a){return this._encodeFlid('buddy_list_drop_zone',a);},_getBuddyListItemId:function(b,a){return this._encodeFlid('buddy_list_item_'+b,a);},_getBuddyListItemNameId:function(b,a){return this._encodeFlid('buddy_list_item_name_'+b,a);},_getBuddyListWasItemId:function(b,a){return this._encodeFlid('buddy_list_was_item_'+b,a);},_getEmptySearchId:function(a){return this._encodeFlid('buddy_list_empty_search',a);},_getBuddyListEmptyItemId:function(){return 'buddy_list_empty_item';},_encodeFlid:function(a,b){return b?(b+'_'+a):a;},_getFriendListId:function(a){return this._encodeFlid('friend_list_item',a);},_getFriendListNameId:function(a){return this._encodeFlid('friend_list_name',a);},_extractFlid:function(a){return a.split('_').shift();},_getFriendListContainerId:function(a){return this._encodeFlid('friend_list_container',a);},debugPrintUpdateOverlay:function(){var b=this.updateOverlay;for(var a in b);},updateAvailability:function(){this._forceUpdate(false);},_updateSetting:function(event,a){switch(a.name){case 'compact_buddylist':this.setCompactDisplay(a.value);break;}}});
var NewHigh={reset:function(){this.initialized=false;},ensureInitialized:function(){if(this.initialized)return;this.button=DOM.scry(document.body,'a.stream_header_button')[0];this.composer=DOM.scry(document.body,'div.UIComposer')[0];this.buttonArea=DOM.scry(this.composer,'div.UIComposer_ButtonArea')[0];this.initialized=true;},showComposer:function(a){this.ensureInitialized();if(this.composer){CSS.show(this.composer);UIComposer.focusInstance(this.composer.id);var b=UIComposer.getInstance(this.composer.id);b&&b.loadAttachment(parseInt(a,10));}this.button&&CSS.hide(this.button);},hideComposer:function(b){this.ensureInitialized();if(this.composer){var a=UIComposer.getInstance(this.composer.id);if(!b){a&&a.initialized&&a.blur();CSS.hide(this.composer);this.button&&CSS.show(this.button);}else{a&&a.initialized&&a.loadAttachment(0);CSS.show(this.composer);this.buttonArea&&CSS.hide(this.buttonArea);}}}};
function HomeSideNav(){this.parent.construct(this);}HomeSideNav.extend('SideNav');HomeSideNav.STATUS_UPDATE_APP_ID=2915120374;HomeSideNav.ajaxPipeEndpoints={'/ajax/home/feed.php':true,'/ajax/home/group.php':true,'/ajax/home/questions.php':true};HomeSideNav.prototype={init:function(c,a,b,d){this.parent.init(c,a,b,d);this.path=this.equivalentPath(URI.getRequestURI().getPath());this.shouldFocusComposer=false;Arbiter.subscribe(NavigationMessage.PREFETCH,this.prefetch.bind(this));Arbiter.subscribe(NavigationMessage.INTERNAL_LOADING_BEGIN,this.internalLoadNotify.bind(this));Arbiter.subscribe(NavigationMessage.INTERNAL_LOADING_COMPLETED,this.internalLoadNotify.bind(this));},equivalentPath:function(a){return (a=='/home.php')?'/':a;},resolveKey:function(a,b){if(b.getPath()=='/games'||b.getPath()=='/games/'){a='games';}else if(this.path!=this.equivalentPath(b.getPath())||this.domain!=b.getDomain())return false;return a;},handlePageTransition:function(c,b){var a=this.getEndpoint(b);if(HomeSideNav.ajaxPipeEndpoints[a])c.ap=1;var d=null;if(window.UIIntentionalStream&&window.UIIntentionalStream.instances){if(UIIntentionalStream.instances.nile)d=UIIntentionalStream.instances.nile;UIIntentionalStream.instances.global&&UIIntentionalStream.instances.global.unload();UIIntentionalStream.instances.friends&&UIIntentionalStream.instances.friends.unload();UIIntentionalStream.instances.blade&&UIIntentionalStream.instances.blade.unload();}d&&d.unload();return this.parent.handlePageTransition(c,b);},prefetch:function(b,a){a.prefetch=true;this.loadKey(a.sk,true);this.parent.handlePageTransition(a,a.sk);},shouldRefreshRightColumn:function(c,b){if(!c){var a=this.getEndpoint(b);return a=='/ajax/home/groups.php'||a=='/ajax/home/group.php';}else{var d=this.isFeedSwitcher(b)&&this.isFeedSwitcher(this.selectedKey);return (this.isTopLevelNode(this.loadingNode)&&!d)||this.isFriendListFilter(b);}},isFeedSwitcher:function(a){return (a=='lf')||(a=='h');},isFriendListFilter:function(a){return a.substring(0,3)=='fl_';},navigationComplete:function(){DOMScroll.scrollTo(document.documentElement,false);return this.parent.navigationComplete();},focusComposer:function(){NewHigh.showComposer(HomeSideNav.STATUS_UPDATE_APP_ID);},internalLoadNotify:function(b,a){return this._setKeyLoadIndicator(a.key||null,b==NavigationMessage.INTERNAL_LOADING_BEGIN);},_setKeyLoadIndicator:function(b,a){if(!b)return;var c=DOM.scry(this.root,'li.key-'+b);if(c.length==0)return;CSS.conditionClass(c[0],'loading',a);}};
function pagecache_log_feed_tracking(a){var c=DOM.scry(document.body,'ul.uiStream li.uiStreamStory');var b=c.map(function(d){return collect_data_attrib(d,'ft');});b=b.filter(count).map(JSON.encode);if(!b.length)return;new AsyncRequest().setMethod('POST').setURI('/ajax/feed_tracking_pagecache.php').setReadOnly(true).setData({ft:$A(b),async:a}).send();}
var HomeNavController={expandGroups:function(){CSS.addClass($('groupSideNavWrapper'),'expandedMode');CSS.hide(DOM.find($('moreGroupsLink'),'.count'));new AsyncRequest('/ajax/groups/navigation/more_link/more_link.php').setMethod('post').setReadOnly(false).send();},collapseGroups:function(){CSS.removeClass($('groupSideNavWrapper'),'expandedMode');},expandApps:function(){CSS.addClass($('bookmarks_menu'),'expandedMode');},collapseApps:function(){CSS.removeClass($('bookmarks_menu'),'expandedMode');},_lastSeenKey:null,resetGroupsAndApps:function(a){a=a||null;if(!a||!a.selected_key||a.selected_key!=this._lastSeenKey){this.collapseGroups();this.collapseApps();UIPagelet.loadFromEndpoint('GroupsNavigationPagelet','pagelet_groups_nav',a);}this._lastSeenKey=(a&&a.selected_key)?a.selected_key:null;},addSection:function(a,c,b){SideNav.getInstance().addEndpoints(a);SideNav.getInstance().updateCloseButtons(c,b);},_groupIDs:[],initGroupCounts:function(a,b){this._groupIDs=a;if(a&&a.length>0){this._refreshGroupCounts(a);Arbiter.subscribe(PresenceMessage.getArbiterMessageType('group_nav_update'),this._updateGroupCounts.bind(this));}},_refreshGroupCounts:function(a){new AsyncRequest().setURI('/ajax/groups/navigation/update_counts/update_counts.php').setData({group_ids:a,nav_group_ids:this._groupIDs}).setMethod('post').send();},_updateGroupCounts:function(event,a){this._refreshGroupCounts([a.obj.group_id]);}};
function Tabset(a,b){if(!Tabset.instances)Tabset.instances={};Tabset.instances[a]=this;onleaveRegister(function(){Tabset.instances={};});this.id=a;this.selectedId=b;}Tabset.getInstance=function(a){if(Tabset.instances&&Tabset.instances[a])return Tabset.instances[a];return null;};Tabset.prototype.getFullTabId=function(a){return this.id+'_'+a;};Tabset.prototype.selectTab=function(c,b,a){if(a&&!a())return false;if(this.selectedId){this.lastSelected=this.selectedId;CSS.removeClass(ge(this.selectedId),'Tabset_selected');}this.selectedId=c;CSS.addClass(ge(this.selectedId),'Tabset_selected');if(b)return b();return true;};Tabset.prototype.unselect=function(){if(this.selectedId)CSS.removeClass($(this.selectedId),'Tabset_selected');};Tabset.prototype.hasTabElem=function(a){return ge(this.id+'_'+a);};Tabset.prototype.getTabElem=function(a){return $(this.id+'_'+a);};
var UIIntentionalStreamMessage={SET_AUTO_INSERT:'UIIntentionalStream/setAutoInsert',UPDATE_STREAM:'UIIntentionalStreamRefresh/updateStream',REFRESH_STREAM:'UIIntentionalStreamRefresh/refreshStream',SAVE_PENDING_HIGHLIGHTS:'UIIntentionalStreamRefresh/savePendingHighlights',UPDATE_AUTOREFRESH_CONFIG:'UIIntentionalStream/updateAutoRefreshConfig',UPDATE_HTML_CONTENT:'UIIntentionalStream/updateHtmlContent',UPDATE_LAST_REFRESH_TIME:'UIIntentionalStream/updateLastRefreshTime'};
function UIIntentionalStream(i,d,g,h,b,j,k,c,f,a,e){if(!i)throw new Error('UIIntentionalStream instantiated with no root.');copy_properties(this,{id:i.id,root:i,instanceName:d,newest:g,oldest:h,firstLoadIDs:c,shouldShowHidden:false,defaultFilter:b,currentFilterKey:a,sourceType:j,streamStoryCount:k,maxUnseenStoryCount:f,lastSeenTime:e,hasPendingRefresh:false,pauseAutoInsert:false,unseenStoryCount:0,streamHeader:$('pagelet_stream_header'),error:DOM.scry(i,'div.UIIntentionalStream_Error')[0],pager:DOM.scry(i,'div.uiMorePager')[0],streamContent:DOM.find(i,'.UIIntentionalStream_Content'),requestNum:0,scrollLoadCount:1,maxScrollLoadCount:1});this.setUpStreamHeader();if(this.streamStoryCount>0)this.updateLiveFeedCount(this.streamStoryCount);onleaveRegister(this.unload.bind(this));if(!UIIntentionalStream.instances)UIIntentionalStream.instances={};UIIntentionalStream.instances[d]=this;UIIntentionalStream.instance=this;this.setupAutoInsert();this.setupSubscriptions();}UIIntentionalStream.prototype.setupSubscriptions=function(){this.subscriptions=[];this.subscriptions.push(Arbiter.subscribe('composer/publish',function(event,a){this.addContent(a,500);}.bind(this)));this.subscriptions.push(Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_STREAM,this.updateStream.bind(this)));this.subscriptions.push(Arbiter.subscribe(UIIntentionalStreamMessage.REFRESH_STREAM,this.refreshStream.bind(this)));this.subscriptions.push(Arbiter.subscribe(UIIntentionalStreamMessage.SAVE_PENDING_HIGHLIGHTS,this.clearPendingHighlights.bind(this)));};UIIntentionalStream.prototype.tearDownSubscriptions=function(){if(!this.subscriptions)return;this.subscriptions.forEach(Arbiter.unsubscribe);};UIIntentionalStream.prototype.unload=function(){this.tearDownSubscriptions();UIIntentionalStream.instance=null;UIIntentionalStream.instances[this.instanceName]=null;this.clearScrollLoader(true);window.disableScrollLoad=null;};UIIntentionalStream.getInstance=function(a){return UIIntentionalStream.instances[a];};UIIntentionalStream.prototype._getUpdateInsertType=function(){if(this.isOnNewHighlights())return UIIntentionalStream.REFRESH_COUNT;return UIIntentionalStream.REFRESH_PREPEND;};UIIntentionalStream.prototype.clearPendingHighlights=function(a){if(a!=UIIntentionalStreamMessage.SAVE_PENDING_HIGHLIGHTS)return;if(this.isOnNewHighlights())new AsyncSignal('/ajax/feed/save_view_state.php').send();};UIIntentionalStream.prototype.updateStream=function(a){if(a!=UIIntentionalStreamMessage.UPDATE_STREAM||this.hasPendingRefresh||this.isAutoRefreshPaused())return;this.loadNewer({showLoader:false,ignoreSelf:true,insertType:this._getUpdateInsertType()});};UIIntentionalStream.prototype.clearScrollLoader=function(a){if(this.currentScrollListener){this.currentScrollListener.remove();this.currentScrollListener=null;}if(a||this.scrollLoadCount>=this.maxScrollLoadCount)window.disableScrollLoad=true;};UIIntentionalStream.prototype.loadOlderPosts=function(b){var c=DOM.scry(this.root,'div.fbStreamPager.hasMorePosts')[0];if(c){if(CSS.hasClass(c,'async_saving'))return;CSS.addClass(c,'async_saving');}var a={filter:this.getCurrentFilterKey(),oldest:this.oldest,last_seen_time:this.lastSeenTime,scroll_count:this.scrollLoadCount};a=merge(a,b);UIPagelet.loadFromEndpoint('/pagelet/home/morestories.php','home_stream',a,{usePipe:true,replayable:true,append:true});};UIIntentionalStream.prototype.setScrollLoadCount=function(a){this.maxScrollLoadCount=a;};UIIntentionalStream.prototype.loadMoreOnScroll=function(b,a,c){if(window.disableScrollLoad)return;var e=function(){if(window.disableScrollLoad)return;var g={delay_load_count:a};if(this.scrollLoadCount==1)g=merge(g,{first_load_ids:this.firstLoadIDs,show_hidden:this.shouldShowHidden,query_time:c});this.loadOlderPosts(g);}.bind(this);var f=DOM.scry(this.root,'ul.uiStream li.uiStreamStory');if(!f.length)return;var d=f[f.length-b-1];if(d){this.currentScrollListener=new OnVisible(d,e,null,0,{detect_speed:this.scrollLoadCount>1});}else e();};UIIntentionalStream.prototype.updateTimeRange=function(a,b){if(!this.newest||this.newest<a)this.newest=a;if(!this.oldest||(b&&(b<this.oldest)))this.oldest=b;};UIIntentionalStream.prototype.updatePageCache=function(){if(this.getCurrentFilterKey()==UIIntentionalStream.FEED_FILTER_KEY_NEW_HIGHLIGHTS)return;this.loadNewer({bundleAsync:true,showLoader:false,ignoreReqNum:true});};UIIntentionalStream.prototype.getID=function(){return this.id;};UIIntentionalStream.prototype.showPositioned=function(a,c,b){if(c==UIIntentionalStream.REFRESH_APPEND){DOM.appendContent(this.root,a);}else if(c==UIIntentionalStream.REFRESH_PREPEND){DOM.prependContent(this.root,a);}else if(c==UIIntentionalStream.REFRESH_EXPAND)DOM.insertAfter($(b.expandStoryID),a);CSS.setStyle(a,'display','block');if(a.src)a.src=a.src;};UIIntentionalStream.prototype.getCurrentFilterKey=function(){if(this.currentFilterKey)return this.currentFilterKey;var a=this.getCurrentParams();if(a&&a.filter){this.currentFilterKey=a.filter;}else if(this.defaultFilter)this.currentFilterKey=this.defaultFilter;return this.currentFilterKey;};UIIntentionalStream.prototype.loadOlder=function(a){a=a||{};if(!this.oldest)return;var b=this.getCurrentParams();b.oldest=this.oldest;this.refresh(UIIntentionalStream.REFRESH_APPEND,b,a);return this;};UIIntentionalStream.prototype.loadNewer=function(b){if(!this.newest)return;b=b||{};var a=this.getCurrentParams();a.newest=this.newest;if(b.ignoreSelf)a.ignore_self=true;a.load_newer=true;var c=coalesce(b.insertType,UIIntentionalStream.REFRESH_PREPEND);this.refresh(c,a,b);return this;};UIIntentionalStream.prototype.getCurrentParams=function(){var a={};var b=URI.getMostRecentURI().getQueryData();if(b.sk)b.filter=b.sk;var c=this.getValidParams();if(c){c.forEach(function(d){a[d]=b[d];});}else a=b;return a;};UIIntentionalStream.prototype.setHomeFilter=function(a){this._homeFilter=a;};UIIntentionalStream.prototype.setHomeFilterLoading=function(a){if(this._homeFilter)this._homeFilter.setLoading(a);};UIIntentionalStream.prototype.refresh=function(l,b,h){Arbiter.inform(UIIntentionalStreamMessage.UPDATE_LAST_REFRESH_TIME);this.currentFilterKey=b.filter;if(b.filter==UIIntentionalStream.FEED_FILTER_KEY_DUAL_NEWS_FEED){this.currentFilterKey=this.defaultFilter;}else if(b.filter==UIIntentionalStream.FEED_FILTER_KEY_NEW_HIGHLIGHTS||b.filter===UIIntentionalStream.FEED_FILTER_KEY_NEWS_FEED)this.defaultFilter=this.currentFilterKey;h=h||{};var j=++this.requestNum;var a=coalesce(h.bundleAsync,false);var k=coalesce(h.showLoader,true);var f=this.instanceName;var e=function(m){UIIntentionalStream.getInstance(f).handleResponse(j,l,m,h);};var c=function(m){UIIntentionalStream.getInstance(f).handleError(j,l,m,h);};var d=function(m){UIIntentionalStream.getInstance(f).handleFinally(l,b.filter,m);};if(!(b.request_type=l))b.request_type='none';if(b.filter){h.show_hidden=b.show_hidden?b.show_hidden:false;}else h.show_hidden=this.shouldShowHidden;var g=true;if(b.newest)g=false;b=copy_properties(this.getCurrentParams(),b);this.hasPendingRefresh=true;var i;if(l==UIIntentionalStream.REFRESH_APPEND&&k)i=this.pager;new AsyncRequest().setURI(this.getEndpoint()).setReadOnly(true).setOption('retries',0).setMethod(this.getRefreshMethod()).setData(b).setOption('bundle',a).setReplayable(g).setHandler(e).setStatusElement(i).setErrorHandler(c).setFinallyHandler(d).send();if(l==UIIntentionalStream.REFRESH_TRANSITION){hide(this.pager);this.clearScrollLoader(true);this.oldest=this.newest=null;}if(k)this.setHomeFilterLoading(true);};UIIntentionalStream.prototype.addContent=function(a,b){this.addContentPrepend(a,b);};UIIntentionalStream.prototype.addContentPrepend=function(a,b){if(a.length){$A(a).reverse().forEach(function(h){this.addContentPrepend(h,b);}.bind(this));return;}var d;var f=Vector2.getScrollPosition().y;var c=Vector2.getElementPosition(this.streamContent).y;var g=this.scrollOnPrepend&&f>=c;if(g){var e=function(h){var i=DOM.find(h,'^li.uiStreamStory');if(!i)return;DataStore.set(i,'origHeight',i.offsetHeight);Event.listen(h,'load',function(){var j=DataStore.get(i,'origHeight');if(i.offsetHeight!=j){window.scrollBy(0,i.offsetHeight-j);DataStore.set(i,'origHeight',i.offsetHeight);}});};d=animation.insert.curry(this.streamContent,a,function(i,h){DOM.prependContent(i,h);window.scrollBy(0,h.offsetHeight);DOM.scry(h,'img').forEach(e);});}else d=animation.prependInsert.curry(this.streamContent,a);if(b){setTimeout(d,b);}else d();};UIIntentionalStream.prototype.addContentAppend=function(a){DOM.appendContent(this.streamContent,a);};UIIntentionalStream.getStoriesByAssoc=function(a){return DOM.scry(UIIntentionalStream.instance.root,'div.aid_'+a);};UIIntentionalStream.prototype.handleResponse=function(c,e,d,b){var a=d.isReplay()||b.ignoreReqNum;return this.handleResponsePayload(c,e,d.getPayload(),a,b);};UIIntentionalStream.prototype.handleResponsePayload=function(e,g,d,b,c){c=c||{};if(is_empty(d))return;if(d.streamHeader){DOM.setContent(this.streamHeader,HTML(d.streamHeader));if(this.isOnNewsFeedFilter())this.setUpStreamHeader();NewHigh.reset();}if(d.autoRefreshConfig)Arbiter.inform(UIIntentionalStreamMessage.UPDATE_AUTOREFRESH_CONFIG,d.autoRefreshConfig);this.setHomeFilterLoading(false);if(g==UIIntentionalStream.REFRESH_EXPAND){var f=DOM.find($(c.expandStoryID),'div.UIIntentionalStory_CollapsedStories');CSS.hide(f);CSS.removeClass(f,'UIIntentionalStory_CollapsedStoriesLoading');}if(this.error)hide(this.error);if(!b&&e!=this.requestNum)return;if('show_hidden' in c)this.shouldShowHidden=c.show_hidden;if('newestStoryTime' in d&&d.newestStoryTime>this.newest)this.newest=d.newestStoryTime;if('oldestStoryTime' in d&&(!this.oldest||d.oldestStoryTime<this.oldest))this.oldest=d.oldestStoryTime;if('streamStoryCount' in d)this.updateLiveFeedCount(d.streamStoryCount);if(d.html){var a=HTML(d.html).getNodes();switch(g){case UIIntentionalStream.REFRESH_COUNT:if(d.storyCount)this.updateLiveFeedCount(d.storyCount,true);break;case UIIntentionalStream.REFRESH_PREPEND:this.addContentPrepend(a);break;case UIIntentionalStream.REFRESH_APPEND:this.addContentAppend(a);this.clearScrollLoader(true);break;case UIIntentionalStream.REFRESH_TRANSITION:DOM.setContent(this.streamContent,a);DOMScroll.scrollTo(new Vector2(0,0,"document"),false);break;case UIIntentionalStream.REFRESH_EXPAND:DOM.insertAfter($(c.expandStoryID),a);break;case UIIntentionalStream.DELAYED_STREAM:if(!Quickling.isCacheHit())this.addContentAppend(a);break;}Arbiter.inform(UIIntentionalStreamMessage.UPDATE_HTML_CONTENT);}};UIIntentionalStream.prototype.updateLiveFeedCount=function(c,b){var d=(this.unseenStoryCount==0||!b);if(b){this.unseenStoryCount+=c;}else this.unseenStoryCount=c;if(this.unseenStoryCount>0&&this.liveFeedCount){var a='';if(this.unseenStoryCount>this.maxUnseenStoryCount){a=_tx("{count}+",{count:this.maxUnseenStoryCount});}else a=this.unseenStoryCount.toString();DOM.setContent(this.liveFeedCount,HTML(a));if(d)CSS.show(this.liveFeedBubble);}};UIIntentionalStream.prototype.handleError=function(c,f,d,b){if(!d.isReplay()&&c!=this.requestNum)return;this.setHomeFilterLoading(false);var a=d.getError();if(a==1357001)AsyncResponse.defaultErrorHandler(d);if(f==UIIntentionalStream.REFRESH_EXPAND){var e=DOM.find($(b.expandStoryID),'div.UIIntentionalStory_CollapsedStories');CSS.removeClass(e,'UIIntentionalStory_CollapsedStoriesLoading');}if(!b.delayLoadCount&&f!=UIIntentionalStream.REFRESH_PREPEND&&this.error)CSS.setStyle(this.error,'display','block');};UIIntentionalStream.prototype.handleFinally=function(b,a){if(b==UIIntentionalStream.REFRESH_TRANSITION){PageTransitions.transitionComplete();Arbiter.inform(NavigationMessage.NAVIGATION_COMPLETED);}this.hasPendingRefresh=false;};UIIntentionalStream.prototype.getValidParams=function(){return UIIntentionalStream.VALID_PARAMS;};UIIntentionalStream.prototype.getEndpoint=function(){return UIIntentionalStream.ENDPOINT;};UIIntentionalStream.prototype.getRefreshMethod=function(){return UIIntentionalStream.REFRESH_METHOD;};UIIntentionalStream.prototype.isOnNewHighlights=function(){var a=this.getCurrentFilterKey();return (a==UIIntentionalStream.FEED_FILTER_KEY_NEW_HIGHLIGHTS||(a==UIIntentionalStream.FEED_FILTER_KEY_DUAL_NEWS_FEED&&this.defaultFilter==UIIntentionalStream.FEED_FILTER_KEY_NEW_HIGHLIGHTS));};UIIntentionalStream.prototype.isLiveStreamBox=function(){var a=this.getCurrentFilterKey();return a&&a.indexOf(UIIntentionalStream.FEED_FILTER_KEY_LIVE_STREAM_BOX)==0;};UIIntentionalStream.prototype.isOnNewsFeedFilter=function(){var a=this.getCurrentFilterKey();return (a==UIIntentionalStream.FEED_FILTER_KEY_NEWS_FEED||a==UIIntentionalStream.FEED_FILTER_KEY_NEW_HIGHLIGHTS||a==UIIntentionalStream.FEED_FILTER_KEY_DUAL_NEWS_FEED);};UIIntentionalStream.prototype.setupAutoInsert=function(){Arbiter.subscribe(UIIntentionalStreamMessage.SET_AUTO_INSERT,UIIntentionalStream.setAutoInsert);};UIIntentionalStream.setAutoInsert=function(b,a){if(b!=UIIntentionalStreamMessage.SET_AUTO_INSERT)return;var c=UIIntentionalStream.instance;if(c)c.pauseAutoInsert=a.pause;};UIIntentionalStream.prototype.isAutoRefreshPaused=function(){if(this.isOnNewHighlights()||this.isLiveStreamBox())return false;return this.pauseAutoInsert;};UIIntentionalStream.prototype.setUpStreamHeader=function(){if(!this.streamHeader)return;this.liveFeedBubble=DOM.scry(this.streamHeader,'span.uiBubbleCount')[0];if(!this.liveFeedBubble)return;this.liveFeedCount=DOM.scry(this.liveFeedBubble,'span.number')[0];if(!this.maxUnseenStoryCount)this.maxUnseenStoryCount=UIIntentionalStream.MAX_UNSEEN_STORY_COUNT;};UIIntentionalStream.prototype.refreshStream=function(e,a){if(e!=UIIntentionalStreamMessage.REFRESH_STREAM)return;var c=this.getCurrentFilterKey();if(this.isOnNewsFeedFilter()&&a.shouldOverride)c=UIIntentionalStream.FEED_FILTER_KEY_NEW_HIGHLIGHTS;var f=(c==UIIntentionalStream.FEED_FILTER_KEY_NEW_HIGHLIGHTS);var b={filter:c};if(f)b.pending=f;var d={filter:c};this.refresh(UIIntentionalStream.REFRESH_TRANSITION,b,d);};copy_properties(UIIntentionalStream,{ANIMATION_DURATION:300,REFRESH_METHOD:'GET',REFRESH_TRANSITION:1,REFRESH_PREPEND:2,REFRESH_APPEND:3,REFRESH_COUNT:4,REFRESH_EXPAND:5,DELAYED_STREAM:6,FEED_FILTER_KEY_NEW_HIGHLIGHTS:'h',FEED_FILTER_KEY_NEWS_FEED:'lf',FEED_FILTER_KEY_DUAL_NEWS_FEED:'nf',FEED_FILTER_KEY_LIVE_STREAM_BOX:'pub',VALID_PARAMS:['filter','show_hidden'],ENDPOINT:'/ajax/intent.php',MAX_UNSEEN_STORY_COUNT:300});
function UIIntentionalStreamRefresh(a,b){copy_properties(this,{isAutoRefreshing:false,lastRefresh:new Date().getTime()});UIIntentionalStreamRefresh.instance=this;this.setAutoRefreshConfig(a);this.updateConfigHandler=Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_AUTOREFRESH_CONFIG,this.updateAutoRefreshConfig.bind(this));this.updateRefreshTimeHandler=Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_LAST_REFRESH_TIME,this.updateLastRefreshTime.bind(this));onleaveRegister(this.unload.bind(this));this.userActivity();this.uaToken=UserActivity.subscribe(this.userActivity.bind(this));this.autoRefreshInterval=setInterval(this.checkAutoPageRefresh.bind(this),this.checkAutoRefreshTimeInterval);this.enableAutoRefresh(b);Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_STREAM,LiveTimer.loop.bind(LiveTimer,true));Arbiter.subscribe(UIIntentionalStreamMessage.REFRESH_STREAM,LiveTimer.loop.bind(LiveTimer,true));if(this.usePresence)UIIntentionalStreamRefresh.presenceRegister();}copy_properties(UIIntentionalStreamRefresh,{_presenceInit:false,DISABLE_AUTOREFRESH_TIME:4*60*1000,CHECK_AUTOREFRESH_INTERVAL:5*60*1000,AUTOREFRESH_INACTIVE_TIME:30*60*1000,HIGHLIGHTS_OVERRIDE_TIME:360*60*1000});UIIntentionalStreamRefresh.presenceRegister=function(){if(UIIntentionalStreamRefresh._presenceInit)return true;Arbiter.subscribe(PresenceMessage.getArbiterMessageType('feedpub'),UIIntentionalStreamRefresh.handleNewStoryMessage);UIIntentionalStreamRefresh._presenceInit=true;};UIIntentionalStreamRefresh.prototype.updateAutoRefreshConfig=function(b,a){if(b==UIIntentionalStreamMessage.UPDATE_AUTOREFRESH_CONFIG)this.setAutoRefreshConfig(a);};UIIntentionalStreamRefresh.prototype.updateLastRefreshTime=function(a){if(a==UIIntentionalStreamMessage.UPDATE_LAST_REFRESH_TIME)this.lastRefresh=new Date().getTime();};UIIntentionalStreamRefresh.prototype.setAutoRefreshConfig=function(a){a=a||{};var b=24*60*60*1000;if(!this.storyInterval)this.storyInterval=coalesce(a.story_interval,null);this.allowAutoRefresh=coalesce(a.allow_auto_refresh,false);this.inactiveThreshold=coalesce(a.inactive_threshold,0);this.activeRefreshTime=coalesce(a.fast_refresh_rate,b);this.inactiveRefreshTime=coalesce(a.slow_refresh_rate,b);this.allowPolling=coalesce(a.allow_polling,false);this.refreshFactor=coalesce(a.refresh_factor,10);this.minRefreshInterval=coalesce(a.min_refresh_interval,60*1000);this.usePresence=coalesce(a.use_presence,false);this.disableAutoRefreshTime=coalesce(a.disable_autorefresh_time,UIIntentionalStreamRefresh.DISABLE_AUTOREFRESH_TIME);this.checkAutoRefreshTimeInterval=coalesce(a.check_autorefresh_time_interval,UIIntentionalStreamRefresh.CHECK_AUTOREFRESH_INTERVAL);this.autoRefreshInactiveTime=coalesce(a.autorefresh_inactive_time,UIIntentionalStreamRefresh.AUTOREFRESH_INACTIVE_TIME);this.highlightsOverrideTime=coalesce(a.highlights_override_time,UIIntentionalStreamRefresh.HIGHLIGHTS_OVERRIDE_TIME);return this;};UIIntentionalStreamRefresh.prototype.unload=function(){this.enableAutoRefresh(false);this.cleanupRefreshInterval();UserActivity.unsubscribe(this.uaToken);this.updateConfigHandler&&Arbiter.unsubscribe(this.updateConfigHandler);this.updateRefreshTimeHandler&&Arbiter.unsubscribe(this.updateRefreshTimeHandler);};UIIntentionalStreamRefresh.prototype.userActivity=function(){if(this.getMSSinceLastActivity()>this.autoRefreshInactiveTime)Arbiter.inform(UIIntentionalStreamMessage.SAVE_PENDING_HIGHLIGHTS);var a=this.isInactive();this.lastActivity=(new Date().getTime());this.isAutoRefreshing=true;if(a&&this.canAutoRefresh())this.runAutoRefresh();return true;};UIIntentionalStreamRefresh.prototype.isInactive=function(){return this.getMSSinceLastActivity()>this.inactiveThreshold;};UIIntentionalStreamRefresh.prototype.getMSSinceLastActivity=function(){return (new Date().getTime())-this.lastActivity;};UIIntentionalStreamRefresh.prototype.getMSSinceLastRefresh=function(){return (new Date().getTime())-this.lastRefresh;};UIIntentionalStreamRefresh.prototype.getRefreshInterval=function(){if(this.isInactive()){return this.inactiveRefreshTime;}else if(this.storyInterval!=null){var a=this.storyInterval*this.refreshFactor;return Math.max(a,this.activeRefreshTime);}else return this.activeRefreshTime;};UIIntentionalStreamRefresh.prototype.canAutoRefresh=function(){return this.isAutoRefreshing&&this.allowAutoRefresh;};UIIntentionalStreamRefresh.handleNewStoryMessage=function(b,a){if(b!=PresenceMessage.getArbiterMessageType('feedpub'))return;Arbiter.inform(UIIntentionalStreamMessage.UPDATE_STREAM);};UIIntentionalStreamRefresh.prototype.cancelUpdate=function(){if(this.updateTask){clearTimeout(this.updateTask);this.updateTask=null;}};UIIntentionalStreamRefresh.prototype.runUpdatePoll=function(){this.updateTask=null;if(this.canAutoRefresh())this.runAutoRefresh();};UIIntentionalStreamRefresh.prototype.runAutoRefresh=function(){var a=50;if(this.getMSSinceLastRefresh()>=this.minRefreshInterval-a)Arbiter.inform(UIIntentionalStreamMessage.UPDATE_STREAM);this.schedulePoll(this.getRefreshInterval());};UIIntentionalStreamRefresh.prototype.schedulePoll=function(a){this.cancelUpdate();if(this.allowPolling)this.updateTask=setTimeout(this.runUpdatePoll.bind(this),a);};UIIntentionalStreamRefresh.prototype.enableAutoRefresh=function(b,c){this.isAutoRefreshing=b;if(b){var a=c?0:this.getRefreshInterval();this.schedulePoll(a);}else this.cancelUpdate();};UIIntentionalStreamRefresh.prototype.checkAutoPageRefresh=function(){if(!this.allowAutoRefresh)return;if(this.isAutoRefreshing&&(this.getMSSinceLastActivity()>this.disableAutoRefreshTime))this.isAutoRefreshing=false;if(this.getMSSinceLastRefresh()<this.autoRefreshInactiveTime)return;var a=this.getMSSinceLastActivity();if(a>this.autoRefreshInactiveTime){var b=(a>this.highlightsOverrideTime);Arbiter.inform(UIIntentionalStreamMessage.REFRESH_STREAM,{shouldOverride:b});}};UIIntentionalStreamRefresh.prototype.cleanupRefreshInterval=function(){if(this.autoRefreshInterval){clearInterval(this.autoRefreshInterval);this.autoRefreshInterval=null;}};
function tz_calculate(f){var a=new Date();var b=a.getTimezoneOffset()/30;var e=a.getTime()/1000;var d=Math.round((f-e)/1800);var c=Math.round(b+d)%48;if(c==0){return 0;}else if(c>24){c-=Math.ceil(c/48)*48;}else if(c<-28)c+=Math.ceil(c/-48)*48;return c*30;}function tz_autoset(d,c){if(!d||undefined==c)return;if(window.tz_autoset.calculated)return;window.tz_autoset.calculated=true;var b=-tz_calculate(d);if(b!=c){var a='/ajax/autoset_timezone_ajax.php';new AsyncRequest().setURI(a).setData({gmt_off:b}).setErrorHandler(bagofholding).setTransportErrorHandler(bagofholding).setOption('suppressErrorAlerts',true).send();}}

if (window.Bootloader) { Bootloader.done(["8M9A4"]); }