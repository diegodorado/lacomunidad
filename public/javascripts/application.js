$(function() { 
  $(document).ajaxStart(function(){$('#ajax-indicator').show(); });
  $(document).ajaxStop(function(){$('#ajax-indicator').hide();});  
});

(function($){

  $.extend({
  	logEvent : function(e,t) {
      var l = $('#logger');
      var m = $('<li class="event" />');
  		$('<b>Event:</b> ').appendTo(m);
  		m.append(e.type);
  		$('  <b>Target:</b> ').appendTo(m);
  		m.append(e.target.id);
  		$('  <b>Timestamp:</b> ').appendTo(m);
  		m.append(e.timeStamp);
  		if (t){
    		$('<br/>').appendTo(m);
    		m.append(t);
  		}
  		m.prependTo(l);
      l.show();
	  },
  	log : function(t) {
      var l = $('#logger');
      $('<li class="info" />').append(t).prependTo(l);
      l.show();
	  },
  });


})(jQuery);



function parseUri (str) {
	var	parser = /\b(https?:\/\/)?(([a-z0-9][-\w]{2,}[a-z0-9]\.)+[a-z]{2,})([-\w\.\?\\/@&#;`~=%!]*)?\b/;
	var	m  = parser.exec(str);
	return (m) ? m[0] : false;
};


/*

var DOM={find:function(a,c){var b=DOM.scry(a,c);return b[0];},scry:function(j,v){if(!j)return [];var w=v.split(' ');var d=[j];var i=j===document;for(var m=0;m<w.length;m++){if(d.length==0)break;if(w[m]=='')continue;var u=w[m];var s=[];var zd=false;if(u.charAt(0)=='^')if(m==0){zd=true;u=u.slice(1);}else return;u=u.replace(/\./g,' .');u=u.replace(/\#/g,' #');u=u.replace(/\[/g,' [');var z=u.split(' ');var za=z[0]||'*';var n=z[1]&&z[1].charAt(0)=='#';if(n){var h=ge(z[1].slice(1),true);if(h&&('*'==za||h.tagName.toLowerCase()==za))for(var q=0;q<d.length;q++)if(zd&&DOM.contains(h,d[q])){s=[h];break;}else if(document==d[q]||DOM.contains(d[q],h)){s=[h];break;}}else{var zc=[];var c=d.length;for(var o=0;o<c;o++){if(zd){var k=[];var g=d[o].parentNode;var a=za=='*';while(DOM.isNode(g,DOM.NODE_TYPES.ELEMENT)){if(a||g.tagName.toLowerCase()==za)k.push(g);g=g.parentNode;}}else var k=d[o].getElementsByTagName(za);var l=k.length;for(var r=0;r<l;r++)zc.push(k[r]);}for(var x=1;x<z.length;x++){var y=z[x];var p=y.charAt(0)=='.';var e=y.substring(1);for(var o=0;o<zc.length;o++){var zb=zc[o];if(!zb)continue;if(p){if(!CSS.hasClass(zb,e))delete zc[o];continue;}else{var f=y.slice(1,y.length-1);if(f.indexOf('=')==-1){if(zb.getAttribute(f)===null){delete zc[o];continue;}}else{var t=f.split('=');var b=t[0];var ze=t[1];ze=ze.slice(1,ze.length-1);if(zb.getAttribute(b)!=ze){delete zc[o];continue;}}}}}for(var o=0;o<zc.length;o++)if(zc[o]){s.push(zc[o]);if(zd)break;}}d=s;}return d;},getText:(function(){var a=document.createElement('div'),b=a.innerText==null?'textContent':'innerText';return function(c){if(!c){return '';}else if(DOM.isNode(c,DOM.NODE_TYPES.TEXT)){return c.data;}else return c[b];};})(),getSelection:function(){var b=window.getSelection,a=document.selection;if(b){return b()+'';}else if(a)return a.createRange().text;return null;},create:function(c,a,b){c=document.createElement(c);if(a){a=copy_properties({},a);if(a.style){copy_properties(c.style,a.style);delete a.style;}for(var d in a)if(d.toLowerCase().indexOf('on')==0){if(!(typeof a[d]!='function'))if(window.Event&&Event.listen){Event.listen(c,d.substr(2),a[d]);}else c[d]=a[d];delete a[d];}copy_properties(c,a);}if(b!=undefined)DOM.setContent(c,b);return c;},prependContent:function(c,b){if(!DOM.isNode(c))throw new Error('DOM.prependContent: reference element is not a node');var a=function(d){if(c.firstChild){c.insertBefore(d,c.firstChild);}else c.appendChild(d);};return DOM._addContent(b,a,c);},insertAfter:function(c,b){if(!DOM.isNode(c)||!c.parentNode)throw new Error('DOM.insertAfter: reference element is not a node');var a=function(d){if(c.nextSibling){c.parentNode.insertBefore(d,c.nextSibling);}else c.parentNode.appendChild(d);};return DOM._addContent(b,a,c.parentNode);},insertBefore:function(b,c){if(!DOM.isNode(c)||!c.parentNode)throw new Error('DOM.insertBefore: reference element is not a node or '+'does not have a parent.');var a=function(d){c.parentNode.insertBefore(d,c);};return DOM._addContent(b,a,c.parentNode);},setContent:function(b,a){if(!DOM.isNode(b))throw new Error('DOM.setContent: reference element is not a node');DOM.empty(b);return DOM.appendContent(b,a);},appendContent:function(c,b){if(!DOM.isNode(c))throw new Error('DOM.appendContent: reference element is not a node');var a=function(d){c.appendChild(d);};return DOM._addContent(b,a,c);},replace:function(c,b){if(!DOM.isNode(c)||!c.parentNode)throw new Error('DOM.replace: reference element must be a node with a'+' parent');var a=function(d){c.parentNode.replaceChild(d,c);};return DOM._addContent(b,a,c.parentNode);},remove:function(a){a=$(a);if(a.parentNode)a.parentNode.removeChild(a);},empty:function(a){a=$(a);while(a.firstChild)DOM.remove(a.firstChild);},contains:function(b,a){b=ge(b);a=ge(a);if(!b||!a){return false;}else if(b===a){return true;}else if(DOM.isNode(b,'#text')){return false;}else if(DOM.isNode(a,'#text')){return DOM.contains(b,a.parentNode);}else if(b.contains){return b.contains(a);}else if(b.compareDocumentPosition){return !!(b.compareDocumentPosition(a)&16);}else return false;},getRootElement:function(){var a=null;if(window.Quickling&&Quickling.isActive())a=ge('content');return a||document.body;},isNode:function(d,e){if(typeof(Node)=='undefined')Node=null;try{if(!d||!((Node!=undefined&&d instanceof Node)||d.nodeName))return false;}catch(a){return false;}if(typeof(e)!=='undefined'){e=$A(e).map(function(g){return (g+'').toUpperCase();});var c,f;try{c=new String(d.nodeName).toUpperCase();f=d.nodeType;}catch(a){return false;}for(var b=0;b<e.length;b++)try{if(c==e[b]||f==e[b])return true;}catch(a){}return false;}return true;},NODE_TYPES:{ELEMENT:1,ATTRIBUTE:2,TEXT:3,CDATA_SECTION:4,ENTITY_REFERENCE:5,ENTITY:6,PROCESSING_INSTRUCTION:7,COMMENT:8,DOCUMENT:9,DOCUMENT_TYPE:10,DOCUMENT_FRAGMENT:11,NOTATION_NODE:12},_addContent:function(d,a,l){d=HTML.replaceJSONWrapper(d);if(d instanceof HTML&&-1==d.toString().indexOf('<scr'+'ipt')&&''==l.innerHTML){var g=ua.ie();if(!g||(g>7&&!DOM.isNode(l,['table','tbody','thead','tfoot','tr','select','fieldset']))){l.innerHTML=d;return $A(l.childNodes);}}else if(DOM.isNode(l,DOM.NODE_TYPES.TEXT)){l.data=d;return [d];}var i,e=[],b=[];var f=document.createDocumentFragment();if(!(d instanceof Array))d=[d];for(var h=0;h<d.length;h++){i=HTML.replaceJSONWrapper(d[h]);if(i instanceof HTML){b.push(i.getAction());var k=i.getNodes(),c;for(var j=0;j<k.length;j++){c=(ua.safari()||(ua.ie()&&i.hasOptionElements()))?k[j]:k[j].cloneNode(true);e.push(c);f.appendChild(c);}}else if(is_scalar(i)){var m=document.createTextNode(i);e.push(m);f.appendChild(m);}else if(DOM.isNode(i)){e.push(i);f.appendChild(i);}else if(!(i instanceof Array))i!==null;}a(f);for(var h=0;h<b.length;h++)b[h]();return e;}};function $N(c,a,b){if(typeof a!='object'||DOM.isNode(a)||a instanceof Array||HTML.isHTML(a)){b=a;a=null;}return DOM.create(c,a,b);}var $$=function _$$(a){return DOM.scry.apply(null,[document].concat($A(arguments)));};

onloadRegister(function(){copy_properties(AsyncRequest.prototype,{setNectarModuleData:function(c){if(this.method=='POST'){var d=Env.module;if(c&&d===undefined){var b={fbpage_fan_confirm:1};var e=null;for(var a=c;a&&a!=document.body;a=a.parentNode){if(!a.id||typeof a.id!=='string')continue;if(a.id.startsWith('pagelet_')){d=a.id;break;}if(!e&&b[a.id])e=a.id;}if(d===undefined&&e)d=e;}if(d!==undefined){if(this.data.nctr===undefined)this.data.nctr={};this.data.nctr._mod=d;}}},setNectarImpressionId:function(){if(this.method=='POST'){var a=env_get('impid');if(a!==undefined){if(this.data.nctr===undefined)this.data.nctr={};this.data.nctr._impid=a;}}}});});

*/



function html_hyperlink(g, h, i, e) {
    if (typeof g === 'undefined' || !g.toString) return '';
    if (typeof h !== 'function') h = htmlize;
    if (typeof i !== 'function') i = htmlize;
    var g = g.toString();
    var f = [];
    var b;
    while ((b = URLScraper.match(g))) {
        var d = g.indexOf(b);
        if (d >= 0) f.push(h(g.substring(0, d)));
        var a = i(b);
        var c = b.replace(/"/g, '%22');
        if (!(/^[a-z][a-z0-9\-+.]+:\/\//i.test(b))) c = 'http://' + c;
        f.push('<a target="_blank" rel="nofollow" href="' + c + '"');
        if (e) f.push(' onmousedown="UntrustedLink.bootstrap(this, \'' + Env.lhsh + '\', event)"');
        f.push('>' + a + '</a>');
        g = g.substring(d + b.length);
    }
    g && f.push(h(g));
    return f.join('');
}


function htmlspecialchars(a) {
    if (typeof(a) == 'undefined' || a === null || !a.toString) return '';
    if (a === false) {
        return '0';
    } else if (a === true) return '1';
    return a.toString().replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#039;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function htmlize(a) {
    return htmlspecialchars(a).replace(/\n/g, '<br />');
}

function escape_js_quotes(a) {
    if (typeof(a) == 'undefined' || !a.toString) return '';
    return a.toString().replace(/\\/g, '\\\\').replace(/\n/g, '\\n').replace(/\r/g, '\\r').replace(/"/g, '\\x22').replace(/'/g, '\\\'').replace(/</g, '\\x3c').replace(/>/g, '\\x3e').replace(/&/g, '\\x26');
}


function stoled_from_fb(){
  function KeyEventController(){this.handlers={};document.onkeyup=this.onkeyevent.bind(this,'onkeyup');document.onkeydown=this.onkeyevent.bind(this,'onkeydown');document.onkeypress=this.onkeyevent.bind(this,'onkeypress');}copy_properties(KeyEventController,{instance:null,getInstance:function(){return KeyEventController.instance||(KeyEventController.instance=new KeyEventController());},defaultFilter:function(event,a){event=$E(event);return KeyEventController.filterEventTypes(event,a)&&KeyEventController.filterEventTargets(event,a)&&KeyEventController.filterEventModifiers(event,a);},filterEventTypes:function(event,a){if(a==='onkeydown')return true;return false;},filterEventTargets:function(event,b){var a=$E(event).getTarget();if(DOM.isNode(a,['input','select','textarea','object','embed']))if(a.type!='checkbox'&&a.type!='radio'&&a.type!='submit')return false;return a.getAttribute('contentEditable')!='true';},filterEventModifiers:function(event,a){if(event.ctrlKey||event.altKey||event.metaKey||event.repeat)return false;return true;},registerKey:function(f,a,d,g){if(d===undefined)d=KeyEventController.defaultFilter;var b=KeyEventController.getInstance();var c=b.mapKey(f);if(is_empty(b.handlers))onleaveRegister(b.resetHandlers.bind(b));for(var e=0;e<c.length;e++){f=c[e];if(!b.handlers[f]||g)b.handlers[f]=[];b.handlers[f].push({callback:a,filter:d});}},keyCodeMap:{BACKSPACE:[8],TAB:[9],RETURN:[13],ESCAPE:[27],LEFT:[37,63234],UP:[38,63232],RIGHT:[39,63235],DOWN:[40,63233],DELETE:[46],COMMA:[188],PERIOD:[190],'`':[192],'[':[219],']':[221]}});copy_properties(KeyEventController.prototype,{mapKey:function(a){if(typeof(a)=='number')return [48+a,96+a];var b=KeyEventController.keyCodeMap[a.toUpperCase()];if(b)return b;return [a.toUpperCase().charCodeAt(0)];},onkeyevent:function(i,c){c=$E(c);var d=null;var g=this.handlers[c.keyCode];var b,f,a;if(g)for(var h=0;h<g.length;h++){b=g[h].callback;f=g[h].filter;try{if(!f||f(c,i)){var node=null;if(window.Parent&&Parent.byTag&&c.getTarget)node=Parent.byTag(c.getTarget(),'a');user_action(node,'key',c);a=b(c,i);if(a===false)return Event.kill(c);}}catch(e){}}return true;},resetHandlers:function(){this.handlers={};}});

  function URI(a){if(a===window)return;if(this===window)return new URI(a||window.location.href);this.parse(a||'');}copy_properties(URI,{getRequestURI:function(a,b){a=a===undefined||a;if(a&&window.PageTransitions&&PageTransitions.isInitialized()){return PageTransitions.getCurrentURI(!!b).getQualifiedURI();}else return new URI(window.location.href);},getMostRecentURI:function(){if(window.PageTransitions&&PageTransitions.isInitialized()){return PageTransitions.getMostRecentURI().getQualifiedURI();}else return new URI(window.location.href);},expression:/(((\w+):\/\/)([^\/:]*)(:(\d+))?)?([^#?]*)(\?([^#]*))?(#(.*))?/,arrayQueryExpression:/^(\w+)((?:\[\w*\])+)=?(.*)/,explodeQuery:function(g){if(!g)return {};var h={};g=g.replace(/%5B/ig,'[').replace(/%5D/ig,']');g=g.split('&');for(var b=0,d=g.length;b<d;b++){var e=g[b].match(URI.arrayQueryExpression);if(!e){var j=g[b].split('=');h[URI.decodeComponent(j[0])]=j[1]===undefined?null:URI.decodeComponent(j[1]);}else{var c=e[2].split(/\]\[|\[|\]/).slice(0,-1);var f=e[1];var k=URI.decodeComponent(e[3]||'');c[0]=f;var i=h;for(var a=0;a<c.length-1;a++)if(c[a]){if(i[c[a]]===undefined)if(c[a+1]&&!c[a+1].match(/\d+$/)){i[c[a]]={};}else i[c[a]]=[];i=i[c[a]];}else{if(c[a+1]&&!c[a+1].match(/\d+$/)){i.push({});}else i.push([]);i=i[i.length-1];}if(i instanceof Array&&c[c.length-1]==''){i.push(k);}else i[c[c.length-1]]=k;}}return h;},implodeQuery:function(f,e,a){e=e||'';if(a===undefined)a=true;var g=[];if(f===null||f===undefined){g.push(a?URI.encodeComponent(e):e);}else if(f instanceof Array){for(var c=0;c<f.length;++c)try{if(f[c]!==undefined)g.push(URI.implodeQuery(f[c],e?(e+'['+c+']'):c));}catch(b){}}else if(typeof(f)=='object'){if(DOM.isNode(f)){g.push('{node}');}else for(var d in f)try{if(f[d]!==undefined)g.push(URI.implodeQuery(f[d],e?(e+'['+d+']'):d));}catch(b){}}else if(a){g.push(URI.encodeComponent(e)+'='+URI.encodeComponent(f));}else g.push(e+'='+f);return g.join('&');},encodeComponent:function(d){var c=String(d).split(/([\[\]])/);for(var a=0,b=c.length;a<b;a+=2)c[a]=window.encodeURIComponent(c[a]);return c.join('');},decodeComponent:function(a){return window.decodeURIComponent(a.replace(/\+/g,' '));}});copy_properties(URI.prototype,{parse:function(b){var a=b.toString().match(URI.expression);copy_properties(this,{protocol:a[3]||'',domain:a[4]||'',port:a[6]||'',path:a[7]||'',query_s:a[9]||'',fragment:a[11]||''});return this;},setProtocol:function(a){this.protocol=a;return this;},getProtocol:function(){return this.protocol;},setQueryData:function(a){this.query_s=URI.implodeQuery(a);return this;},addQueryData:function(a){return this.setQueryData(copy_properties(this.getQueryData(),a));},removeQueryData:function(b){if(!(b instanceof Array))b=[b];var d=this.getQueryData();for(var a=0,c=b.length;a<c;++a)delete d[b[a]];return this.setQueryData(d);},getQueryData:function(){return URI.explodeQuery(this.query_s);},setFragment:function(a){this.fragment=a;return this;},getFragment:function(){return this.fragment;},setDomain:function(a){this.domain=a;return this;},getDomain:function(){return this.domain;},setPort:function(a){this.port=a;return this;},getPort:function(){return this.port;},setPath:function(a){this.path=a;return this;},getPath:function(){return this.path.replace(/^\/+/,'/');},toString:function(){var a='';this.protocol&&(a+=this.protocol+'://');this.domain&&(a+=this.domain);this.port&&(a+=':'+this.port);if(this.domain&&!this.path)a+='/';this.path&&(a+=this.path);this.query_s&&(a+='?'+this.query_s);this.fragment&&(a+='#'+this.fragment);return a;},valueOf:function(){return this.toString();},isFacebookURI:function(){if(!URI._facebookURIRegex)URI._facebookURIRegex=new RegExp('(^|\.)facebook\.('+env_get('tlds').join('|')+')([^.]*)$','i');return (!this.domain||URI._facebookURIRegex.test(this.domain));},isQuicklingEnabled:function(){return window.Quickling&&Quickling.isActive()&&Quickling.isPageActive(this);},getRegisteredDomain:function(){if(!this.domain)return '';if(!this.isFacebookURI())return null;var b=this.domain.split('.');var a=b.indexOf('facebook');return b.slice(a).join('.');},getTld:function(f){if(!this.domain)return '';var d=this.domain.split('.');var e=d[d.length-1];if(f)return e;var c=env_get('tlds');if(c.indexOf(e)==-1)for(var a=0;a<c.length;++a){var b=c[a];if(new RegExp(b+'$').test(this.domain)){e=b;break;}}return e;},getUnqualifiedURI:function(){return new URI(this).setProtocol(null).setDomain(null).setPort(null);},getQualifiedURI:function(){var b=new URI(this);if(!b.getDomain()){var a=URI();b.setProtocol(a.getProtocol()).setDomain(a.getDomain()).setPort(a.getPort());}return b;},isSameOrigin:function(a){var b=a||window.location.href;if(!(b instanceof URI))b=new URI(b.toString());if(this.getProtocol()&&this.getProtocol()!=b.getProtocol())return false;if(this.getDomain()&&this.getDomain()!=b.getDomain())return false;return true;},go:function(a){goURI(this,a);},setSubdomain:function(b){var c=new URI(this).getQualifiedURI();var a=c.getDomain().split('.');if(a.length<=2){a.unshift(b);}else a[0]=b;return c.setDomain(a.join('.'));},getSubdomain:function(){if(!this.getDomain())return '';var a=this.getDomain().split('.');if(a.length<=2){return '';}else return a[0];},setSecure:function(a){return this.setProtocol(a?'https':'http');},isSecure:function(){return this.getProtocol()=='https';}});

  function HTML(a){if(a&&a.__html)a=a.__html;if(this===window){if(a instanceof HTML)return a;return new HTML(a);}this._content=a;this._defer=false;this._extra_action='';this._nodes=null;this._inline_js=bagofholding;this._has_option_elements=false;return this;}HTML.isHTML=function(a){return a&&(a instanceof HTML||a.__html!==undefined);};HTML.replaceJSONWrapper=function(a){return a&&a.__html!==undefined?new HTML(a.__html):a;};copy_properties(HTML.prototype,{toString:function(){var a=this._content||'';if(this._extra_action)a+='<script type="text/javascript">'+this._extra_action+'</scr'+'ipt>';return a;},setAction:function(a){this._extra_action=a;return this;},getAction:function(){this._fillCache();var a=function(){this._inline_js();eval_global(this._extra_action);}.bind(this);if(this.getDeferred()){return a.defer.bind(a);}else return a;},setDeferred:function(a){this._defer=!!a;return this;},getDeferred:function(){return this._defer;},getContent:function(){return this._content;},getNodes:function(){this._fillCache();return this._nodes;},getRootNode:function(){return this.getNodes()[0];},hasOptionElements:function(){this._fillCache();return this._has_option_elements;},_fillCache:function(){if(null!==this._nodes)return;var d=this._content;if(!d){this._nodes=[];return;}d=d.replace(/(<(\w+)[^>]*?)\/>/g,function(l,m,n){return n.match(/^(abbr|br|col|img|input|link|meta|param|hr|area|embed)$/i)?l:m+'></'+n+'>';});var h=d.trim().toLowerCase(),k=document.createElement('div'),b=false;var j=(!h.indexOf('<opt')&&[1,'<select multiple="multiple" class="__WRAPPER">','</select>'])||(!h.indexOf('<leg')&&[1,'<fieldset class="__WRAPPER">','</fieldset>'])||(h.match(/^<(thead|tbody|tfoot|colg|cap)/)&&[1,'<table class="__WRAPPER">','</table>'])||(!h.indexOf('<tr')&&[2,'<table><tbody class="__WRAPPER">','</tbody></table>'])||((!h.indexOf('<td')||!h.indexOf('<th'))&&[3,'<table><tbody><tr class="__WRAPPER">','</tr></tbody></table>'])||(!h.indexOf('<col')&&[2,'<table><tbody></tbody><colgroup class="__WRAPPER">','</colgroup></table>'])||null;if(null===j){k.className='__WRAPPER';if(ua.ie()){j=[0,'<span style="display:none">&nbsp;</span>',''];b=true;}else j=[0,'',''];}k.innerHTML=j[1]+d+j[2];while(j[0]--)k=k.lastChild;if(b)k.removeChild(k.firstChild);k.className!='__WRAPPER';if(0!=k.getElementsByTagName('option').length)this._has_option_elements=true;if(ua.ie()){var i;if(!h.indexOf('<table')&&-1==h.indexOf('<tbody')){i=k.firstChild&&k.firstChild.childNodes;}else if(j[1]=='<table>'&&-1==h.indexOf('<tbody')){i=k.childNodes;}else i=[];for(var f=i.length-1;f>=0;--f)if(i[f].nodeName&&i[f].nodeName.toLowerCase()=='tbody'&&i[f].childNodes.length==0)i[f].parentNode.removeChild(i[f]);}var g=k.getElementsByTagName('script');var a=[];for(var e=0;e<g.length;e++)if(g[e].src){a.push(Bootloader.requestResource.bind(Bootloader,'js',g[e].src));}else a.push(eval_global.bind(null,g[e].innerHTML));for(var e=g.length-1;e>=0;e--)g[e].parentNode.removeChild(g[e]);var c=function(){for(var l=0;l<a.length;l++)a[l]();};this._nodes=$A(k.childNodes);this._inline_js=c;}});

  function URLScraper(a){this.input=a;this.enable();}URLScraper.mixin('Arbiter',{reset:function(){this.lastMatch=null;},enable:function(){if(this.events)return;var a=function(b){setTimeout(this.check.bind(this,b),30);};this.events=Event.listen(this.input,{paste:a.bind(this,false),keydown:a.bind(this,true)});},disable:function(){if(!this.events)return;for(var event in this.events)this.events[event].remove();this.events=null;},check:function(b){var c=this.input.value;if(b&&URLScraper.trigger(c))return;var a=URLScraper.match(c);if(a&&a!=this.lastMatch){this.lastMatch=a;this.inform('match',{url:a});}}});(function(){var c='[a-z][a-z0-9\\-+.]+://',h='www\\d{0,3}[.]',b='[a-z0-9.\\-]+[.][a-z]{2,4}\\/',a='\\([^\\s()<>]+\\)',f='[^\\s()<>]+',e='[^\\s`!()\\[\\]{};:\'".,<>?]';var d=new RegExp('\\b('+'(?:'+c+'|'+h+'|'+b+')'+'(?:'+a+'|'+f+')*'+'(?:'+a+'|'+e+')'+')','im');var g=/[\s'"!;,)]/;URLScraper.match=function(i){return (d.exec(i)||[])[1]||null;};URLScraper.trigger=function(i){return !g.test(i.charAt(i.length-1));};})();


  function UrlDetector(a){this.element=a;this.lastCharCount=0;this.lastScrapedURL=null;this.detectionInterval=null;this.suppressDetection=bagofholding;Event.listen(a,'focus',this.startDetectionInterval.bind(this));Event.listen(a,'blur',this.stopDetectionInterval.bind(this));var b=DOM.isNode(this.element,['input','textarea']);copy_properties(this,{getText:b?function(){return this.element.value;}:function(){return DOM.getText(this.element);},setText:b?function(c){this.element.value=c;}:function(c){DOM.setContent(this.element,c);}});}UrlDetector.mixin('Arbiter',{getText:bagofholding,setText:bagofholding,setSuppressDetectionCheck:function(a){this.suppressDetection=a;},startDetectionInterval:function(){if(this.detectionInterval||this.suppressDetection())return;this.detectionInterval=setInterval(this.detectionIntervalFire.bind(this),250);},stopDetectionInterval:function(){this.detectionInterval=clearInterval(this.detectionInterval);},detectionIntervalFire:function(){if(this.suppressDetection())return;var a=this.getText().length;if((a-this.lastCharCount)>5||(this.lastCharCount==0&&a>1))var b=true;this.lastCharCount=a;var c=this.detectUrl(b);if(c)this.inform('urlDetected',c);},detectUrl:function(d){var g='',f=this.getText(),e=-1,a=-1;if(d){g=f.match(/(?:^|[^a-z])(www\.\S+)/mi);if(g){e=f.indexOf(g[1]);a=e+g[1].length;g="http://"+g[1];}else{var c=f.match(/(http|fb):\/\/\S*/i);if(c){g=c[0];e=f.indexOf(c[0]);a=e+c[0].length;}}}else{g=f.match(/(?:^|[^a-z])(www\.\S+[\s|\)|\!])/mi);if(g){e=f.indexOf(g[1]);a=e+g[1].length;g="http://"+g[1];}else{var c=f.match(/(http|fb):\/\/\S*[\s|\)|\!]/i);if(c){g=c[0];e=f.indexOf(c[0]);a=e+c[0].length;}}}if(g){g=g.replace(/[\s|\)]/g,'');while(true){var b=g.charAt(g.length-1);if(!b.match(/[,|.|\!]/))break;g=g.substr(0,g.length-1);}if(g!=this.lastScrapedURL){this.lastScrapedURL=g;if(g.search('fb:')==0)this.setText(f.substr(0,e)+f.substr(a));}else g='';}return g;}});

  function StreamProfileComposer(){}StreamProfileComposer.prototype={init:function(a){var b=$(a);Arbiter.subscribe('composer/publish',function(event,c){animation.prependInsert(b,c);});}};
  function Toggler(){this.init();}(function(){var d=[];var b;function c(){c=bagofholding;Event.listen(document.documentElement,'click',function(event){var e=event.getTarget();d.each(function(f){f.active&&!f.sticky&&!DOM.contains(f.getActive(),e)&&f.hide();});},Event.Priority.URGENT);}function a(f,e){if(f instanceof Toggler)return f;return Toggler.getInstance(e);}Toggler.mixin('Arbiter',{init:function(){this.active=null;this.togglers={};this.setSticky(false);d.push(this);this.subscribe(['show','hide'],Toggler.inform.bind(Toggler));c();},show:function(f){var e=a(this,f);var g=e.active;if(f!==g){g&&e.hide();e.active=f;CSS.addClass(f,'openToggler');DOM.appendContent(f,e.getToggler('next'));DOM.prependContent(f,e.getToggler('prev'));e.inform('show',e);}},hide:function(g){var f=a(this,g);var e=f.active;if(e&&(!g||g===e)){CSS.removeClass(e,'openToggler');values(f.togglers).each(DOM.remove);f.inform('hide',f);f.active=null;}},toggle:function(f){var e=a(this,f);if(e.active===f){e.hide();}else e.show(f);},getActive:function(){return a(this).active;},getToggler:function(f){var e=a(this);if(!e.togglers[f])e.togglers[f]=$N('button',{className:'hideToggler',onfocus:function(){var g=DOM.scry(e.active,'[rel="toggle"]')[0];g&&g.focus();e.hide();}});return this.togglers[f];},setSticky:function(f){var e=a(this);f=f!==false;if(f!==e.sticky){e.sticky=f;if(f){e._pt&&Arbiter.unsubscribe(e._pt);}else e._pt=Arbiter.subscribe('page_transition',e.hide.bind(e,null));}return e;}});copy_properties(Toggler,Toggler.prototype);copy_properties(Toggler,{bootstrap:function(e){var f=e.parentNode;Toggler.getInstance(f).toggle(f);},createInstance:function(f){var e=new Toggler().setSticky(true);DataStore.set(f,'toggler',e);return e;},getInstance:function(f){while(f){var e=DataStore.get(f,'toggler');if(e)return e;f=f.parentNode;}return (b=b||new Toggler());},listen:function(g,f,e){return Toggler.subscribe($A(g),function(i,h){if(h.getActive()===f)return e(i,h);});},subscribe:(function(e){return function(g,f){g=$A(g);if(g.contains('show'))d.each(function(h){if(h.getActive())f.curry('show',h).defer();});return e(g,f);};})(Toggler.subscribe.bind(Toggler))});})();
  function Composer(){}(function(){var b=1,a=2;var f={};var e=function(){var j=DOM.scry(this.root,'span.linkAttachment')[0];if(!j)return;var i=Parent.byTag(j,'form');this.scraper=new URLScraper(this.input);this.scraper.subscribe('match',function(k,l){i.action='/ajax/composer/attachment/link/scraper.php?scrape_url='+encodeURIComponent(l.url);i.xhpc.value=j.id;i.xhpc.click();}.bind(this));};var g=function(event,i){i=i||{};i.evt=event;i.flowID=this.flowID;i.context=this.form.xhpc_context.value;i.target=this.form.action.split('/').pop();i={data:JSON.encode(i)};new AsyncSignal('/ajax/composer/logging.php',i).send();};var d=function(i){this.flowID=new Date().getTime().toString()+(rand32()+1);this._logged_short=this._logged_long=false;if(i)return;Event.listen(this.input,'keypress',function(){var j=Input.getValue(this.input).length;if(!this._logged_short&&j>=2){g.call(this,'typing',{extra:'short'});this._logged_short=true;return;}if(!this._logged_long&&j>=15){g.call(this,'typing',{extra:'long'});this._logged_long=true;}}.bind(this));};var c=function(i){if(this.inform('submit')===false){i.kill();return false;}g.call(this,'publish');if(this.submitHandler)return (new Function(this.submitHandler)).apply(this.form);};var h=function(){var i=this.privacyCallout;if(!i)return;if(this.privacy.offsetWidth){i.setDestroyOnHide(true);i.show();}else{i.setDestroyOnHide(false);i.hide();}};Composer.mixin('Arbiter',{init:function(k,i,j){f[k.id]=this;this.root=k;this.resetCfg=j;this.focus=DOM.find(k,'div.focus_target');this.form=DOM.find(k,'form.attachmentForm');this.content=DOM.find(k,'div.attachmentContent');this.blurb=DOM.find(k,'div.uiComposerMessageBox div.textBlurb');this.input=DOM.find(k,'div.uiComposerMessageBox textarea.input');this.button=DOM.find(k,'div.uiComposerMessageBox label.submitBtn');this.privacy=DOM.find(k,'div.uiComposerMessageBox li.privacyWidget');if(i){i.subscribe('init',function(){var l=i.getTypeahead().getView();l.subscribe(['reset','render'],function(m){CSS.conditionClass(k,'uiComposerMention',(m=='render'));});});this.mentionsInput=i;}Event.listen(this.form,'submit',c.bind(this));e.call(this);d.call(this);Arbiter.inform('xhpc/init/'+k.id,this,Arbiter.BEHAVIOR_STATE);},initPrivacyEducation:function(k,p,i,j){if(i){this.privacyCallout=i;if(!CSS.hasClass(this.focus,'child_was_focused'))var n=Event.listen(this.input,'focus',function(){n.remove();h.call(this);}.bind(this));var o=p.subscribe('menuActivated',function(){p.unsubscribe(o);Button.getInputElement(j).click();});i.subscribe('submit',function(){this.privacyCallout=null;}.bind(this));h.call(this);}if(k.warnChange)var l=p.subscribe('privacyChanged',function(r,q){p.unsubscribe(l);Bootloader.loadComponents('dialog',function(){Dialog.bootstrap('/ajax/privacy/change_default_dialog.php',{privacy_data:q,autosave:true});});});if(k.warnEveryone)var m=this.subscribe('submit',function(){if(p.isEveryonePrivacy()){var q='/ajax/privacy/confirm_everyone_dialog.php';Bootloader.loadComponents(['async','dialog'],function(){new Dialog().setAsync(new AsyncRequest(q)).setHandler(function(){this.unsubscribe(m);new AsyncRequest('/ajax/privacy/save_composer_data.php').setData({seen_everyone:true}).send();Button.getInputElement(this.button).click();}.bind(this)).show();}.bind(this));return false;}}.bind(this));},setBlurb:function(i){DOM.setContent(this.blurb,i);},setEnabled:function(i){Button.setEnabled(this.button,i);},setLoading:function(i){CSS.conditionClass(this.root,'async_saving',!!i);},setContentVisible:function(i){CSS.conditionClass(this.root,'uiComposerHideContent',!i);},setMessageBoxVisible:function(i){CSS.conditionClass(this.root,'uiComposerHideMessageBox',!i);},setInputVisible:function(i){CSS.conditionClass(this.root,'uiComposerHideInput',!i);},reset:function(){Input.reset(this.input);this.mentionsInput&&this.mentionsInput.reset();if(this.resetCfg){this.mutate(this.resetCfg);}else{var i=DOM.scry(this.root,'.uiComposerAttachmentSelected')[0];if(i)CSS.removeClass(i,'uiComposerAttachmentSelected');}CSS.removeClass(this.root,'uiComposerInteracted');CSS.setClass(this.focus,'focus_target');this.setLoading(false);d.call(this,true);},mutate:function(j){CSS.addClass(this.root,'uiComposerOpen');CSS.addClass(this.root,'uiComposerInteracted');var i=ge(j.xhpc);if(i){var k=DOM.scry(this.root,'.uiComposerAttachmentSelected')[0];if(k)CSS.removeClass(k,'uiComposerAttachmentSelected');CSS.addClass(i,'uiComposerAttachmentSelected');if(!j.disableCache)Event.listen(i,'click',function(l){$E(l).stop();this.mutate(j);}.bind(this));}if(j.content){DOM.setContent(this.content,HTML(j.content));this.setContentVisible(true);}else{this.setContentVisible(false);DOM.empty(this.content);}this.setMessageBoxVisible(!j.messageBoxHidden);this.setInputVisible(!j.inputHidden);CSS.conditionShow(this.privacy,!j.privacyWidgetHidden);Input.setPlaceholder(this.input,j.placeholder);Button.setLabel(this.button,j.buttonLabel);this.setBlurb(HTML(j.blurb));CSS.conditionClass(DOM.scry(this.form,'.uiComposerMessageBox')[0],'uiCheckinComposer',j.placeVisible);if(j.autoscrape){this.scraper&&this.scraper.enable();}else this.scraper&&this.scraper.disable();this.setEnabled(!j.disabled);this.form.setAttribute('action',j.endpoint);if(j.formType==b){this.form.setAttribute('rel','async');}else this.form.removeAttribute('rel');if(j.formType==a){this.form.target=j.iframeName;this.form.enctype=this.form.encoding='multipart/form-data';}else{this.form.removeAttribute('target');this.form.removeAttribute('enctype');this.form.removeAttribute('encoding');}this.submitHandler=j.submitHandler;h.call(this);if(j.messageBoxFocused)this.input.focus();}});copy_properties(Composer,{publish:function(j,i){Composer.getInstance($(j)).reset();Arbiter.inform('composer/publish',HTML(i).getRootNode());},getInstance:function(i){var j=Parent.byClass($(i),'uiComposer');return j?f[j.id]:null;}});})();

}



